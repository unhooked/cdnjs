/*! asynquence
    v0.3.0-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e,t){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e[n]=t(n,e)}("ASQ",this,function(n,e){"use strict";function t(n){return"undefined"!=typeof setImmediate?setImmediate(n):setTimeout(n,0)}function r(){function n(){clearTimeout(j),j=null,T.length=0,I.length=0,Q.length=0,w.length=0}function e(){return O?r():(j||(j=t(r)),void 0)}function r(){var t,r;if(j=null,O)n();else if(x)for(;I.length;){t=I.shift();try{t.apply(m,w)}catch(u){a(u)?w=w.concat(u):(w.push(u),u.stack&&w.push(u.stack)),0===I.length&&console.error.apply(console,w)}}else if(S&&T.length>0){S=!1,t=T.shift(),r=Q.slice(),Q.length=0,r.unshift(l());try{t.apply(m,r)}catch(u){a(u)?w=w.concat(u):w.push(u),x=!0,e()}}}function l(){function n(){x||O||S||(S=!0,Q.push.apply(Q,arguments),w.length=0,e())}return n.fail=function(){x||O||S||(x=!0,Q.length=0,w.push.apply(w,arguments),e())},n.abort=function(){x||O||(S=!1,O=!0,Q.length=0,w.length=0,e())},n}function p(n,e,r){function u(){clearTimeout(y),y=_=q=h=null}function l(){return v?c():(y||(y=t(c)),void 0)}function c(){if(!(x||O||b)){var e=[];y=null,d?(n.fail.apply(m,h),u()):v?(n.abort(),u()):i()&&(b=!0,_.forEach(function(n,t){e.push(q["s"+t])}),n.apply(m,e),u())}}function i(){if(!(x||O||d||v||b||0===_.length)){var n=!0;return _.some(function(e){return null===e?(n=!1,!0):void 0}),n}}function o(){function n(){if(!(x||O||d||v||b||_[e])){var n=f.messages.apply(m,arguments);q["s"+e]=n.length>1?n:n[0],_[e]=!0,l()}}var e=_.length;return n.fail=function(){x||O||d||v||b||_[e]||(d=!0,h=g.call(arguments),l())},n.abort=function(){x||O||d||v||b||(v=!0,c())},_[e]=null,n}var s,p,h,y,d=!1,v=!1,b=!1,_=[],q={};e.some(function(n){if(d||v)return!0;s=r.slice(),s.unshift(o());try{n.apply(m,s)}catch(e){return p=e,d=!0,!0}}),p&&(a(p)?n.fail.apply(m,p):n.fail(p))}function h(){return x||O||0===arguments.length?C:(T.push.apply(T,o(arguments,i)),e(),C)}function y(){return O||0===arguments.length?C:(I.push.apply(I,arguments),e(),C)}function d(){if(x||O||0===arguments.length)return C;var n=g.call(arguments);return h(function(e){var t=g.call(arguments,1);p(e,n,t)}),C}function v(){return O||0===arguments.length?C:(g.call(arguments).forEach(function(n){h(function(e){n.apply(m,g.call(arguments,1)),e()}).or(n.fail)}),C)}function b(){return x||O||0===arguments.length?C:(g.call(arguments).forEach(function(n){h(function(e){a(n)||(n=n.apply(m,g.call(arguments,1))),n.pipe(e)})}),C)}function _(){return x||O||0===arguments.length?C:(g.call(o(arguments,c)).forEach(function(n){h(function(e){var t=n.apply(m,g.call(arguments,1));a(t)||(t=f.messages(t)),e.apply(m,t)})}),C)}function q(){return x||O||0===arguments.length?C:(g.call(arguments).forEach(function(n){h(function(e){"function"!=typeof n||"then"in n||(n=n.apply(m,g.call(arguments,1))),n.then(e,e.fail)})}),C)}function k(){return x?C:(O=!0,r(),C)}function E(n,e){var t=arguments.length>1;switch(n){case"seq_error":if(!t)return x;x=e;break;case"seq_aborted":if(!t)return O;O=e;break;case"then_ready":if(!t)return S;S=e;break;case"then_queue":return T;case"or_queue":return I;case"sequence_messages":return Q;case"sequence_errors":return w}}function A(){Object.keys(s).forEach(function(n){C[n]=s[n](C,E)})}var j,x=!1,O=!1,S=!0,T=[],I=[],Q=[],w=[],C=u({then:h,or:y,gate:d,pipe:v,seq:b,val:_,promise:q,abort:k});return A(),C.then.apply(m,o(arguments,i)),C}function u(n){return Object.defineProperty(n,h,{enumerable:!1,value:!0}),n}function a(n){return null!=n&&"object"==typeof n&&n[h]}function l(n,e){return g.call(e).slice(1,n+1)}function c(n){return f.messages.apply(m,l(n,arguments))}function i(n){arguments[n+1].apply(m,l(n,arguments))}function o(n,e){var t,r;for(n=g.call(n),t=0;t<n.length;t++)if(Array.isArray(n[t])&&a(n[t]))n[t]=e.bind.apply(e,[null,n[t].length].concat(n[t]));else if("function"!=typeof n[t]){for(r=t+1;r<n.length&&("function"!=typeof n[r]&&!a(n[r]));r++);n.splice(t,r-t,e.bind.apply(e,[null,r-t].concat(n.slice(t,r))))}return n}var f,s={},p=(e||{})[n],g=Array.prototype.slice,h="__ASQ__",m=Object.create(null);return f=r,f.extend=function(n,e){return~["then","or","gate","pipe","seq","val","abort"].indexOf(n)||(s[n]=e),f},f.messages=function(){var n=g.call(arguments);return u(n),n},f.isMessageWrapper=f.isSequence=a,f.noConflict=function(){return e&&(e[n]=p),f},f});
