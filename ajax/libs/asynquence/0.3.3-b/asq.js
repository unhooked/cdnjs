/*! asynquence
    v0.3.3-b (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e,t){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e[n]=t(n,e)}("ASQ",this,function(n,e){"use strict";function t(n){return"undefined"!=typeof setImmediate?setImmediate(n):setTimeout(n,0)}function r(){function n(){clearTimeout(O),O=null,Q.length=0,w.length=0,C.length=0,M.length=0}function e(){return T?l():(O||(O=t(l)),void 0)}function l(){var t,r;if(O=null,T)n();else if(S)for(;w.length;){t=w.shift();try{t.apply(h,M)}catch(u){a(u)?M=M.concat(u):(M.push(u),u.stack&&M.push(u.stack)),0===w.length&&console.error.apply(console,M)}}else if(I&&Q.length>0){I=!1,t=Q.shift(),r=C.slice(),C.length=0,r.unshift(p());try{t.apply(h,r)}catch(u){a(u)?M=M.concat(u):M.push(u),S=!0,e()}}}function p(){function n(){S||T||I||(I=!0,C.push.apply(C,arguments),M.length=0,e())}return n.fail=function(){S||T||I||(S=!0,C.length=0,M.push.apply(M,arguments),e())},n.abort=function(){S||T||(I=!1,T=!0,C.length=0,M.length=0,e())},n.errfcb=function(e){e?n.fail(e):n.apply(h,g.call(arguments,1))},n}function m(n,e,r){function u(){clearTimeout(y),y=_=q=m=null}function l(){return d?i():(y||(y=t(i)),void 0)}function i(){if(!(S||T||b)){var e=[];y=null,v?(n.fail.apply(h,m),u()):d?(n.abort(),u()):c()&&(b=!0,_.forEach(function(n,t){e.push(q["s"+t])}),n.apply(h,e),u())}}function c(){if(!(S||T||v||d||b||0===_.length)){var n=!0;return _.some(function(e){return null===e?(n=!1,!0):void 0}),n}}function f(){function n(){if(!(S||T||v||d||b||_[e])){var n=o.messages.apply(h,arguments);q["s"+e]=n.length>1?n:n[0],_[e]=!0,l()}}var e=_.length;return n.fail=function(){S||T||v||d||b||_[e]||(v=!0,m=g.call(arguments),l())},n.abort=function(){S||T||v||d||b||(d=!0,i())},n.errfcb=function(e){e?n.fail(e):n.apply(h,g.call(arguments,1))},_[e]=null,n}var s,p,m,y,v=!1,d=!1,b=!1,_=[],q={};e.some(function(n){if(v||d)return!0;s=r.slice(),s.unshift(f());try{n.apply(h,s)}catch(e){return p=e,v=!0,!0}}),p&&(a(p)?n.fail.apply(h,p):n.fail(p))}function y(){return S||T||0===arguments.length?P:(Q.push.apply(Q,f(arguments,c)),e(),P)}function v(){return T||0===arguments.length?P:(w.push.apply(w,arguments),e(),P)}function d(){if(S||T||0===arguments.length)return P;var n=g.call(arguments);return y(function(e){var t=g.call(arguments,1);m(e,n,t)}),P}function b(){return T||0===arguments.length?P:(g.call(arguments).forEach(function(n){y(function(e){n.apply(h,g.call(arguments,1)),e()}).or(n.fail)}),P)}function _(){return S||T||0===arguments.length?P:(g.call(arguments).forEach(function(n){var e;a(n)&&"next"in n&&(n.then(function(){e.apply(h,arguments)}).or(function(){e.fail.apply(h,arguments)}),n=r(function(n){e=n}),e=function(){n=r.apply(h,arguments)},e.fail=function(){var e=g.call(arguments);n=r(function(n){n.fail.apply(h,e)})}),y(function(e){a(n)||(n=n.apply(h,g.call(arguments,1))),n.pipe(e)})}),P)}function q(){return S||T||0===arguments.length?P:(g.call(f(arguments,i)).forEach(function(n){y(function(e){var t=n.apply(h,g.call(arguments,1));a(t)||(t=o.messages(t)),e.apply(h,t)})}),P)}function A(){return S||T||0===arguments.length?P:(g.call(arguments).forEach(function(n){y(function(e){"function"!=typeof n||"then"in n||(n=n.apply(h,g.call(arguments,1))),n.then(e,e.fail)})}),P)}function k(){var n;return q(function(){return n?n.apply(h,arguments):n=r.apply(h,arguments),o.messages.apply(h,arguments)}),v(function(){if(n)n.fail.apply(h,arguments);else{var e=g.call(arguments);n=r().then(function(n){n.fail.apply(h,e)})}}),r().then(function(e){n?n.pipe(e):n=e})}function E(){return S?P:(T=!0,l(),P)}function x(n,e){var t=arguments.length>1;switch(n){case"seq_error":if(!t)return S;S=e;break;case"seq_aborted":if(!t)return T;T=e;break;case"then_ready":if(!t)return I;I=e;break;case"then_queue":return Q;case"or_queue":return w;case"sequence_messages":return C;case"sequence_errors":return M}}function j(){Object.keys(s).forEach(function(n){P[n]=s[n](P,x)})}var O,S=!1,T=!1,I=!0,Q=[],w=[],C=[],M=[],P=u({then:y,or:v,gate:d,pipe:b,seq:_,val:q,promise:A,fork:k,abort:E});return j(),P.then.apply(h,f(arguments,c)),P}function u(n){return Object.defineProperty(n,m,{enumerable:!1,value:!0}),n}function a(n){return null!=n&&"object"==typeof n&&n[m]}function l(n,e){return g.call(e).slice(1,n+1)}function i(n){return o.messages.apply(h,l(n,arguments))}function c(n){arguments[n+1].apply(h,l(n,arguments))}function f(n,e){var t,r;for(n=g.call(n),t=0;t<n.length;t++)if(Array.isArray(n[t])&&a(n[t]))n[t]=e.bind.apply(e,[null,n[t].length].concat(n[t]));else if("function"!=typeof n[t]){for(r=t+1;r<n.length&&("function"!=typeof n[r]&&!a(n[r]));r++);n.splice(t,r-t,e.bind.apply(e,[null,r-t].concat(n.slice(t,r))))}return n}var o,s={},p=(e||{})[n],g=Array.prototype.slice,m="__ASQ__",h=Object.create(null);return o=r,o.extend=function(n,e){return~["then","or","gate","pipe","seq","val","abort"].indexOf(n)||(s[n]=e),o},o.messages=function(){var n=g.call(arguments);return u(n),n},o.isSequence=function(n){return a(n)&&!Array.isArray(n)},o.isMessageWrapper=function(n){return a(n)&&Array.isArray(n)},o.noConflict=function(){return e&&(e[n]=p),o},o});
