/*! asynquence
    v0.5.2-e (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e,t){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e[n]=t(n,e)}("ASQ",this,function(n,e){"use strict";function t(){function n(n){this.fn=n,this.next=void 0}var e,t,u;return{add:function(r){u=new n(r),t?t.next=u:e=u,t=u,u=void 0},drain:function(n){for(;e;)e.fn(n),e=e.next;s=t=e}}}function u(n){p.add(n),s||(s=g(p.drain))}function r(n){var e;n.fn.val(function(){return e.apply(k,arguments),m.apply(k,arguments)}).or(function(){e.fail.apply(k,arguments)}),n.fn=a(function(n){e=n}).defer(),e=function(){n.fn=a.apply(k,arguments).defer()},e.fail=function(){var e=b.call(arguments);n.fn=a(function(n){n.fail.apply(k,e)}).defer()}}function a(){function n(){W?t():C||(C=u(t))}function e(){throw 1===G.length?G[0]:G}function t(){var t,u;if(C=null,delete H.unpause,W)clearTimeout(C),C=null,B.length=D.length=F.length=G.length=0;else if(M)for(0!==D.length||P||(P=!0,e());D.length;){P=!0,t=D.shift();try{t.apply(k,G)}catch(r){d(r)?G=G.concat(r):(G.push(r),r.stack&&G.push(r.stack)),0===D.length&&e()}}else if(z&&B.length>0){z=!1,t=B.shift(),u=F.slice(),F.length=0,u.unshift(f());try{t.apply(k,u)}catch(r){d(r)?G=G.concat(r):G.push(r),M=!0,n()}}}function f(){function e(){M||W||z||(z=!0,F.push.apply(F,arguments),G.length=0,n())}return e.fail=function(){M||W||z||(M=!0,F.length=0,G.push.apply(G,arguments),n())},e.abort=function(){M||W||(z=!1,W=!0,F.length=G.length=0,n())},e.errfcb=function(n){n?e.fail(n):e.apply(k,b.call(arguments,1))},e}function s(n,e,t){function r(){clearTimeout(p),p=v=_=s=null}function a(){return h?l():(p||(p=u(l)),void 0)}function l(){if(!(M||W||y)){var e=[];p=null,g?(n.fail.apply(k,s),r()):h?(n.abort(),r()):f()&&(y=!0,v.forEach(function(n,t){e.push(_["s"+t])}),n.apply(k,e),r())}}function f(){if(0!==v.length){var n=!0;return v.some(function(e){return null===e?(n=!1,!0):void 0}),n}}function i(){function n(){if(!(M||W||g||h||y||v[e])){var n=m.apply(k,arguments);_["s"+e]=n.length>1?n:n[0],v[e]=!0,a()}}var e=v.length;return n.fail=function(){M||W||g||h||y||v[e]||(g=!0,s=b.call(arguments),a())},n.abort=function(){M||W||g||h||y||(h=!0,l())},n.errfcb=function(e){e?n.fail(e):n.apply(k,b.call(arguments,1))},v[e]=null,n}var c,o,s,p,g=!1,h=!1,y=!1,v=[],_={};e.some(function(n){if(g||h)return!0;c=t.slice(),c.unshift(i());try{n.apply(k,c)}catch(e){return o=e,g=!0,!0}}),o&&(d(o)?n.fail.apply(k,o):n.fail(o))}function p(){return M||W||0===arguments.length?H:(o(arguments,c).forEach(function(n){y(n)?x(n):B.push(n)}),n(),H)}function g(){return W||0===arguments.length?H:(D.push.apply(D,arguments),n(),H)}function _(){if(M||W||0===arguments.length)return H;var n=b.call(arguments).map(function(n){var e;return y(n)?(e={fn:n},r(e),function(n){e.fn.pipe(n)}):n});return p(function(e){var t=b.call(arguments,1);s(e,n,t)}),H}function q(){return W||0===arguments.length?H:(b.call(arguments).forEach(function(n){p(function(e){n.apply(k,b.call(arguments,1)),e()}).or(n.fail)}),H)}function x(){return M||W||0===arguments.length?H:(b.call(arguments).forEach(function(n){var e={fn:n};y(n)&&r(e),p(function(n){var t=e.fn;y(e.fn)||(t=e.fn.apply(k,b.call(arguments,1))),t.pipe(n)})}),H)}function E(){return M||W||0===arguments.length?H:(b.call(o(arguments,i)).forEach(function(n){p(function(e){var t=n.apply(k,b.call(arguments,1));d(t)||(t=m(t)),e.apply(k,t)})}),H)}function A(){function n(n){return function(){n.apply(k,d(arguments[0])?arguments[0]:arguments)}}return M||W||0===arguments.length?H:(b.call(arguments).forEach(function(e){p(function(t){var u=e;"function"!=typeof e||"then"in e||(u=e.apply(k,b.call(arguments,1))),u.then(n(t),n(t.fail))})}),H)}function j(){var n;return E(function(){return n?n.apply(k,arguments):n=a.apply(k,arguments).defer(),m.apply(k,arguments)}),g(function(){if(n)n.fail.apply(k,arguments);else{var e=b.call(arguments);n=a().then(function(n){n.fail.apply(k,e)}).defer()}}),a().then(function(e){n?n.pipe(e):n=e}).defer()}function w(){return M?H:(W=!0,t(),H)}function O(){var n;return h={then_queue:B.slice(),or_queue:D.slice()},n=a(),h=null,n}function S(){F.push.apply(F,arguments),C===!0&&(C=null),n()}function T(){return D.push(function(){}),H}function I(n,e){var t=arguments.length>1;switch(n){case"seq_error":if(!t)return M;M=e;break;case"seq_aborted":if(!t)return W;W=e;break;case"then_ready":if(!t)return z;z=e;break;case"then_queue":return B;case"or_queue":return D;case"sequence_messages":return F;case"sequence_errors":return G}}function Q(){Object.keys(v).forEach(function(n){H[n]=v[n](H,I)})}var C,M=!1,P=!1,W=!1,z=!0,B=[],D=[],F=[],G=[],H=l({then:p,or:g,gate:_,all:_,pipe:q,seq:x,val:E,promise:A,fork:j,abort:w,duplicate:O,defer:T});return Q(),h&&(B=h.then_queue.slice(),D=h.or_queue.slice(),H.unpause=S,C=!0),H.then.apply(k,arguments),H}function l(n){return Object.defineProperty(n,q,{enumerable:!1,value:!0})}function f(n){return null!=n&&"object"==typeof n&&n[q]}function i(n){return m.apply(k,b.call(arguments).slice(1,n+1))}function c(n){arguments[n+1].apply(k,b.call(arguments).slice(1,n+1))}function o(n,e){var t,u;for(n=b.call(n),t=0;t<n.length;t++)if(d(n[t]))n[t]=e.bind.apply(e,[null,n[t].length].concat(n[t]));else if("function"!=typeof n[t]&&(e===i||!y(n[t]))){for(u=t+1;u<n.length&&("function"!=typeof n[u]&&!f(n[u]));u++);n.splice(t,u-t,e.bind.apply(e,[null,u-t].concat(n.slice(t,u))))}return n}var s,p,g="undefined"!=typeof setImmediate?function(n){return setImmediate(n)}:setTimeout;p=t();var h,m,y,d,v={},_=(e||{})[n],b=[].slice,q="__ASQ__",k=Object.create(null);return a.failed=function(){var n=m.apply(k,arguments);return a(function(){throw n}).defer()},a.extend=function(n,e){return~["then","or","gate","all","pipe","seq","val","promise","fork","abort","duplicate","defer"].indexOf(n)||(v[n]=e),a},a.messages=m=function(){var n=b.call(arguments);return l(n)},a.isSequence=y=function(n){return f(n)&&!Array.isArray(n)},a.isMessageWrapper=d=function(n){return f(n)&&Array.isArray(n)},a.unpause=function(n){return n.unpause&&n.unpause(),n},a.noConflict=function(){return e&&(e[n]=_),a},a.__schedule=u,a.__tapSequence=r,a});
