/*! asynquence
    v0.3.6-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(n,e,t){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e[n]=t(n,e)}("ASQ",this,function(n,e){"use strict";function t(){}function r(n){return"undefined"!=typeof setImmediate?setImmediate(n):setTimeout(n,0)}function u(){function n(){return W?i():(I||(I=r(i)),void 0)}function e(){throw 1===D.length?D[0]:D}function i(){var t,r;if(I=null,delete F.unpause,W)clearTimeout(I),I=null,P.length=0,z.length=0,B.length=0,D.length=0;else if(M)for(0!==z.length||Q||(Q=!0,e());z.length;){Q=!0,t=z.shift();try{t.apply(d,D)}catch(u){l(u)?D=D.concat(u):(D.push(u),u.stack&&D.push(u.stack)),0===z.length&&e()}}else if(C&&P.length>0){C=!1,t=P.shift(),r=B.slice(),B.length=0,r.unshift(h());try{t.apply(d,r)}catch(u){l(u)?D=D.concat(u):D.push(u),M=!0,n()}}}function h(){function e(){M||W||C||(C=!0,B.push.apply(B,arguments),D.length=0,n())}return e.fail=function(){M||W||C||(M=!0,B.length=0,D.push.apply(D,arguments),n())},e.abort=function(){M||W||(C=!1,W=!0,B.length=0,D.length=0,n())},e.errfcb=function(n){n?e.fail(n):e.apply(d,m.call(arguments,1))},e}function y(n,e,t){function u(){clearTimeout(h),h=_=q=g=null}function a(){return v?i():(h||(h=r(i)),void 0)}function i(){if(!(M||W||b)){var e=[];h=null,y?(n.fail.apply(d,g),u()):v?(n.abort(),u()):c()&&(b=!0,_.forEach(function(n,t){e.push(q["s"+t])}),n.apply(d,e),u())}}function c(){if(!(M||W||y||v||b||0===_.length)){var n=!0;return _.some(function(e){return null===e?(n=!1,!0):void 0}),n}}function o(){function n(){if(!(M||W||y||v||b||_[e])){var n=s.messages.apply(d,arguments);q["s"+e]=n.length>1?n:n[0],_[e]=!0,a()}}var e=_.length;return n.fail=function(){M||W||y||v||b||_[e]||(y=!0,g=m.call(arguments),a())},n.abort=function(){M||W||y||v||b||(v=!0,i())},n.errfcb=function(e){e?n.fail(e):n.apply(d,m.call(arguments,1))},_[e]=null,n}var f,p,g,h,y=!1,v=!1,b=!1,_=[],q={};e.some(function(n){if(y||v)return!0;f=t.slice(),f.unshift(o());try{n.apply(d,f)}catch(e){return p=e,y=!0,!0}}),p&&(l(p)?n.fail.apply(d,p):n.fail(p))}function v(){return M||W||0===arguments.length?F:(P.push.apply(P,f(arguments,o)),n(),F)}function b(){return W||0===arguments.length?F:(z.push.apply(z,arguments),n(),F)}function _(){if(M||W||0===arguments.length)return F;var n=m.call(arguments);return v(function(e){var t=m.call(arguments,1);y(e,n,t)}),F}function q(){return W||0===arguments.length?F:(m.call(arguments).forEach(function(n){v(function(e){n.apply(d,m.call(arguments,1)),e()}).or(n.fail)}),F)}function A(){return M||W||0===arguments.length?F:(m.call(arguments).forEach(function(n){var e;l(n)&&"next"in n&&(n.then(function(){e.apply(d,arguments)}).or(function(){e.fail.apply(d,arguments)}),n=u(function(n){e=n}).or(t),e=function(){n=u.apply(d,arguments).or(t)},e.fail=function(){var e=m.call(arguments);n=u(function(n){n.fail.apply(d,e)}).or(t)}),v(function(e){l(n)||(n=n.apply(d,m.call(arguments,1))),n.pipe(e)})}),F)}function k(){return M||W||0===arguments.length?F:(m.call(f(arguments,c)).forEach(function(n){v(function(e){var t=n.apply(d,m.call(arguments,1));l(t)||(t=s.messages(t)),e.apply(d,t)})}),F)}function E(){function n(n){return function(){n.apply(d,s.isMessageWrapper(arguments[0])?arguments[0]:arguments)}}return M||W||0===arguments.length?F:(m.call(arguments).forEach(function(e){v(function(t){"function"!=typeof e||"then"in e||(e=e.apply(d,m.call(arguments,1))),e.then(n(t),n(t.fail))})}),F)}function x(){var n;return k(function(){return n?n.apply(d,arguments):n=u.apply(d,arguments).or(t),s.messages.apply(d,arguments)}),b(function(){if(n)n.fail.apply(d,arguments);else{var e=m.call(arguments);n=u().then(function(n){n.fail.apply(d,e)}).or(t)}}),u().then(function(e){n?n.pipe(e):n=e}).or(t)}function j(){return M?F:(W=!0,i(),F)}function O(){var n;return p={then_queue:P.slice(0),or_queue:z.slice(0)},n=u(),p=null,n}function S(){B.push.apply(B,arguments),I===!0&&(I=null),n()}function T(n,e){var t=arguments.length>1;switch(n){case"seq_error":if(!t)return M;M=e;break;case"seq_aborted":if(!t)return W;W=e;break;case"then_ready":if(!t)return C;C=e;break;case"then_queue":return P;case"or_queue":return z;case"sequence_messages":return B;case"sequence_errors":return D}}function w(){Object.keys(g).forEach(function(n){F[n]=g[n](F,T)})}var I,M=!1,Q=!1,W=!1,C=!0,P=[],z=[],B=[],D=[],F=a({then:v,or:b,gate:_,pipe:q,seq:A,val:k,promise:E,fork:x,abort:j,duplicate:O});return w(),p&&(P=p.then_queue.slice(0),z=p.or_queue.slice(0),F.unpause=S,I=!0),F.then.apply(d,f(arguments,o)),F}function a(n){return Object.defineProperty(n,y,{enumerable:!1,value:!0})}function l(n){return null!=n&&"object"==typeof n&&n[y]}function i(n,e){return m.call(e).slice(1,n+1)}function c(n){return s.messages.apply(d,i(n,arguments))}function o(n){arguments[n+1].apply(d,i(n,arguments))}function f(n,e){var t,r;for(n=m.call(n),t=0;t<n.length;t++)if(Array.isArray(n[t])&&l(n[t]))n[t]=e.bind.apply(e,[null,n[t].length].concat(n[t]));else if("function"!=typeof n[t]){for(r=t+1;r<n.length&&("function"!=typeof n[r]&&!l(n[r]));r++);n.splice(t,r-t,e.bind.apply(e,[null,r-t].concat(n.slice(t,r))))}return n}var s,p,g={},h=(e||{})[n],m=Array.prototype.slice,y="__ASQ__",d=Object.create(null);return s=u,s.extend=function(n,e){return~["then","or","gate","pipe","seq","val","abort"].indexOf(n)||(g[n]=e),s},s.messages=function(){var n=m.call(arguments);return a(n),n},s.isSequence=function(n){return l(n)&&!Array.isArray(n)},s.isMessageWrapper=function(n){return l(n)&&Array.isArray(n)},s.unpause=function(n){return n.unpause&&n.unpause(),n},s.noConflict=function(){return e&&(e[n]=h),s},s});
