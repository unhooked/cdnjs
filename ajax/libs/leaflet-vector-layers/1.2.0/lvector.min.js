!function(t){t.lvector={VERSION:"1.2.0",noConflict:function(){return t.lvector=this._originallvector,this},_originallvector:t.lvector},L.LatLngBounds.equals||(L.LatLngBounds=L.LatLngBounds.extend({equals:function(t){var e=!1;return null!==t&&(e=this._southWest.lat==t.getSouthWest().lat&&this._southWest.lng==t.getSouthWest().lng&&this._northEast.lat==t.getNorthEast().lat&&this._northEast.lng==t.getNorthEast().lng),e}})),L.Popup=L.Popup.extend({_close:function(){this._opened&&(this._map.closePopup(),this._map.removeLayer(this))}})}(this),lvector.Util={extend:function(t){for(var e,o=Array.prototype.slice.call(arguments,1),s=0,i=o.length;i>s;s++){e=o[s]||{};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}return t},setOptions:function(t,e){t.options=lvector.Util.extend({},t.options,e)}},lvector.Class=function(){},lvector.Class.extend=function(t){var e=function(){this.initialize&&this.initialize.apply(this,arguments)},o=function(){};o.prototype=this.prototype,o=new o,o.constructor=e,e.prototype=o,e.superclass=this.prototype;for(var s in this)this.hasOwnProperty(s)&&"prototype"!=s&&"superclass"!=s&&(e[s]=this[s]);return t.statics&&(lvector.Util.extend(e,t.statics),delete t.statics),t.includes&&(lvector.Util.extend.apply(null,[o].concat(t.includes)),delete t.includes),t.options&&o.options&&(t.options=lvector.Util.extend({},o.options,t.options)),lvector.Util.extend(o,t),e.extend=arguments.callee,e.include=function(t){lvector.Util.extend(this.prototype,t)},e},lvector.Layer=lvector.Class.extend({options:{fields:"",scaleRange:null,map:null,uniqueField:null,visibleAtScale:!0,dynamic:!1,autoUpdate:!1,autoUpdateInterval:null,popupTemplate:null,popupOptions:{},singlePopup:!1,symbology:null,showAll:!1},initialize:function(t){lvector.Util.setOptions(this,t)},setMap:function(t){if(!t||!this.options.map)if(t){if(this.options.map=t,this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length){var t=this.options.map.getZoom(),e=this.options.scaleRange;this.options.visibleAtScale=t>=e[0]&&t<=e[1]}this._show()}else this.options.map&&(this._hide(),this.options.map=t)},getMap:function(){return this.options.map},setOptions:function(){},_show:function(){if(this._addIdleListener(),this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length&&this._addZoomChangeListener(),this.options.visibleAtScale){if(this.options.autoUpdate&&this.options.autoUpdateInterval){var t=this;this._autoUpdateInterval=setInterval(function(){t._getFeatures()},this.options.autoUpdateInterval)}this.options.map.fire("moveend").fire("zoomend")}},_hide:function(){this._idleListener&&this.options.map.off("moveend",this._idleListener),this._zoomChangeListener&&this.options.map.off("zoomend",this._zoomChangeListener),this._autoUpdateInterval&&clearInterval(this._autoUpdateInterval),this._clearFeatures(),this._lastQueriedBounds=null,this._gotAll&&(this._gotAll=!1)},_hideVectors:function(){for(var t=0;t<this._vectors.length;t++)if(this._vectors[t].vector&&(this.options.map.removeLayer(this._vectors[t].vector),this._vectors[t].popup?this.options.map.removeLayer(this._vectors[t].popup):this.popup&&this.popup.associatedFeature&&this.popup.associatedFeature==this._vectors[t]&&(this.options.map.removeLayer(this.popup),this.popup=null)),this._vectors[t].vectors&&this._vectors[t].vectors.length)for(var e=0;e<this._vectors[t].vectors.length;e++)this.options.map.removeLayer(this._vectors[t].vectors[e]),this._vectors[t].vectors[e].popup?this.options.map.removeLayer(this._vectors[t].vectors[e].popup):this.popup&&this.popup.associatedFeature&&this.popup.associatedFeature==this._vectors[t]&&(this.options.map.removeLayer(this.popup),this.popup=null)},_showVectors:function(){for(var t=0;t<this._vectors.length;t++)if(this._vectors[t].vector&&this.options.map.addLayer(this._vectors[t].vector),this._vectors[t].vectors&&this._vectors[t].vectors.length)for(var e=0;e<this._vectors[t].vectors.length;e++)this.options.map.addLayer(this._vectors[t].vectors[e])},_clearFeatures:function(){this._hideVectors(),this._vectors=[]},_addZoomChangeListener:function(){this._zoomChangeListener=this._zoomChangeListenerTemplate(),this.options.map.on("zoomend",this._zoomChangeListener,this)},_zoomChangeListenerTemplate:function(){var t=this;return function(){t._checkLayerVisibility()}},_idleListenerTemplate:function(){var t=this;return function(){t.options.visibleAtScale&&(t.options.showAll?t._gotAll||(t._getFeatures(),t._gotAll=!0):t._getFeatures())}},_addIdleListener:function(){this._idleListener=this._idleListenerTemplate(),this.options.map.on("moveend",this._idleListener,this)},_checkLayerVisibility:function(){var t=this.options.visibleAtScale,e=this.options.map.getZoom(),o=this.options.scaleRange;if(this.options.visibleAtScale=e>=o[0]&&e<=o[1],t!==this.options.visibleAtScale&&this[this.options.visibleAtScale?"_showVectors":"_hideVectors"](),t&&!this.options.visibleAtScale&&this._autoUpdateInterval)clearInterval(this._autoUpdateInterval);else if(!t&&this.options.autoUpdate&&this.options.autoUpdateInterval){var s=this;this._autoUpdateInterval=setInterval(function(){s._getFeatures()},this.options.autoUpdateInterval)}},_setPopupContent:function(t){var e,o=t.popupContent,s=t.attributes||t.properties;if("string"==typeof this.options.popupTemplate){e=this.options.popupTemplate;for(var i in s)e=e.replace(RegExp("{"+i+"}","g"),s[i])}else{if("function"!=typeof this.options.popupTemplate)return;e=this.options.popupTemplate(s)}t.popupContent=e,t.popup?t.popupContent!==o&&t.popup.setContent(t.popupContent):this.popup&&this.popup.associatedFeature==t&&t.popupContent!==o&&this.popup.setContent(t.popupContent)},_showPopup:function(t,e){var o=e.latlng;o||L.Util.extend(this.options.popupOptions,{offset:e.target.options.icon.popupAnchor});var s;this.options.singlePopup?(this.popup&&(this.options.map.removeLayer(this.popup),this.popup=null),this.popup=new L.Popup(this.options.popupOptions,t.vector),this.popup.associatedFeature=t,s=this):(t.popup=new L.Popup(this.options.popupOptions,t.vector),s=t),s.popup.setLatLng(o?e.latlng:e.target.getLatLng()),s.popup.setContent(t.popupContent),this.options.map.addLayer(s.popup)},_getFeatureVectorOptions:function(t){var e={},t=t.attributes||t.properties;if(this.options.symbology)switch(this.options.symbology.type){case"single":for(var o in this.options.symbology.vectorOptions)e[o]=this.options.symbology.vectorOptions[o];break;case"unique":for(var s=this.options.symbology.property,i=0,r=this.options.symbology.values.length;r>i;i++)if(t[s]==this.options.symbology.values[i].value)for(o in this.options.symbology.values[i].vectorOptions)e[o]=this.options.symbology.values[i].vectorOptions[o];break;case"range":for(s=this.options.symbology.property,i=0,r=this.options.symbology.ranges.length;r>i;i++)if(t[s]>=this.options.symbology.ranges[i].range[0]&&t[s]<=this.options.symbology.ranges[i].range[1])for(o in this.options.symbology.ranges[i].vectorOptions)e[o]=this.options.symbology.ranges[i].vectorOptions[o]}return e},_getPropertiesChanged:function(t,e){var o,s=!1;for(o in t)t[o]!=e[o]&&(s=!0);return s},_getPropertyChanged:function(t,e,o){return t[o]!=e[o]},_getGeometryChanged:function(t,e){var o=!1;return t.coordinates&&t.coordinates instanceof Array?t.coordinates[0]==e.coordinates[0]&&t.coordinates[1]==e.coordinates[1]||(o=!0):t.x==e.x&&t.y==e.y||(o=!0),o},_makeJsonpRequest:function(t){var e=document.getElementsByTagName("head")[0],o=document.createElement("script");o.type="text/javascript",o.src=t,e.appendChild(o)},_processFeatures:function(t){if(this.options.map){var e=this.options.map.getBounds();if(!this._lastQueriedBounds||!this._lastQueriedBounds.equals(e)||this.options.autoUpdate){if(this._lastQueriedBounds=e,this instanceof lvector.GeoIQ&&(t=JSON.parse(t)),this instanceof lvector.PRWSF){t.features=t.rows,delete t.rows;for(var e=0,o=t.features.length;o>e;e++){t.features[e].type="Feature",t.features[e].properties={};for(var s in t.features[e].row)"geojson"==s?t.features[e].geometry=t.features[e].row.geojson:t.features[e].properties[s]=t.features[e].row[s];delete t.features[e].row}}if(this instanceof lvector.GISCloud)for(t.features=t.data,delete t.data,e=0,o=t.features.length;o>e;e++)t.features[e].type="Feature",t.features[e].properties=t.features[e].data,t.features[e].properties.id=t.features[e].__id,delete t.features[e].data,t.features[e].geometry=t.features[e].__geometry,delete t.features[e].__geometry;if(t&&t.features&&t.features.length)for(e=0;e<t.features.length;e++){if(this instanceof lvector.EsriJSONLayer&&(t.features[e].properties=t.features[e].attributes,delete t.features[e].attributes),s=!1,this.options.uniqueField)for(o=0;o<this._vectors.length;o++)if(t.features[e].properties[this.options.uniqueField]==this._vectors[o].properties[this.options.uniqueField]&&(s=!0,this.options.dynamic)&&(!this._getGeometryChanged(this._vectors[o].geometry,t.features[e].geometry)||isNaN(t.features[e].geometry.coordinates[0])||isNaN(t.features[e].geometry.coordinates[1])||(this._vectors[o].geometry=t.features[e].geometry,this._vectors[o].vector.setLatLng(new L.LatLng(this._vectors[o].geometry.coordinates[1],this._vectors[o].geometry.coordinates[0]))),this._getPropertiesChanged(this._vectors[o].properties,t.features[e].properties))){var i=this._getPropertyChanged(this._vectors[o].properties,t.features[e].properties,this.options.symbology.property);if(this._vectors[o].properties=t.features[e].properties,this.options.popupTemplate&&this._setPopupContent(this._vectors[o]),this.options.symbology&&"single"!=this.options.symbology.type&&i)if(this._vectors[o].vectors)for(var i=0,r=this._vectors[o].vectors.length;r>i;i++)this._vectors[o].vectors[i].setStyle?this._vectors[o].vectors[i].setStyle(this._getFeatureVectorOptions(this._vectors[o])):this._vectors[o].vectors[i].setIcon&&this._vectors[o].vectors[i].setIcon(this._getFeatureVectorOptions(this._vectors[o]).icon);else this._vectors[o].vector&&(this._vectors[o].vector.setStyle?this._vectors[o].vector.setStyle(this._getFeatureVectorOptions(this._vectors[o])):this._vectors[o].vector.setIcon&&this._vectors[o].vector.setIcon(this._getFeatureVectorOptions(this._vectors[o]).icon))}if(!s||!this.options.uniqueField){if(this instanceof lvector.GeoJSONLayer?(s=this._geoJsonGeometryToLeaflet(t.features[e].geometry,this._getFeatureVectorOptions(t.features[e])),t.features[e][s instanceof Array?"vectors":"vector"]=s):this instanceof lvector.EsriJSONLayer&&(s=this._esriJsonGeometryToLeaflet(t.features[e].geometry,this._getFeatureVectorOptions(t.features[e])),t.features[e][s instanceof Array?"vectors":"vector"]=s),t.features[e].vector)this.options.map.addLayer(t.features[e].vector);else if(t.features[e].vectors&&t.features[e].vectors.length)for(i=0;i<t.features[e].vectors.length;i++)this.options.map.addLayer(t.features[e].vectors[i]);if(this._vectors.push(t.features[e]),this.options.popupTemplate){var n=this;s=t.features[e],this._setPopupContent(s),function(t){if(t.vector)t.vector.on("click",function(e){n._showPopup(t,e)});else if(t.vectors)for(var e=0,o=t.vectors.length;o>e;e++)t.vectors[e].on("click",function(e){n._showPopup(t,e)})}(s)}}}}}}}),lvector.GeoJSONLayer=lvector.Layer.extend({_geoJsonGeometryToLeaflet:function(t,e){var o,s;switch(t.type){case"Point":o=new L.Marker(new L.LatLng(t.coordinates[1],t.coordinates[0]),e);break;case"MultiPoint":s=[];for(var i=0,r=t.coordinates.length;r>i;i++)s.push(new L.Marker(new L.LatLng(t.coordinates[i][1],t.coordinates[i][0]),e));break;case"LineString":for(var n=[],i=0,r=t.coordinates.length;r>i;i++)n.push(new L.LatLng(t.coordinates[i][1],t.coordinates[i][0]));o=new L.Polyline(n,e);break;case"MultiLineString":for(s=[],i=0,r=t.coordinates.length;r>i;i++){for(var n=[],a=0,p=t.coordinates[i].length;p>a;a++)n.push(new L.LatLng(t.coordinates[i][a][1],t.coordinates[i][a][0]));s.push(new L.Polyline(n,e))}break;case"Polygon":for(var h=[],i=0,r=t.coordinates.length;r>i;i++){for(n=[],a=0,p=t.coordinates[i].length;p>a;a++)n.push(new L.LatLng(t.coordinates[i][a][1],t.coordinates[i][a][0]));h.push(n)}o=new L.Polygon(h,e);break;case"MultiPolygon":for(s=[],i=0,r=t.coordinates.length;r>i;i++){for(h=[],a=0,p=t.coordinates[i].length;p>a;a++){for(var n=[],l=0,c=t.coordinates[i][a].length;c>l;l++)n.push(new L.LatLng(t.coordinates[i][a][l][1],t.coordinates[i][a][l][0]));h.push(n)}s.push(new L.Polygon(h,e))}break;case"GeometryCollection":for(s=[],i=0,r=t.geometries.length;r>i;i++)s.push(this._geoJsonGeometryToLeaflet(t.geometries[i],e))}return o||s}}),lvector.EsriJSONLayer=lvector.Layer.extend({_esriJsonGeometryToLeaflet:function(t,e){var o,s;if(t.x&&t.y)o=new L.Marker(new L.LatLng(t.y,t.x),e);else if(t.points){s=[];for(var i=0,r=t.points.length;r>i;i++)s.push(new L.Marker(new L.LatLng(t.points[i].y,t.points[i].x),e))}else if(t.paths)if(t.paths.length>1)for(s=[],i=0,r=t.paths.length;r>i;i++){for(var n=[],a=0,p=t.paths[i].length;p>a;a++)n.push(new L.LatLng(t.paths[i][a][1],t.paths[i][a][0]));s.push(new L.Polyline(n,e))}else{for(n=[],i=0,r=t.paths[0].length;r>i;i++)n.push(new L.LatLng(t.paths[0][i][1],t.paths[0][i][0]));o=new L.Polyline(n,e)}else if(t.rings)if(t.rings.length>1)for(s=[],i=0,r=t.rings.length;r>i;i++){for(var h=[],n=[],a=0,p=t.rings[i].length;p>a;a++)n.push(new L.LatLng(t.rings[i][a][1],t.rings[i][a][0]));h.push(n),s.push(new L.Polygon(h,e))}else{for(h=[],n=[],i=0,r=t.rings[0].length;r>i;i++)n.push(new L.LatLng(t.rings[0][i][1],t.rings[0][i][0]));h.push(n),o=new L.Polygon(h,e)}return o||s}}),lvector.AGS=lvector.EsriJSONLayer.extend({initialize:function(t){for(var e=0,o=this._requiredParams.length;o>e;e++)if(!t[this._requiredParams[e]])throw Error('No "'+this._requiredParams[e]+'" parameter found.');if(this._globalPointer="AGS_"+Math.floor(1e5*Math.random()),window[this._globalPointer]=this,"/"!==t.url.substr(t.url.length-1,1)&&(t.url+="/"),this._originalOptions=lvector.Util.extend({},t),t.esriOptions){if("object"!=typeof t.esriOptions)return void this._getEsriOptions();lvector.Util.extend(t,this._convertEsriOptions(t.esriOptions))}lvector.Layer.prototype.initialize.call(this,t),this.options.where&&(this.options.where=encodeURIComponent(this.options.where)),this._vectors=[],this.options.map&&(this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length&&(t=this.options.map.getZoom(),e=this.options.scaleRange,this.options.visibleAtScale=t>=e[0]&&t<=e[1]),this._show())},options:{where:"1=1",url:null,useEsriOptions:!1},_requiredParams:["url"],_convertEsriOptions:function(t){var e={};if(void 0!=t.minScale&&void 0!=t.maxScale){var o=this._scaleToLevel(t.minScale),s=this._scaleToLevel(t.maxScale);0==s&&(s=20),e.scaleRange=[o,s]}return t.drawingInfo&&t.drawingInfo.renderer&&(e.symbology=this._renderOptionsToSymbology(t.drawingInfo.renderer)),e},_getEsriOptions:function(){this._makeJsonpRequest(this._originalOptions.url+"?f=json&callback="+this._globalPointer+"._processEsriOptions")},_processEsriOptions:function(t){var e=this._originalOptions;e.esriOptions=t,this.initialize(e)},_scaleToLevel:function(t){var e=[591657527.591555,295828763.795777,147914381.897889,73957190.948944,36978595.474472,18489297.737236,9244648.868618,4622324.434309,2311162.217155,1155581.108577,577790.554289,288895.277144,144447.638572,72223.819286,36111.909643,18055.954822,9027.977411,4513.988705,2256.994353,1128.497176,564.248588,282.124294];if(0==t)return 0;for(var o=0,s=0;s<e.length-1;s++){var i=e[s+1];if(t<=e[s]&&t>i){o=s;break}}return o},_renderOptionsToSymbology:function(t){switch(symbology={},t.type){case"simple":symbology.type="single",symbology.vectorOptions=this._parseSymbology(t.symbol);break;case"uniqueValue":symbology.type="unique",symbology.property=t.field1;for(var e=[],o=0;o<t.uniqueValueInfos.length;o++){var s=t.uniqueValueInfos[o],i={};i.value=s.value,i.vectorOptions=this._parseSymbology(s.symbol),i.label=s.label,e.push(i)}symbology.values=e;break;case"classBreaks":for(symbology.type="range",symbology.property=rend.field,e=[],s=t.minValue,o=0;o<t.classBreakInfos.length;o++){var i=t.classBreakInfos[o],r={};r.range=[s,i.classMaxValue],s=i.classMaxValue,r.vectorOptions=this._parseSymbology(i.symbol),r.label=i.label,e.push(r)}symbology.ranges=e}return symbology},_parseSymbology:function(t){var e={};switch(t.type){case"esriSMS":case"esriPMS":t=L.Icon.extend({iconUrl:"data:"+t.contentType+";base64,"+t.imageData,shadowUrl:null,iconSize:new L.Point(t.width,t.height),iconAnchor:new L.Point(t.width/2+t.xoffset,t.height/2+t.yoffset),popupAnchor:new L.Point(0,-(t.height/2))}),e.icon=new t;break;case"esriSLS":e.weight=t.width,e.color=this._parseColor(t.color),e.opacity=this._parseAlpha(t.color[3]);break;case"esriSFS":t.outline?(e.weight=t.outline.width,e.color=this._parseColor(t.outline.color),e.opacity=this._parseAlpha(t.outline.color[3])):(e.weight=0,e.color="#000000",e.opacity=0),"esriSFSNull"!=t.style?(e.fillColor=this._parseColor(t.color),e.fillOpacity=this._parseAlpha(t.color[3])):(e.fillColor="#000000",e.fillOpacity=0)}return e},_parseColor:function(t){return red=this._normalize(t[0]),green=this._normalize(t[1]),blue=this._normalize(t[2]),"#"+this._pad(red.toString(16))+this._pad(green.toString(16))+this._pad(blue.toString(16))},_normalize:function(t){return 1>t&&t>0?Math.floor(255*t):t},_pad:function(t){return t.length>1?t.toUpperCase():"0"+t.toUpperCase()},_parseAlpha:function(t){return t/255},_getFeatures:function(){this.options.uniqueField||this._clearFeatures();var t=this.options.url+"query?returnGeometry=true&outSR=4326&f=json&outFields="+this.options.fields+"&where="+this.options.where+"&callback="+this._globalPointer+"._processFeatures";this.options.showAll||(t+="&inSR=4326&spatialRel=esriSpatialRelIntersects&geometryType=esriGeometryEnvelope&geometry="+this.options.map.getBounds().toBBoxString()),this._makeJsonpRequest(t)},_processFeatures:function(t){if(this.options.map){var e=this.options.map.getBounds();if((!this._lastQueriedBounds||!this._lastQueriedBounds.equals(e)||this.options.autoUpdate)&&(this._lastQueriedBounds=e,t&&t.features&&t.features.length))for(e=0;e<t.features.length;e++){var o=!1;if(this.options.uniqueField)for(var s=0;s<this._vectors.length;s++)if(t.features[e].attributes[this.options.uniqueField]==this._vectors[s].attributes[this.options.uniqueField]&&(o=!0,this.options.dynamic)&&(!this._getGeometryChanged(this._vectors[s].geometry,t.features[e].geometry)||isNaN(t.features[e].geometry.x)||isNaN(t.features[e].geometry.y)||(this._vectors[s].geometry=t.features[e].geometry,this._vectors[s].vector.setLatLng(new L.LatLng(this._vectors[s].geometry.y,this._vectors[s].geometry.x)),this._vectors[s].popup?this._vectors[s].popup.setLatLng(new L.LatLng(this._vectors[s].geometry.y,this._vectors[s].geometry.x)):this.popup&&this.popup.associatedFeature==this._vectors[s]&&this.popup.setLatLng(new L.LatLng(this._vectors[s].geometry.y,this._vectors[s].geometry.x))),this._getPropertiesChanged(this._vectors[s].attributes,t.features[e].attributes)&&(this._vectors[s].attributes=t.features[e].attributes,this.options.popupTemplate&&this._setPopupContent(this._vectors[s]),this.options.symbology&&"single"!=this.options.symbology.type)))if(this._vectors[s].vectors)for(var i=0,r=this._vectors[s].vectors.length;r>i;i++)this._vectors[s].vectors[i].setStyle?this._vectors[s].vectors[i].setStyle(this._getFeatureVectorOptions(this._vectors[s])):this._vectors[s].vectors[i].setIcon&&this._vectors[s].vectors[i].setIcon(this._getFeatureVectorOptions(this._vectors[s]).icon);else this._vectors[s].vector&&(this._vectors[s].vector.setStyle?this._vectors[s].vector.setStyle(this._getFeatureVectorOptions(this._vectors[s])):this._vectors[s].vector.setIcon&&this._vectors[s].vector.setIcon(this._getFeatureVectorOptions(this._vectors[s]).icon));if(!o||!this.options.uniqueField){if(o=this._esriJsonGeometryToLeaflet(t.features[e].geometry,this._getFeatureVectorOptions(t.features[e])),t.features[e][o instanceof Array?"vectors":"vector"]=o,t.features[e].vector)this.options.map.addLayer(t.features[e].vector);else if(t.features[e].vectors&&t.features[e].vectors.length)for(i=0;i<t.features[e].vectors.length;i++)this.options.map.addLayer(t.features[e].vectors[i]);if(this._vectors.push(t.features[e]),this.options.popupTemplate){var n=this,o=t.features[e];this._setPopupContent(o),function(t){if(t.vector)t.vector.on("click",function(e){n._showPopup(t,e)});else if(t.vectors)for(var e=0,o=t.vectors.length;o>e;e++)t.vectors[e].on("click",function(e){n._showPopup(t,e)})}(o)}}}}}}),lvector.A2E=lvector.AGS.extend({initialize:function(t){for(var e=0,o=this._requiredParams.length;o>e;e++)if(!t[this._requiredParams[e]])throw Error('No "'+this._requiredParams[e]+'" parameter found.');if(this._globalPointer="A2E_"+Math.floor(1e5*Math.random()),window[this._globalPointer]=this,"/"!==t.url.substr(t.url.length-1,1)&&(t.url+="/"),this._originalOptions=lvector.Util.extend({},t),t.esriOptions){if("object"!=typeof t.esriOptions)return void this._getEsriOptions();lvector.Util.extend(t,this._convertEsriOptions(t.esriOptions))}if(lvector.Layer.prototype.initialize.call(this,t),this.options.where&&(this.options.where=encodeURIComponent(this.options.where)),this._vectors=[],this.options.map&&(this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length&&(t=this.options.map.getZoom(),e=this.options.scaleRange,this.options.visibleAtScale=t>=e[0]&&t<=e[1]),this._show()),this.options.autoUpdate&&this.options.esriOptions.editFeedInfo){this._makeJsonpRequest("http://cdn.pubnub.com/pubnub-3.1.min.js");var s=this;this._pubNubScriptLoaderInterval=setInterval(function(){window.PUBNUB&&s._pubNubScriptLoaded()},200)}},_pubNubScriptLoaded:function(){clearInterval(this._pubNubScriptLoaderInterval),this.pubNub=PUBNUB.init({subscribe_key:this.options.esriOptions.editFeedInfo.pubnubSubscribeKey,ssl:!1,origin:"pubsub.pubnub.com"});var t=this;this.pubNub.subscribe({channel:this.options.esriOptions.editFeedInfo.pubnubChannel,callback:function(){t._getFeatures()},error:function(){}})}}),lvector.GeoIQ=lvector.GeoJSONLayer.extend({initialize:function(t){for(var e=0,o=this._requiredParams.length;o>e;e++)if(!t[this._requiredParams[e]])throw Error('No "'+this._requiredParams[e]+'" parameter found.');lvector.Layer.prototype.initialize.call(this,t),this._globalPointer="GeoIQ_"+Math.floor(1e5*Math.random()),window[this._globalPointer]=this,this._vectors=[],this.options.map&&(this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length&&(t=this.options.map.getZoom(),e=this.options.scaleRange,this.options.visibleAtScale=t>=e[0]&&t<=e[1]),this._show())},options:{dataset:null},_requiredParams:["dataset"],_getFeatures:function(){this.options.uniqueField||this._clearFeatures();var t="http://geocommons.com/datasets/"+this.options.dataset+"/features.json?geojson=1&callback="+this._globalPointer+"._processFeatures&limit=999";this.options.showAll||(t+="&bbox="+this.options.map.getBounds().toBBoxString()+"&intersect=full"),this._makeJsonpRequest(t)},_processFeatures:function(t){if(this.options.map){var t=JSON.parse(t),e=this.options.map.getBounds();if((!this._lastQueriedBounds||!this._lastQueriedBounds.equals(e)||this.options.autoUpdate)&&(this._lastQueriedBounds=e,t&&t.features&&t.features.length))for(e=0;e<t.features.length;e++){var o=!1;if(this.options.uniqueField)for(var s=0;s<this._vectors.length;s++)if(t.features[e].properties[this.options.uniqueField]==this._vectors[s].properties[this.options.uniqueField]&&(o=!0,this.options.dynamic)&&(!this._getGeometryChanged(this._vectors[s].geometry,t.features[e].geometry)||isNaN(t.features[e].geometry.coordinates[0])||isNaN(t.features[e].geometry.coordinates[1])||(this._vectors[s].geometry=t.features[e].geometry,this._vectors[s].vector.setLatLng(new L.LatLng(this._vectors[s].geometry.coordinates[1],this._vectors[s].geometry.coordinates[0]))),this._getPropertiesChanged(this._vectors[s].properties,t.features[e].properties)&&(this._vectors[s].properties=t.features[e].properties,this.options.popupTemplate&&this._setPopupContent(this._vectors[s]),this.options.symbology&&"single"!=this.options.symbology.type)))if(this._vectors[s].vectors)for(var i=0,r=this._vectors[s].vectors.length;r>i;i++)this._vectors[s].vectors[i].setStyle?this._vectors[s].vectors[i].setStyle(this._getFeatureVectorOptions(this._vectors[s])):this._vectors[s].vectors[i].setIcon&&this._vectors[s].vectors[i].setIcon(this._getFeatureVectorOptions(this._vectors[s]).icon);else this._vectors[s].vector&&(this._vectors[s].vector.setStyle?this._vectors[s].vector.setStyle(this._getFeatureVectorOptions(this._vectors[s])):this._vectors[s].vector.setIcon&&this._vectors[s].vector.setIcon(this._getFeatureVectorOptions(this._vectors[s]).icon));if(!o||!this.options.uniqueField){if(o=this._geoJsonGeometryToLeaflet(t.features[e].geometry,this._getFeatureVectorOptions(t.features[e])),t.features[e][o instanceof Array?"vectors":"vector"]=o,t.features[e].vector)this.options.map.addLayer(t.features[e].vector);else if(t.features[e].vectors&&t.features[e].vectors.length)for(i=0;i<t.features[e].vectors.length;i++)this.options.map.addLayer(t.features[e].vectors[i]);if(this._vectors.push(t.features[e]),this.options.popupTemplate){var n=this,o=t.features[e];this._setPopupContent(o),function(t){if(t.vector)t.vector.on("click",function(e){n._showPopup(t,e)});else if(t.vectors)for(var e=0,o=t.vectors.length;o>e;e++)t.vectors[e].on("click",function(e){n._showPopup(t,e)})}(o)}}}}}}),lvector.CartoDB=lvector.GeoJSONLayer.extend({initialize:function(t){for(var e=0,o=this._requiredParams.length;o>e;e++)if(!t[this._requiredParams[e]])throw Error('No "'+this._requiredParams[e]+'" parameter found.');lvector.Layer.prototype.initialize.call(this,t),this._globalPointer="CartoDB_"+Math.floor(1e5*Math.random()),window[this._globalPointer]=this,this._vectors=[],this.options.map&&(this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length&&(t=this.options.map.getZoom(),e=this.options.scaleRange,this.options.visibleAtScale=t>=e[0]&&t<=e[1]),this._show())},options:{version:1,user:null,table:null,fields:"*",where:null,limit:null,uniqueField:"cartodb_id"},_requiredParams:["user","table"],_getFeatures:function(){var t=this.options.where||"";if(!this.options.showAll)for(var e=this.options.map.getBounds(),o=e.getSouthWest(),e=e.getNorthEast(),s=this.options.table.split(",").length,i=0;s>i;i++)t+=(t.length?" AND ":"")+(s>1?this.options.table.split(",")[i].split(".")[0]+".the_geom":"the_geom")+" && st_setsrid(st_makebox2d(st_point("+o.lng+","+o.lat+"),st_point("+e.lng+","+e.lat+")),4326)";this.options.limit&&(t+=(t.length?" ":"")+"limit "+this.options.limit),t=t.length?" "+t:"",this._makeJsonpRequest("http://"+this.options.user+".cartodb.com/api/v"+this.options.version+"/sql?q="+encodeURIComponent("SELECT "+this.options.fields+" FROM "+this.options.table+(t.length?" WHERE "+t:""))+"&format=geojson&callback="+this._globalPointer+"._processFeatures")}}),lvector.PRWSF=lvector.GeoJSONLayer.extend({initialize:function(t){for(var e=0,o=this._requiredParams.length;o>e;e++)if(!t[this._requiredParams[e]])throw Error('No "'+this._requiredParams[e]+'" parameter found.');"/"!==t.url.substr(t.url.length-1,1)&&(t.url+="/"),lvector.Layer.prototype.initialize.call(this,t),this._globalPointer="PRWSF_"+Math.floor(1e5*Math.random()),window[this._globalPointer]=this,this._vectors=[],this.options.map&&(this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length&&(t=this.options.map.getZoom(),e=this.options.scaleRange,this.options.visibleAtScale=t>=e[0]&&t<=e[1]),this._show())},options:{geotable:null,srid:null,geomFieldName:"the_geom",fields:"",where:null,limit:null,uniqueField:null},_requiredParams:["url","geotable"],_getFeatures:function(){var t=this.options.where||"";if(!this.options.showAll){var e=this.options.map.getBounds(),o=e.getSouthWest(),e=e.getNorthEast();t+=t.length?" AND ":"",t+=this.options.srid?this.options.geomFieldName+" && transform(st_setsrid(st_makebox2d(st_point("+o.lng+","+o.lat+"),st_point("+e.lng+","+e.lat+")),4326),"+this.options.srid+")":"transform("+this.options.geomFieldName+",4326) && st_setsrid(st_makebox2d(st_point("+o.lng+","+o.lat+"),st_point("+e.lng+","+e.lat+")),4326)"}this.options.limit&&(t+=(t.length?" ":"")+"limit "+this.options.limit),o=(this.options.fields.length?this.options.fields+",":"")+"st_asgeojson(transform("+this.options.geomFieldName+",4326)) as geojson",this._makeJsonpRequest(this.options.url+"v1/ws_geo_attributequery.php?parameters="+encodeURIComponent(t)+"&geotable="+this.options.geotable+"&fields="+encodeURIComponent(o)+"&format=json&callback="+this._globalPointer+"._processFeatures")},_processFeatures:function(t){if(this.options.map){var e=this.options.map.getBounds();if((!this._lastQueriedBounds||!this._lastQueriedBounds.equals(e)||this._autoUpdateInterval)&&(this._lastQueriedBounds=e,t&&parseInt(t.total_rows)))for(e=0;e<t.rows.length;e++){t.rows[e].geometry=t.rows[e].row.geojson,delete t.rows[e].row.geojson,t.rows[e].properties=t.rows[e].row,delete t.rows[e].row;var o=!1;if(this.options.uniqueField)for(var s=0;s<this._vectors.length;s++)if(t.rows[e].properties[this.options.uniqueField]==this._vectors[s].properties[this.options.uniqueField]&&(o=!0,this.options.dynamic)&&(!this._getGeometryChanged(this._vectors[s].geometry,t.rows[e].geometry)||isNaN(t.rows[e].geometry.coordinates[0])||isNaN(t.rows[e].geometry.coordinates[1])||(this._vectors[s].geometry=t.rows[e].geometry,this._vectors[s].vector.setPosition(new L.LatLng(this._vectors[s].geometry.coordinates[1],this._vectors[s].geometry.coordinates[0]))),this._getPropertiesChanged(this._vectors[s].properties,t.rows[e].properties)&&(this._vectors[s].properties=t.rows[e].properties,this.options.infoWindowTemplate&&this._setInfoWindowContent(this._vectors[s]),this.options.symbology&&"single"!=this.options.symbology.type)))if(this._vectors[s].vector)this._vectors[s].vector.setOptions(this._getFeatureVectorOptions(this._vectors[s]));else if(this._vectors[s].vectors)for(var i=0,r=this._vectors[s].vectors.length;r>i;i++)this._vectors[s].vectors[i].setOptions(this._getFeatureVectorOptions(this._vectors[s]));if(!o||!this.options.uniqueField){if(o=this._geoJsonGeometryToLeaflet(t.rows[e].geometry,this._getFeatureVectorOptions(t.rows[e])),t.rows[e][o instanceof Array?"vectors":"vector"]=o,t.rows[e].vector)this.options.map.addLayer(t.rows[e].vector);else if(t.rows[e].vectors&&t.rows[e].vectors.length)for(i=0;i<t.rows[e].vectors.length;i++)this.options.map.addLayer(t.rows[e].vectors[i]);if(this._vectors.push(t.rows[e]),this.options.popupTemplate){var n=this,o=t.rows[e];this._setPopupContent(o),function(t){if(t.vector)t.vector.on("click",function(e){n._showPopup(t,e)});else if(t.vectors)for(var e=0,o=t.vectors.length;o>e;e++)t.vectors[e].on("click",function(e){n._showPopup(t,e)})}(o)}}}}}}),lvector.GISCloud=lvector.GeoJSONLayer.extend({initialize:function(t){for(var e=0,o=this._requiredParams.length;o>e;e++)if(!t[this._requiredParams[e]])throw Error('No "'+this._requiredParams[e]+'" parameter found.');lvector.Layer.prototype.initialize.call(this,t),this._globalPointer="GISCloud_"+Math.floor(1e5*Math.random()),window[this._globalPointer]=this,this._vectors=[],this.options.map&&(this.options.scaleRange&&this.options.scaleRange instanceof Array&&2===this.options.scaleRange.length&&(t=this.options.map.getZoom(),e=this.options.scaleRange,this.options.visibleAtScale=t>=e[0]&&t<=e[1]),this._show())},options:{mapID:null,layerID:null,uniqueField:"id"},_requiredParams:["mapID","layerID"],_getFeatures:function(){var t="http://api.giscloud.com/1/maps/"+this.options.mapID+"/layers/"+this.options.layerID+"/features.json?geometry=geojson&epsg=4326&callback="+this._globalPointer+"._processFeatures";this.options.showAll||(t+="&bounds="+this.options.map.getBounds().toBBoxString()),this.options.where&&(t+="&where="+encodeURIComponent(this.options.where)),
this._makeJsonpRequest(t)}});
//# sourceMappingURL=lvector.min.js.map