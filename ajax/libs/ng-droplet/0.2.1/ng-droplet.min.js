!function(e){"use strict";e.module("ngDroplet",[]).directive("droplet",["$rootScope","$window","$timeout",function(t,n,r){return{restrict:"EA",require:"?ngModel",scope:{directiveInterface:"=ngModel"},controller:["$scope",function(o){o.FILE_TYPES={VALID:1,INVALID:2,DELETED:4,UPLOADED:8},o.files=[],o.isUploading=!1,o.isError=!1,o.options={disableXFileSize:!1,useArray:!0},o.extensions=[],o.requestUrl="",o.requestProgress={percent:0,total:0,loaded:0},o.requestHeaders={},o.requestPostData={},o.listeners={success:function(e){e.upload.onload=function(){o.$apply(function(){o.finishedUploading(),o.forEachFile(o.FILE_TYPES.VALID,function(e){e.type=o.FILE_TYPES.UPLOADED})})}},finish:function(e,r){e.onreadystatechange=function(){4===e.readyState&&0!==e.status&&o.$apply(function(){var o=n.JSON.parse(e.responseText);t.$broadcast("$dropletUploaded",o,r)})}},error:function(e){e.upload.onerror=function(){o.$apply(function(){o.finishedUploading(),o.isError=!0})}},progress:function(e,t){e.upload.onprogress=function(e){o.$apply(function(){console.log(e.loaded),e.lengthComputable&&(o.requestProgress.percent=Math.round(e.loaded/t*100),o.requestProgress.loaded=e.loaded,o.requestProgress.total=t)})}}},function(){o.DropletModel=function(){},o.DropletModel.prototype={load:function(e,t){this.file=e,this.type=t,this.date=new n.Date,this.mimeType=e.type,this.extension=o.getExtension(e)},deleteFile:function(){o.deleteFile(this)},isImage:function(){return!!this.file.type.match(/^image\//i)}}}(),o.finishedUploading=function(){o.progress={percent:0,total:0,loaded:0},o.isUploading=!1},o.forEachFile=function(t,n){e.forEach(o.filterFiles(t||o.FILE_TYPES.VALID),function(e){n(e)})},o.addFile=function(e,t){t=t||o.FILE_TYPES.VALID;var n=new o.DropletModel;return n.load(e,t),o.files.push(n),n},o.deleteFile=function(e){e instanceof o.DropletModel||o.throwException("Method expects an instance of DropletModel"),e.type=o.FILE_TYPES.DELETED},o.filterFiles=function(e){return o.files.filter(function(t){return e&t.type})},o.getExtension=function(e){return e.name.split(".").pop().trim().toLowerCase()},o.traverseFiles=function(e){o.$apply(function(){for(var t=0,n=e.length;n>t;t++){var r=e[t],i=o.getExtension(r),s=o.FILE_TYPES.VALID;-1===o.extensions.indexOf(i)&&(s=o.FILE_TYPES.INVALID),o.addFile(r,s)}})},o.uploadFiles=function(){o.isError=!1;var t=new n.XMLHttpRequest,r=new n.FormData,i=o.filterFiles(o.FILE_TYPES.VALID),s=o.options.useArray?"file[]":"file",a=o.getRequestLength(i);t.open("post",o.requestUrl,!0),function(){o.options.disableXFileSize||t.setRequestHeader("X-File-Size",a),o.addRequestHeaders(t),o.addPostData(r)}(),function(){o.listeners.finish(t,i),o.listeners.success(t),o.listeners.progress(t,a),o.listeners.error(t)}(),e.forEach(i,function(e){r.append(s,e.file)}),o.isUploading=!0,t.send(r)},o.addRequestHeaders=function(e){for(var t in o.requestHeaders)o.requestHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,o.requestHeaders[t]);return Object.keys(o.requestHeaders)},o.addPostData=function(e){for(var t in o.requestPostData)o.requestPostData.hasOwnProperty(t)&&e.append(t,o.requestHeaders[t]);return Object.keys(o.requestPostData)},o.getRequestLength=function(t){var n=0;return e.forEach(t||o.filterFiles(o.FILE_TYPES.VALID),function(e){n+=e.file.size}),n},o.throwException=function(e){throw"ngDroplet: "+e+"."},function(){o.directiveInterface={FILE_TYPES:o.FILE_TYPES,uploadFiles:o.uploadFiles,progress:o.requestProgress,isUploading:function(){return o.isUploading},isError:o.isError,isReady:function(){return!!o.filterFiles(o.FILE_TYPES.VALID).length},addFile:o.addFile,disableXFileSize:function(){o.options.disableXFileSize=!0},useArray:function(e){o.options.useArray=!!e},setRequestUrl:function(e){o.requestUrl=e},setRequestHeaders:function(e){o.requestHeaders=e},setPostData:function(e){o.requestPostData=e},getFiles:function(e){return e?o.filterFiles(e):o.files},allowedExtensions:function(t){e.isArray(t)||o.throwException("Extensions must be an array"),o.extensions=t}},r(function(){t.$broadcast("$dropletReady")})}()}],link:function(e,t){var n=function(e){e.preventDefault(),e.stopPropagation()};t.bind("dragover dragenter dragleave",n),t.bind("drop",function(t){n(t),e.traverseFiles(t.dataTransfer.files)})}}}]).directive("dropletPreview",["$window",function(e){return{scope:{model:"=ngModel"},restrict:"E",replace:!0,template:'<img ng-show="model.isImage()" ng-src="{{imageData}}" class="droplet-preview" />',link:function(t){t.imageData="";var n=new e.FileReader;n.onload=function(e){t.$apply(function(){t.imageData=e.target.result})},t.model.isImage()&&n.readAsDataURL(t.model.file)}}}])}(window.angular);