!function(e){"use strict";e.module("ngDroplet",[]).directive("droplet",["$rootScope","$window","$timeout",function(t,i,n){return{restrict:"EA",template:'<droplet-preview ng-repeat="file in filterFiles(FILE_TYPES.VALID)" ng-model="file"></droplet-preview>',require:"?ngModel",scope:{directiveInterface:"=ngModel"},controller:["$scope",function(r){r.FILE_TYPES={VALID:1,INVALID:2,DELETED:4,UPLOADED:8},r.files=[],r.options={disableXFileSize:!1,useArray:!0},r.extensions=[],r.requestUrl="",r.requestHeaders={},r.listeners={success:function(e){e.upload.onload=function(){r.$apply(function(){r.forEachFile(r.FILE_TYPES.VALID,function(e){e.type=r.FILE_TYPES.UPLOADED})})}}},r.forEachFile=function(t,i){e.forEach(r.filterFiles(r.FILE_TYPES.VALID),function(e){i(e)})},r.registerFile=function(e){return function(t){t=t||r.FILE_TYPES.VALID;var n={file:e,type:t,added:new i.Date,mimeType:e.type,extension:r.getExtension(e)};r.files.push(n)}},r.filterFiles=function(e){return r.files.filter(function(t){return e&t.type})},r.getExtension=function(e){return e.name.split(".").pop().trim().toLowerCase()},r.traverseFiles=function(e){r.$apply(function(){for(var t=0,i=e.length;i>t;t++){var n=e[t],o=r.getExtension(n),s=r.FILE_TYPES.VALID;-1===r.extensions.indexOf(o)&&(s=r.FILE_TYPES.INVALID),r.registerFile(n)(s)}})},r.uploadFiles=function(){var t=new i.XMLHttpRequest,n=new i.FormData,o=r.filterFiles(r.FILE_TYPES.VALID),s=r.options.useArray?"file[]":"file";t.open("post",r.requestUrl,!0),e.forEach(o,function(e){n.append(s,e.file)}),r.options.disableXFileSize||t.setRequestHeader("X-File-Size",r.getRequestLength(o)),r.addRequestHeaders(t),r.listeners.success(t),t.send(n)},r.addRequestHeaders=function(e){for(var t in r.requestHeaders)r.requestHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,r.requestHeaders[t]);return Object.keys(r.requestHeaders)},r.getRequestLength=function(t){var i=0;return e.forEach(t||r.filterFiles(r.FILE_TYPES.VALID),function(e){i+=e.file.size}),i},r.throwException=function(e){throw"ngDroplet: "+e+"."},function(){r.directiveInterface={FILE_TYPES:r.FILE_TYPES,uploadFiles:r.uploadFiles,addFile:function(e,t){r.registerFile(e)(t||r.FILE_TYPES.VALID)},disableXFileSize:function(){r.options.disableXFileSize=!0},useArray:function(e){r.options.useArray=!!e},setRequestUrl:function(e){r.requestUrl=e},setRequestHeaders:function(e){r.requestHeaders=e},getFiles:function(e){return e?r.filterFiles(e):r.files},allowedExtensions:function(t){e.isArray(t)||r.throwException("Extensions must be an array"),r.extensions=t}},n(function(){t.$broadcast("$dropletReady")})}()}],link:function(e,t){var i=function(e){e.preventDefault(),e.stopPropagation()};t.bind("dragover dragenter dragleave",i),t.bind("drop",function(t){i(t),e.traverseFiles(t.dataTransfer.files)})}}}]).directive("dropletPreview",["$window",function(e){return{scope:{model:"=ngModel"},restrict:"E",replace:!0,template:'<section class="droplet-preview"><div class="extension-{{model.extension}}" ng-show="!isImage(model.file)"><label>{{model.file.name}}</label></div><img ng-show="isImage(model.file)" ng-src="{{imageData}}" class="droplet-preview" /></section>',controller:["$scope",function(e){e.isImage=function(e){return!!e.type.match(/^image\//i)}}],link:function(t){t.imageData="";var i=new e.FileReader;i.onload=function(e){t.$apply(function(){t.imageData=e.target.result})},t.isImage(t.model.file)&&i.readAsDataURL(t.model.file)}}}])}(window.angular);