!function(e){"use strict";e.module("ngDroplet",[]).directive("droplet",["$rootScope","$window","$timeout",function(t,n,i){return{restrict:"EA",template:'<droplet-preview ng-repeat="file in filterFiles(FILE_TYPES.VALID)" ng-model="file"></droplet-preview>',require:"?ngModel",scope:{directiveInterface:"=ngModel"},controller:["$scope",function(r){r.FILE_TYPES={VALID:1,INVALID:2,DELETED:4,UPLOADED:8},r.files=[],r.extensions=[],r.requestUrl="",r.requestHeaders={},r.listeners={success:function(e){e.upload.onload=function(){r.$apply(function(){r.forEachFile(r.FILE_TYPES.VALID,function(e){e.type=r.FILE_TYPES.UPLOADED})})}}},r.forEachFile=function(t,n){e.forEach(r.filterFiles(r.FILE_TYPES.VALID),function(e){n(e)})},r.registerFile=function(e){return function(t){t=t||r.FILE_TYPES.VALID;var i={file:e,type:t,added:new n.Date,mimeType:e.type,extension:r.getExtension(e)};r.files.push(i)}},r.filterFiles=function(e){return r.files.filter(function(t){return e&t.type})},r.getExtension=function(e){return e.name.split(".").pop().trim().toLowerCase()},r.traverseFiles=function(e){r.$apply(function(){for(var t=0,n=e.length;n>t;t++){var i=e[t],o=r.getExtension(i),s=r.FILE_TYPES.VALID;-1===r.extensions.indexOf(o)&&(s=r.FILE_TYPES.INVALID),r.registerFile(i)(s)}})},r.uploadFiles=function(){var t=new n.XMLHttpRequest,i=new n.FormData,o=r.filterFiles(r.FILE_TYPES.VALID);t.open("post",r.requestUrl,!0),e.forEach(o,function(e){i.append("file",e.file)}),t.setRequestHeader("X-File-Size",r.getRequestLength(o)),r.addRequestHeaders(t),r.listeners.success(t),t.send(i)},r.addRequestHeaders=function(e){for(var t in r.requestHeaders)r.requestHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,r.requestHeaders[t]);return Object.keys(r.requestHeaders)},r.getRequestLength=function(t){var n=0;return e.forEach(t||r.filterFiles(r.FILE_TYPES.VALID),function(e){n+=e.file.size}),n},r.throwException=function(e){throw"ngDroplet: "+e+"."},function(){r.directiveInterface={FILE_TYPES:r.FILE_TYPES,uploadFiles:r.uploadFiles,addFile:function(e,t){r.registerFile(e)(t||r.FILE_TYPES.VALID)},setRequestUrl:function(e){r.requestUrl=e},setRequestHeaders:function(e){r.requestHeaders=e},getFiles:function(e){return e?r.filterFiles(e):r.files},allowedExtensions:function(t){e.isArray(t)||r.throwException("Extensions must be an array"),r.extensions=t}},i(function(){t.$broadcast("$dropletReady")})}()}],link:function(e,t){var n=function(e){e.preventDefault(),e.stopPropagation()};t.bind("dragover dragenter dragleave",n),t.bind("drop",function(t){n(t),e.traverseFiles(t.dataTransfer.files)})}}}]).directive("dropletPreview",["$window",function(e){return{scope:{model:"=ngModel"},restrict:"E",replace:!0,template:'<section class="droplet-preview"><div class="extension-{{model.extension}}" ng-show="!isImage(model.file)"><label>{{model.file.name}}</label></div><img ng-show="isImage(model.file)" ng-src="{{imageData}}" class="droplet-preview" /></section>',controller:["$scope",function(e){e.isImage=function(e){return!!e.type.match(/^image\//i)}}],link:function(t){t.imageData="";var n=new e.FileReader;n.onload=function(e){t.$apply(function(){t.imageData=e.target.result})},t.isImage(t.model.file)&&n.readAsDataURL(t.model.file)}}}])}(window.angular);