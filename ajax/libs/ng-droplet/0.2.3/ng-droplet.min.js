!function(e){"use strict";var t=e.module("ngDroplet",[]).directive("droplet",["$rootScope","$window","$timeout","$q",function(t,i,r,n){return{restrict:"EA",require:"?ngModel",scope:{directiveInterface:"=ngModel"},controller:["$scope",function(s){s.FILE_TYPES={VALID:1,INVALID:2,DELETED:4,UPLOADED:8},s.files=[],s.isUploading=!1,s.isError=!1,s.options={disableXFileSize:!1,useArray:!0},s.extensions=[],s.requestUrl="",s.requestProgress={percent:0,total:0,loaded:0},s.requestHeaders={},s.requestPostData={},s.listeners={files:[],httpRequest:{},deferred:{},success:function(){this.httpRequest.upload.onload=function(){s.$apply(function(){s.finishedUploading(),s.forEachFile(s.FILE_TYPES.VALID,function(e){e.type=s.FILE_TYPES.UPLOADED})})}}.bind(this),finish:function(){this.httpRequest.onreadystatechange=function(){4===this.httpRequest.readyState&&0!==this.httpRequest.status&&s.$apply(function(){var e=i.JSON.parse(this.httpRequest.responseText);t.$broadcast("$dropletSuccess",e,this.files),this.deferred.resolve(e,this.files)}.bind(this))}.bind(this)},error:function(){this.httpRequest.upload.onerror=function(){s.$apply(function(){s.finishedUploading(),s.isError=!0;var e=i.JSON.parse(this.httpRequest.responseText);t.$broadcast("$dropletError",e),this.deferred.reject(e)}.bind(this))}},progress:function(){var e=s.getRequestLength(this.files);this.httpRequest.upload.onprogress=function(t){s.$apply(function(){t.lengthComputable&&(s.requestProgress.percent=Math.round(t.loaded/e*100),s.requestProgress.loaded=t.loaded,s.requestProgress.total=e)})}}},function(){s.DropletModel=function(){},s.DropletModel.prototype={load:function(e,t){this.file=e,this.type=t,this.date=new i.Date,this.mimeType=e.type,this.extension=s.getExtension(e)},deleteFile:function(){s.deleteFile(this)},isImage:function(){return!!this.file.type.match(/^image\//i)}}}(),s.finishedUploading=function(){s.progress={percent:0,total:0,loaded:0},s.isUploading=!1},s.forEachFile=function(t,i){e.forEach(s.filterFiles(t||s.FILE_TYPES.VALID),function(e){i(e)})},s.addFile=function(e,t){t=t||s.FILE_TYPES.VALID;var i=new s.DropletModel;return i.load(e,t),s.files.push(i),i},s.deleteFile=function(e){e instanceof s.DropletModel||s.throwException("Method expects an instance of DropletModel"),e.type=s.FILE_TYPES.DELETED},s.filterFiles=function(e){return s.files.filter(function(t){return e&t.type})},s.getExtension=function(e){return e.name.split(".").pop().trim().toLowerCase()},s.traverseFiles=function(e){s.$apply(function(){for(var t=0,i=e.length;i>t;t++){var r=e[t],n=s.getExtension(r),o=s.FILE_TYPES.VALID;-1===s.extensions.indexOf(n)&&(o=s.FILE_TYPES.INVALID),s.addFile(r,o)}})},s.uploadFiles=function(){s.isError=!1;var t=new i.XMLHttpRequest,r=new i.FormData,o=s.filterFiles(s.FILE_TYPES.VALID),a=s.options.useArray?"file[]":"file",l=s.getRequestLength(o),u=n.defer();return t.open("post",s.requestUrl,!0),function(){s.options.disableXFileSize||t.setRequestHeader("X-File-Size",l),s.addRequestHeaders(t),s.addPostData(r)}(),function(){s.listeners.files=o,s.listeners.deferred=u,s.listeners.httpRequest=t,s.listeners.progress(),s.listeners.success(),s.listeners.error(),s.listeners.finish()}(),e.forEach(o,function(e){r.append(a,e.file)}),s.isUploading=!0,t.send(r),u.promise},s.addRequestHeaders=function(e){for(var t in s.requestHeaders)s.requestHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,s.requestHeaders[t]);return Object.keys(s.requestHeaders)},s.addPostData=function(e){for(var t in s.requestPostData)s.requestPostData.hasOwnProperty(t)&&e.append(t,s.requestHeaders[t]);return Object.keys(s.requestPostData)},s.getRequestLength=function(t){var i=0;return e.forEach(t||s.filterFiles(s.FILE_TYPES.VALID),function(e){i+=e.file.size}),i},s.throwException=function(e){throw"ngDroplet: "+e+"."},function(){s.directiveInterface={FILE_TYPES:s.FILE_TYPES,uploadFiles:s.uploadFiles,progress:s.requestProgress,isUploading:function(){return s.isUploading},isError:function(){return s.isError},isReady:function(){return!!s.filterFiles(s.FILE_TYPES.VALID).length},addFile:s.addFile,traverseFiles:s.traverseFiles,disableXFileSize:function(){s.options.disableXFileSize=!0},useArray:function(e){s.options.useArray=!!e},setRequestUrl:function(e){s.requestUrl=e},setRequestHeaders:function(e){s.requestHeaders=e},setPostData:function(e){s.requestPostData=e},getFiles:function(e){return e?s.filterFiles(e):s.files},allowedExtensions:function(t){e.isArray(t)||s.throwException("Extensions must be an array"),s.extensions=t}},r(function(){t.$broadcast("$dropletReady")})}()}],link:function(e,t){var i=function(e){e.preventDefault(),e.stopPropagation()};t.bind("dragover dragenter dragleave",i),t.bind("drop",function(t){i(t),e.traverseFiles(t.dataTransfer.files)})}}}]).directive("dropletPreview",["$window",function(e){return{scope:{model:"=ngModel"},restrict:"E",replace:!0,template:'<img ng-show="model.isImage()" ng-src="{{imageData}}" class="droplet-preview" />',link:function(t){t.imageData="";var i=new e.FileReader;i.onload=function(e){t.$apply(function(){t.imageData=e.target.result})},t.model.isImage()&&i.readAsDataURL(t.model.file)}}}]);!function(){var e=function(e,i){t.directive(e,function(){return{restrict:"EA",require:"ngModel",replace:!0,template:i,scope:{"interface":"=ngModel"},link:function(e,t){t.bind("change",function(){e.interface.traverseFiles(t[0].files)})}}})};e("dropletUploadSingle",'<input type="file" />'),e("dropletUploadMultiple",'<input type="file" multiple="multiple" />')}()}(window.angular);