var UniBox=function(){var y=-1;var s;var e;var h;var f="";var n="";var D=-80;var F;var a;var k=[];var M=true;var p;var q=300;var m="";var l=2;var v;var t;var K;var d;var c;var A;var L=[];var r="all";var z=-1;var x="";var b=false;var J=[];var i=[];var u=undefined;function I(O){if(O!==undefined){var P=s.val();if(O.keyCode==9||O.keyCode==27||O.keyCode==13||P.length<l){w();if(O.keyCode==13&&v!=undefined&&y==-1){v.call(this,P)}y=-1}}else{w();y=-1}}function w(){h.removeClass("uniboxActive");h.slideUp(q)}function E(P,O){var Q=null;return function(){var S=this,R=arguments;clearTimeout(Q);Q=window.setTimeout(function(){P.apply(S,R)},O||50)}}function G(P,O){if(!M){return P}var V=O.split(" ");V.sort(function(X,W){return W.length-X.length});var U={};jQuery.each(V,function(W,ab){if(ab.length<1){return}ab=ab.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var aa=P.match(new RegExp("(("+ab+")(?!#<##|-\\d+#<##))(?!.*\\1)","gi"));if(aa!=null){for(var Z=0;Z<aa.length;Z++){var Y=aa[Z];var X=Y.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");P=P.replace(new RegExp("("+X+")(?!#<##|-\\d+#<##)","g"),"##>#"+W+"-"+Z+"#<##");U["##>#"+W+"-"+Z+"#<##"]='<span class="unibox-highlight">'+Y+"</span>"}}});var S=Object.keys(U).reverse();for(var Q=0;Q<S.length;Q++){var T=S[Q];var R=U[T];P=P.replace(new RegExp(T,"gi"),R)}return P}function N(S){if(z==13){I();return}var O=s.val();h.html("");var Q=false;var R=Object.keys(S.suggests);if(J&&J.length>0){R=J;jQuery.each(Object.keys(S.suggests),function(T,U){if(jQuery.inArray(U,R)<0){R.push(U)}})}jQuery.each(R,function(T,W){var V=S.suggests[W];if(!V){return true}var U=0;jQuery.each(R,function(Z,ab){var aa=S.suggests[ab];if(!aa||W===ab||aa.length==0){return true}U+=aa.length});var Y=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+W+" "+("unibox-"+V.length+"-entries")+" "+(U==0?"unibox-single-suggestion-block":"")+'"></div>');if(W.replace(/_/,"").length>0&&V.length>0){var X=jQuery("<h4>"+W+"</h4>");Y.append(X)}jQuery.each(V,function(ah,af){var ae='<div class="unibox-selectable">';if(af.image!=undefined){var aj=af.image.length===0&&F?F:af.image.length===0||af.image.indexOf("/")===0||af.image.indexOf("http")===0?af.image:n+af.image;ae+='<div class="unibox-selectable-img-container"><img src="'+aj+'"/></div>'}if(af.link!=undefined){ae+='<a href="'+af.link+'">';ae+=G(af.name,O);ae+="</a>"}else{ae+="<span>"+G(af.name,O)+"</span>"}if(p!=undefined){var ag=p.match(/##(.*?)##/gi);var ad=p;var ac=false;for(var aa in ag){var ab=ag[aa].replace(/#/g,"");var Z=af[ab];if(Z==undefined){ac=true;continue}var ak=new RegExp(ag[aa],"g");ad=ad.replace(ak,Z)}if(!ac){ae+='<div class="unibox-extra">'+ad+"</div>"}}ae+='<div class="unibox-ca"></div></div>';var ai=jQuery(ae);Y.append(ai);Q=true});h.append(Y)});if(i&&i.length>0){k=[];jQuery.each(i,function(T,U){k=k.concat(e.find(".unibox-suggest-"+U+":first .unibox-selectable").get())})}else{k=e.find(".unibox-selectable")}y=-1;jQuery(k).mousedown(function(){var U=jQuery(this).text();s.val(U);var T=undefined;try{T=jQuery(this).find("a:first").attr("href")}catch(V){}if(t!=undefined){t.call(this,U,T)}I()});e.find(".unibox-selectable .unibox-extra").click(function(T){T.stopPropagation()});if(S.words.length>0&&m.length>0&&(r=="all"||r=="bottom")){h.append("<h4>"+m+"</h4>");Q=true}var P=[];jQuery.each(S.words,function(U,X){if((r=="all"||r=="bottom")){if(X.overlayImage!=undefined){h.append('<img class="unibox-vis" src="'+n+X.overlayImage+'" style="background-image: url(\''+n+X.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(X.image!=undefined){h.append('<img class="unibox-vis" src="'+n+X.image+'">')}}}var W=e.find("#unibox-invisible");W.html(O.replace(new RegExp(X.name,"gi"),"<span>"+X.name+"</span>"));if((r=="all"||r=="top")&&jQuery.inArray(X.image,L)==-1){var V=e.find("#unibox-invisible span")[0];if(V!=undefined&&X.name.length>0&&X.image!=undefined){var T=jQuery(V).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+n+X.image+'" alt="'+X.name+'"></div>');visImage.css("left",j().left+T-10);visImage.css("top",j().top-s.outerHeight()+D);e.append(visImage);setTimeout(function(){e.find(".unibox-ivf").find("img").addClass("l")},10);P.push(X.image)}}else{if(jQuery.inArray(X.image,L)>-1){P.push(X.image)}}});L=P;jQuery("img").error(function(){if(F){jQuery(this).attr("src",F)}else{jQuery(this).hide()}});g();if(Q){if(h.is(":visible")){h.addClass("uniboxActive");h.css("left",j().left);h.css("top",j().top)}else{h.slideDown(q,function(){h.addClass("uniboxActive");h.css("left",j().left);h.css("top",j().top)})}}else{I()}}function j(){return{left:s.offset().left-e.offset().left,top:s.offset().top-e.offset().top+s.outerHeight()}}function C(){var P=e.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var O=0;O<P.length;O++){if(jQuery.inArray(P[O].replace(n,""),L)==-1){e.find('.unibox-ivf:has(img[src*="'+P[O]+'"])').remove()}}}function o(){L=[];e.find(".unibox-ivf").remove()}function H(Q){if(s.val().length<=1){o()}if(K!=undefined){K.call(this,s.val())}if(Q.keyCode!=38&&Q.keyCode!=40&&Q.keyCode!=13){C();return}if(Q.keyCode==38&&y>0){y--}else{if(Q.keyCode==40){y++}else{if(Q.keyCode==38&&y<=0){y=((y!=-1)?y-1:y)+k.length}}}if(k.length>0&&y>-1){y=y%k.length;jQuery(k).removeClass("active");var P=jQuery(k[y]);P.addClass("active")}if(Q.keyCode==13){if(t!=undefined){var S=s.val();var O=undefined;if(y!=-1){S=jQuery(e.find(".unibox-selectable.active")[0]).text();s.val(S);try{O=jQuery(e.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(R){}if(t!=undefined){t.call(this,S,O)}}}else{if(y!=-1){window.location.href=jQuery(e.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function B(O){if(z==18){z=O.keyCode;return}z=O.keyCode;if(O.keyCode==38||O.keyCode==40||O.keyCode==13||O.keyCode==9){return}var P=s.val();if(z==46&&P.length==0){o()}if(P.length>=l){x=P;jQuery.ajax({usedQuery:P,url:f+encodeURIComponent(P),dataType:"json",success:function(Q){if(this.usedQuery==x){N(Q)}}})}}function g(){var P=jQuery("#unibox-suggest-box");var O=P.css("border-width").replace("px","");P.css("min-width",s.outerWidth()-2*O);if(u==undefined){P.css("max-width",s.outerWidth()-2*O)}else{P.css("max-width",u-2*O)}P.css("left",j().left);P.css("top",j().top)}return{updateSuggestUrl:function(O){f=O},hideSuggestBox:function(){I()},setIvfImagePath:function(O){n=O;if(n.charAt(n.length-1)!="/"){n+="/"}},changeInstantVisualFeedbackState:function(O){r=O},render:function(){g()},init:function(ab,ad){s=ab;e=ad.searchBoxContainer;M=ad.highlight;p=ad.extraHtml;f=ad.suggestUrl;n=ad.ivfImagePath;D=ad.ivfImageOffset;F=ad.missingErrorImage;a=ad.throttleTime;q=ad.animationSpeed;l=ad.minChars;v=ad.enterCallback;t=ad.enterCallbackResult;K=ad.typeCallback;d=ad.focusCallback;c=ad.blurCallback;A=ad.placeholder;r=ad.instantVisualFeedback;m=ad.queryVisualizationHeadline;b=ad.showDeleteAllButton;J=ad.suggestOrder;i=ad.suggestSelectionOrder;u=ad.maxWidth;s.attr("autocomplete","off");h=jQuery('<div id="unibox-suggest-box"></div>');e.prepend(h);var Z=e.css("position");if(Z!="absolute"){e.css("position","relative")}var U=h.css("border-width").replace("px","");h.css("min-width",s.outerWidth()-2*U);h.css("max-width",ad.maxWidth-2*U);s.keydown(H);s.keydown(E(B,a));s.keyup(I);s.focusout(function(){w();if(c!=undefined){c.call(this,jQuery(this).val())}});s.focus(function(ae){ae.stopPropagation();if(jQuery(this).val().length>0){B({keyCode:-1})}if(d!=undefined){d.call(this,jQuery(this).val())}});h.mouseenter(function(){h.find(".unibox-selectable.active").removeClass("active")});jQuery("html").click(function(){w()});s.click(function(ae){ae.stopPropagation()});h.click(function(ae){ae.stopPropagation()});var P=s.attr("placeholder");A=P&&P.length>0?P:A;if(A&&A.length>0){var W=document.createElement("input");if(!("placeholder" in W)){s.focus(function(){var ae=jQuery(this).attr("placeholder");if((ae)&&(ae.length>0)&&(ae!="")&&jQuery(this).val()==ae){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var ae=jQuery(this).attr("placeholder");if((ae)&&(ae.length>0)&&(ae!="")&&(jQuery(this).val()==""||jQuery(this).val()==ae)){jQuery(this).val(ae).addClass("hasPlaceholder")}});s.val(A)}s.attr("placeholder",A)}var ac=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');e.append(ac);if(b){var aa=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');e.append(aa);jQuery(aa).mousedown(function(ae){(ae||window.event).stopPropagation();s.val("");s.focus();return false});s.focus(function(){if(s.val().length>0){aa.show()}else{aa.hide()}}).blur(function(){aa.hide()}).keydown(function(){if(jQuery(this).val().length>0){jQuery(aa).show()}});var Y=parseInt(s.css("paddingTop").replace("px","").trim());var X=s.outerHeight();var V=parseInt(s.css("borderTopWidth").replace("px","").trim());var S=s.css("boxShadow").match(/\d{1,3}px/g);var R=(S&&S.length>2)?parseInt(S[2].replace("px","").trim()):0;aa.height(X-(2*V)-R-Y);var O=parseInt(s.css("paddingRight").replace("px","").trim());O=(O>25)?O:25;s.css("paddingRight",O);var T=V+R+(s.offset().top-s.parent().offset().top-s.parent().scrollTop());var Q=Math.abs(s[0].getBoundingClientRect().left-s.parent()[0].getBoundingClientRect().left)+s.outerWidth()-aa.outerWidth()-V-O;aa.css("top",T);aa.css("left",Q)}if(r=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var c=this.map(function(e,h){h=a(h);var f=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,typeCallback:undefined,focusCallback:undefined,blurCallback:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:h.outerWidth(),showDeleteAllButton:false,suggestOrder:[],suggestSelectionOrder:[]},b);if(f.searchBoxContainerSelector==undefined){f.searchBoxContainer=h.parent()}else{f.searchBoxContainer=a(f.searchBoxContainerSelector)}var g=new UniBox();g.init(h,f);return g});var d=a.makeArray(c);if(d.length==1){return d[0]}return d}}(jQuery));