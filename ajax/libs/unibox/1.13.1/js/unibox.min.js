var UniBox=function(){var y=-1;var s;var e;var h;var f="";var n="";var D=-80;var F;var a;var k=[];var L=true;var p;var q=300;var m="";var l=2;var v;var t;var J;var d;var c;var A;var K=[];var r="all";var z=-1;var x="";var b=false;var I=[];var i=[];var u=undefined;function w(N){if(N!==undefined){var O=s.val();if(N.keyCode==9||N.keyCode==27||N.keyCode==13||O.length<l){h.slideUp(q);if(N.keyCode==13&&v!=undefined&&y==-1){v.call(this,O)}y=-1}}else{h.slideUp(q);y=-1}}function E(O,N){var P=null;return function(){var R=this,Q=arguments;clearTimeout(P);P=window.setTimeout(function(){O.apply(R,Q)},N||50)}}function G(O,N){if(!L){return O}var U=N.split(" ");U.sort(function(W,V){return V.length-W.length});var T={};jQuery.each(U,function(V,Z){if(Z.length<1){return}var Y=O.match(new RegExp("(("+Z+")(?!#<##|-\\d+#<##))(?!.*\\1)","gi"));if(Y!=null){for(var X=0;X<Y.length;X++){var W=Y[X];O=O.replace(new RegExp("("+W+")(?!#<##|-\\d+#<##)","g"),"##>#"+V+"-"+X+"#<##");T["##>#"+V+"-"+X+"#<##"]='<span class="unibox-highlight">'+W+"</span>"}}});var R=Object.keys(T).reverse();for(var P=0;P<R.length;P++){var S=R[P];var Q=T[S];O=O.replace(new RegExp(S,"gi"),Q)}return O}function M(R){if(z==13){w();return}var N=s.val();h.html("");var P=false;var Q=Object.keys(R.suggests);if(I&&I.length>0){Q=I;jQuery.each(Object.keys(R.suggests),function(S,T){if(jQuery.inArray(T,Q)<0){Q.push(T)}})}jQuery.each(Q,function(S,V){var U=R.suggests[V];if(!U){return true}var T=0;jQuery.each(Q,function(Y,aa){var Z=R.suggests[aa];if(!Z||V===aa||Z.length==0){return true}T+=Z.length});var X=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+V+" "+("unibox-"+U.length+"-entries")+" "+(T==0?"unibox-single-suggestion-block":"")+'"></div>');if(V.replace(/_/,"").length>0&&U.length>0){var W=jQuery("<h4>"+V+"</h4>");X.append(W)}jQuery.each(U,function(ag,ae){var ad='<div class="unibox-selectable">';if(ae.image!=undefined){var ai=ae.image.length===0&&F?F:ae.image.length===0||ae.image.indexOf("/")===0||ae.image.indexOf("http")===0?ae.image:n+ae.image;ad+='<div class="unibox-selectable-img-container"><img src="'+ai+'"/></div>'}if(ae.link!=undefined){ad+='<a href="'+ae.link+'">';ad+=G(ae.name,N);ad+="</a>"}else{ad+="<span>"+G(ae.name,N)+"</span>"}if(p!=undefined){var af=p.match(/##(.*?)##/gi);var ac=p;var ab=false;for(var Z in af){var aa=af[Z].replace(/#/g,"");var Y=ae[aa];if(Y==undefined){ab=true;continue}var aj=new RegExp(af[Z],"g");ac=ac.replace(aj,Y)}if(!ab){ad+='<div class="unibox-extra">'+ac+"</div>"}}ad+='<div class="unibox-ca"></div></div>';var ah=jQuery(ad);X.append(ah);P=true});h.append(X)});if(i&&i.length>0){k=[];jQuery.each(i,function(S,T){k=k.concat(e.find(".unibox-suggest-"+T+":first .unibox-selectable").get())})}else{k=e.find(".unibox-selectable")}y=-1;jQuery(k).mousedown(function(){var T=jQuery(this).text();s.val(T);var S=undefined;try{S=jQuery(this).find("a:first").attr("href")}catch(U){}if(t!=undefined){t.call(this,T,S)}w()});e.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(R.words.length>0&&m.length>0&&(r=="all"||r=="bottom")){h.append("<h4>"+m+"</h4>");P=true}var O=[];jQuery.each(R.words,function(T,W){if((r=="all"||r=="bottom")){if(W.overlayImage!=undefined){h.append('<img class="unibox-vis" src="'+n+W.overlayImage+'" style="background-image: url(\''+n+W.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(W.image!=undefined){h.append('<img class="unibox-vis" src="'+n+W.image+'">')}}}var V=e.find("#unibox-invisible");V.html(N.replace(new RegExp(W.name,"gi"),"<span>"+W.name+"</span>"));if((r=="all"||r=="top")&&jQuery.inArray(W.image,K)==-1){var U=e.find("#unibox-invisible span")[0];if(U!=undefined&&W.name.length>0&&W.image!=undefined){var S=jQuery(U).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+n+W.image+'" alt="'+W.name+'"></div>');visImage.css("left",j().left+S-10);visImage.css("top",j().top-s.outerHeight()+D);e.append(visImage);setTimeout(function(){e.find(".unibox-ivf").find("img").addClass("l")},10);O.push(W.image)}}else{if(jQuery.inArray(W.image,K)>-1){O.push(W.image)}}});K=O;jQuery("img").error(function(){if(F){jQuery(this).attr("src",F)}else{jQuery(this).hide()}});g();if(P){h.slideDown(q,function(){h.css("left",j().left);h.css("top",j().top)})}else{w()}}function j(){return{left:s.offset().left-e.offset().left,top:s.offset().top-e.offset().top+s.outerHeight()}}function C(){var O=e.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var N=0;N<O.length;N++){if(jQuery.inArray(O[N].replace(n,""),K)==-1){e.find('.unibox-ivf:has(img[src*="'+O[N]+'"])').remove()}}}function o(){K=[];e.find(".unibox-ivf").remove()}function H(P){if(s.val().length<=1){o()}if(J!=undefined){J.call(this,s.val())}if(P.keyCode!=38&&P.keyCode!=40&&P.keyCode!=13){C();return}if(P.keyCode==38&&y>0){y--}else{if(P.keyCode==40){y++}else{if(P.keyCode==38&&y<=0){y=((y!=-1)?y-1:y)+k.length}}}if(k.length>0&&y>-1){y=y%k.length;jQuery(k).removeClass("active");var O=jQuery(k[y]);O.addClass("active")}if(P.keyCode==13){if(t!=undefined){var R=s.val();var N=undefined;if(y!=-1){R=jQuery(e.find(".unibox-selectable.active")[0]).text();s.val(R);try{N=jQuery(e.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(Q){}if(t!=undefined){t.call(this,R,N)}}}else{if(y!=-1){window.location.href=jQuery(e.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function B(N){if(z==18){z=N.keyCode;return}z=N.keyCode;if(N.keyCode==38||N.keyCode==40||N.keyCode==13||N.keyCode==9){return}var O=s.val();if(z==46&&O.length==0){o()}if(O.length>=l){x=O;jQuery.ajax({usedQuery:O,url:f+encodeURIComponent(O),dataType:"json",success:function(P){if(this.usedQuery==x){M(P)}}})}}function g(){var O=jQuery("#unibox-suggest-box");var N=O.css("border-width").replace("px","");O.css("min-width",s.outerWidth()-2*N);if(u==undefined){O.css("max-width",s.outerWidth()-2*N)}else{O.css("max-width",u-2*N)}O.css("left",j().left);O.css("top",j().top)}return{updateSuggestUrl:function(N){f=N},hideSuggestBox:function(){w()},setIvfImagePath:function(N){n=N;if(n.charAt(n.length-1)!="/"){n+="/"}},changeInstantVisualFeedbackState:function(N){r=N},render:function(){g()},init:function(aa,ac){s=aa;e=ac.searchBoxContainer;L=ac.highlight;p=ac.extraHtml;f=ac.suggestUrl;n=ac.ivfImagePath;D=ac.ivfImageOffset;F=ac.missingErrorImage;a=ac.throttleTime;q=ac.animationSpeed;l=ac.minChars;v=ac.enterCallback;t=ac.enterCallbackResult;J=ac.typeCallback;d=ac.focusCallback;c=ac.blurCallback;A=ac.placeholder;r=ac.instantVisualFeedback;m=ac.queryVisualizationHeadline;b=ac.showDeleteAllButton;I=ac.suggestOrder;i=ac.suggestSelectionOrder;u=ac.maxWidth;s.attr("autocomplete","off");h=jQuery('<div id="unibox-suggest-box"></div>');e.append(h);var Y=e.css("position");if(Y!="absolute"){e.css("position","relative")}var T=h.css("border-width").replace("px","");h.css("min-width",s.outerWidth()-2*T);h.css("max-width",ac.maxWidth-2*T);s.keydown(H);s.keydown(E(B,a));s.keyup(w);s.focusout(function(){h.slideUp(q);if(c!=undefined){c.call(this,jQuery(this).val())}});s.focus(function(){if(d!=undefined){d.call(this,jQuery(this).val())}});h.mouseenter(function(){h.find(".unibox-selectable.active").removeClass("active")});jQuery("html").click(function(){h.slideUp(q)});h.click(function(ad){ad.stopPropagation()});var O=s.attr("placeholder");A=O&&O.length>0?O:A;if(A&&A.length>0){var V=document.createElement("input");if(!("placeholder" in V)){s.focus(function(){var ad=jQuery(this).attr("placeholder");if((ad)&&(ad.length>0)&&(ad!="")&&jQuery(this).val()==ad){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var ad=jQuery(this).attr("placeholder");if((ad)&&(ad.length>0)&&(ad!="")&&(jQuery(this).val()==""||jQuery(this).val()==ad)){jQuery(this).val(ad).addClass("hasPlaceholder")}});s.val(A)}s.attr("placeholder",A)}var ab=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');e.append(ab);if(b){var Z=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');e.append(Z);jQuery(Z).mousedown(function(ad){(ad||window.event).stopPropagation();s.val("");s.focus();return false});s.focus(function(){if(s.val().length>0){Z.show()}else{Z.hide()}}).blur(function(){Z.hide()}).keydown(function(){if(jQuery(this).val().length>0){jQuery(Z).show()}});var X=parseInt(s.css("paddingTop").replace("px","").trim());var W=s.outerHeight();var U=parseInt(s.css("borderTopWidth").replace("px","").trim());var R=s.css("boxShadow").match(/\d{1,3}px/g);var Q=(R&&R.length>2)?parseInt(R[2].replace("px","").trim()):0;Z.height(W-(2*U)-Q-X);var N=parseInt(s.css("paddingRight").replace("px","").trim());N=(N>25)?N:25;s.css("paddingRight",N);var S=U+Q+(s.offset().top-s.parent().offset().top-s.parent().scrollTop());var P=Math.abs(s[0].getBoundingClientRect().left-s.parent()[0].getBoundingClientRect().left)+s.outerWidth()-Z.outerWidth()-U-N;Z.css("top",S);Z.css("left",P)}if(r=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var c=this.map(function(e,h){h=$(h);var f=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,typeCallback:undefined,focusCallback:undefined,blurCallback:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:h.outerWidth(),showDeleteAllButton:false,suggestOrder:[],suggestSelectionOrder:[]},b);if(f.searchBoxContainerSelector==undefined){f.searchBoxContainer=h.parent()}else{f.searchBoxContainer=$(f.searchBoxContainerSelector)}var g=new UniBox();g.init(h,f);return g});var d=a.makeArray(c);if(d.length==1){return d[0]}return d}}(jQuery));