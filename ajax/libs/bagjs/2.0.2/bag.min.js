!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():e.Bag=t()}(this,function(){"use strict";function e(e){return Object.prototype.toString.call(e)}function t(t){return"[object String]"===e(t)}function n(t){return"[object Function]"===e(t)}function r(e,t){if(d(e)){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n++)t(e[n],n,e)}else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(e[r],r)}function o(e,t){return r(t,function(n,r){e[r]||(e[r]=t[r])}),e}function i(e,t){if(!t)return e;var n=!1;e.then(function(e){setTimeout(function(){n||(n=!0,t(null,e))},0)},function(e){setTimeout(function(){n||(n=!0,t(e))},0)})}function u(e){var t=this,n=e+"__";this.init=function(){return p.resolve()},this.remove=function(e){return localStorage.removeItem(n+e),p.resolve()},this.set=function(e,o,i){var u={value:o,expire:i};return new p(function(o,i){try{localStorage.setItem(n+e,JSON.stringify(u)),o()}catch(c){if(c.name.toUpperCase().indexOf("QUOTA")>=0)try{r(localStorage,function(e,r){var o=r.split(n)[1];o&&t.remove(o)}),localStorage.setItem(n+e,JSON.stringify(u)),o()}catch(a){i(a)}else i(c)}})},this.get=function(e,t){return new p(function(r,o){try{var i=localStorage.getItem(n+e);if(null===i)return r();i=JSON.parse(localStorage.getItem(n+e)),r(i=t?i:i.value)}catch(u){o(new Error("Can't read key: "+e))}})},this.clear=function(e){var o=+new Date,i=p.resolve();return r(localStorage,function(r,u){var c=u.split(n)[1];if(c)return e?void(i=i.then(function(){return t.get(c,!0).then(function(e){e&&e.expire>0&&e.expire-o<0&&t.remove(c)})})):void(i=i.then(function(){t.remove(c)}))}),i}}function c(e){var t;this.init=function(){return new p(function(n,r){return(t=window.openDatabase(e,"1.0","bag.js db",2e5))?void t.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS kv (key TEXT PRIMARY KEY, value TEXT, expire INTEGER KEY)",[],function(){n()},function(e,t){r(t)})}):void r("Can't open websql database")})},this.remove=function(e){return new p(function(n,r){t.transaction(function(t){t.executeSql("DELETE FROM kv WHERE key = ?",[e],function(){n()},function(e,t){r(t)})})})},this.set=function(e,n,r){return new p(function(o,i){t.transaction(function(t){t.executeSql("INSERT OR REPLACE INTO kv (key, value, expire) VALUES (?, ?, ?)",[e,JSON.stringify(n),r],function(){o()},function(e,t){i(t)})})})},this.get=function(e){return new p(function(n,r){t.readTransaction(function(t){t.executeSql("SELECT value FROM kv WHERE key = ?",[e],function(e,t){if(0===t.rows.length)return n();var o=t.rows.item(0).value;try{n(JSON.parse(o))}catch(i){r(new Error("Can't unserialise data: "+o))}},function(e,t){r(t)})})})},this.clear=function(e){return new p(function(n,r){t.transaction(function(t){t.executeSql(e?"DELETE FROM kv WHERE expire > 0 AND expire < ?":"DELETE FROM kv",e?[+new Date]:[],function(){n()},function(e,t){r(t)})})})}}function a(e){var t;this.init=function(){return new p(function(n,r){var o=window.indexedDB,i=o.open(e,2);i.onsuccess=function(e){t=e.target.result,n()},i.onblocked=function(e){r(new Error("IndexedDB blocked. "+e.target.errorCode))},i.onerror=function(e){r(new Error("IndexedDB opening error. "+e.target.errorCode))},i.onupgradeneeded=function(e){t=e.target.result,t.objectStoreNames.contains("kv")&&t.deleteObjectStore("kv");var n=t.createObjectStore("kv",{keyPath:"key"});n.createIndex("expire","expire",{unique:!1})}})},this.remove=function(e){return new p(function(n,r){var o=t.transaction("kv","readwrite");o.oncomplete=function(){n()},o.onerror=o.onabort=function(e){r(e.target)},o.objectStore("kv")["delete"](e).onerror=function(){o.abort()}})},this.set=function(e,n,r){return new p(function(o,i){var u=t.transaction("kv","readwrite");u.oncomplete=function(){o()},u.onerror=u.onabort=function(e){i(e.target)},u.objectStore("kv").put({key:e,value:n,expire:r}).onerror=function(){u.abort()}})},this.get=function(e){return new p(function(n,r){var o=t.transaction("kv");o.onerror=o.onabort=function(e){r(new Error("Key get error: "+e.target))},o.objectStore("kv").get(e).onsuccess=function(e){e.target.result?n(e.target.result.value):n()}})},this.clear=function(e){return new p(function(n,r){var o=window.IDBKeyRange,i=t.transaction("kv","readwrite"),u=i.objectStore("kv");if(i=t.transaction("kv","readwrite"),u=i.objectStore("kv"),i.oncomplete=function(){n()},i.onerror=i.onabort=function(e){r(new Error("Clear error: ",e.target))},e){var c=u.index("expire").openCursor(o.bound(1,+new Date));return void(c.onsuccess=function(e){var t=e.target.result;t&&(u["delete"](t.primaryKey).onerror=function(){i.abort()},t["continue"]())})}i.objectStore("kv").clear().onerror=function(){i.abort()}})}}function s(e,t){function o(){return p.resolve().then(function(){if(!a)throw new Error("No available db");return a.init().then(function(){s=!0,a.clear(!0)})})}function u(){var e=Array.prototype.slice.call(arguments,1),t=arguments[0];return s?a[t].apply(a,e):c.init().then(function(){return a[t].apply(a,e)})}var c=this,a=null,s=!1;r(t,function(n){if(n=n.toLowerCase(),!h[n])throw new Error("Wrong storage adapter name: "+n,t);return h[n].exists()&&!a?(a=new h[n](e),!1):void 0}),a||"undefined"!=typeof console&&console.log&&console.log("None of requested storages available: "+t);var f;this.init=function(){return f||(f=o()),f},this.set=function(e,t,r,o){return n(r)&&(o=r,r=null),r=r?+new Date+1e3*r:0,i(u("set",e,t,r),o)},this.get=function(e,t){return i(u("get",e),t)},this.remove=function(e,t){return i(u("remove",e),t)},this.clear=function(e,t){return n(e)&&(t=e,e=null),i(u("clear",e),t)}}function f(e){function n(){_||(_=new s(m.prefix,m.stores))}function u(e){return new p(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?t({content:r.responseText,type:r.getResponseHeader("content-type")}):n(new Error("Can't open url "+e+(r.status?r.statusText+" ("+r.status+")":""))))},setTimeout(function(){r.readyState<4&&(r.abort(),n(new Error("Timeout")))},1e3*m.timeout);try{r.send()}catch(o){n(o)}})}function c(e,t){var n={};r(["url","key","unique"],function(t){e[t]&&(n[t]=e[t])});var o=+new Date;return n.data=t.content,n.originalType=t.type,n.type=e.type||t.type,n.stamp=o,n}function a(e){return u(e.url_real).then(function(t){var n=60*(e.expire||m.expire)*60,r=c(e,t);return _.set(e.key,r,n).then(function(){return o(e,r)},function(){return o(e,r)})})}function v(e,t){return!e||e.expire-+new Date<0||t.unique!==e.unique||t.url!==e.url||m.isValidItem&&!m.isValidItem(e,t)}function h(e){return e.url?(e.key=e.key||e.url,_.get(e.key).then(function(e){return e},function(){return null}).then(function(t){if(!t&&e.cached)throw new Error("Cache not exists");e.execute=e.execute!==!1;var n=!t||v(t,e);return e.live||n?(e.url_real=e.url,e.unique&&(e.url_real=e.url+(e.url.indexOf("?")>0?"&":"?")+"bag-unique="+e.unique),a(e).then(function(){return e},function(n){if(!t)throw n;return e.type=e.type||t.originalType,o(e,t)})):(e.type=e.type||t.originalType,o(e,t))})):p.resolve()}function y(e){var t=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),n=e.match(t);return{scheme:n[2],authority:n[4],path:n[5],query:n[7],fragment:n[9]}}function w(e){var t=y(e.url),n=!1,r=e.data.replace(x,function(e,r,o,i,u,c,a){if(!e)return null;n=!0,r||(r=u,o=c,i=a);var s=y(o),f=(s.scheme?s.scheme:t.scheme)||window.location.protocol.slice(0,-1),l=(s.authority?s.authority:t.authority)||window.location.host,d="/"===s.path[0]?s.path:t.path.split("/").slice(0,-1).join("/")+"/"+s.path;return r+(f+"://"+l+d)+i});return n?r:""}function g(e){if(e.type){var t=e.type.split(";")[0];"application/x-javascript"!==t&&"text/javascript"!==t||(t="application/javascript"),b[t]&&b[t](e)}}if(!(this instanceof f))return new f(e);var m=this;e=e||{},this.prefix=e.prefix||"bag",this.timeout=e.timeout||20,this.expire=e.expire||720,this.isValidItem=e.isValidItem||null,this.stores=d(e.stores)?e.stores:["indexeddb","websql","localstorage"];var _=null,x=/(?:^([ \t]*\/\/[@|#][ \t]+sourceMappingURL=)(.+?)([ \t]*)$)|(?:^([ \t]*\/\*[@#][ \t]+sourceMappingURL=)(.+?)([ \t]*\*\/[ \t])*$)/gm,b={"application/javascript":function(e){var t,n=document.createElement("script");t=w(e),t||(t=e.data+"\n//# sourceURL="+e.url),n.text=t,l.appendChild(n)},"text/css":function(e){var t,n=document.createElement("style");t=w(e),t||(t=e.data+"\n/*# sourceURL="+e.url+" */"),n.setAttribute("type","text/css"),n.styleSheet?(l.appendChild(n),n.styleSheet.cssText=t):(n.appendChild(document.createTextNode(t)),l.appendChild(n))}};this.require=function(e,o){return n(),i(new p(function(n,o){var i=[],u=0,c=d(e)?e:[e];return e?(r(c,function(e,t){i[t]=!1}),void r(c,function(r,a){t(r)&&(c[a]={url:r}),h(c[a]).then(function(){i[a]=c[a].data;var t;for(t=u;t<i.length&&i[t]!==!1;t++)c[t].execute&&g(c[t]);u=t,u>=c.length&&n(d(e)?i:i[0])},function(e){o(e)})})):void n()}),o)},r(["remove","get","set","clear"],function(e){m[e]=function(){return n(),_[e].apply(_,arguments)}}),this.addHandler=function(e,t){e=d(e)?e:[e],r(e,function(e){b[e]=t})},this.removeHandler=function(e){m.addHandler(e)}}var l=document.head||document.getElementsByTagName("head")[0],d=Array.isArray||function(t){return"[object Array]"===e(t)},v=function(e){var t=this;this._callbacks=[],e(function(e){t._resolve(e)},function(e){t._reject(e)})};v.resolve=function(e){return new v(function(t){t(e)})},v.reject=function(e){return new v(function(t,n){n(e)})},v.cast=function(e){return e instanceof v?e:v.resolve(e)},v.prototype={constructor:v,_failed:!1,_resolved:!1,_settled:!1,_release:function(e,t){if(this._failed){if("function"!=typeof t)throw this._value;t(this._value)}else"function"==typeof e&&e(this._value)},_resolve:function(e){if(!this._resolved){this._resolved=!0;var t=this;e instanceof v?e.done(function(e){t._settle(e)},function(e){t._failed=!0,t._settle(e)}):this._settle(e)}},_reject:function(e){this._resolved||(this._resolved=!0,this._failed=!0,this._settle(e))},_settle:function(e){this._settled=!0,this._value=e;var t=this;setTimeout(function(){r(t._callbacks,function(e){t._release(e.onSuccess,e.onFail)})},0)},done:function(e,t){var n=this;this._settled?setTimeout(function(){n._release(e,t)},0):this._callbacks.push({onSuccess:e,onFail:t})},then:function(e,t){var n=this;return new v(function(r,o){n.done(function(t){if("function"==typeof e)try{t=e(t)}catch(n){return void o(n)}r(t)},function(e){if("function"==typeof t){try{e=t(e)}catch(n){return void o(n)}r(e)}else o(e)})})},"catch":function(e){return this.then(null,e)}};var p=window.Promise||v;u.exists=function(){try{return localStorage.setItem("__ls_test__","__ls_test__"),localStorage.removeItem("__ls_test__"),!0}catch(e){return!1}},c.exists=function(){return!!window.openDatabase},a.exists=function(){var e=window.indexedDB;if(!e)return!1;var t="__idb_test__",n=null===e.open(t,1).onupgradeneeded;return e.deleteDatabase&&e.deleteDatabase(t),n};var h={indexeddb:a,websql:c,localstorage:u};return f});
//# sourceMappingURL=bag.min.js.map