!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():e.Bag=t()}(this,function(){"use strict";function e(){}function t(e){return"[object String]"===Object.prototype.toString.call(e)}function n(e){return"[object Function]"===Object.prototype.toString.call(e)}function r(e,t){if(d(e)){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n++)t(e[n],n,e)}else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(e[r],r)}function o(e,t){r(t,function(n,r){e[r]||(e[r]=t[r])})}function i(t,n,o){if(o=o||e,!t.length)return o();var i=0;r(t,function(r){n(r,function(n){n?(o(n),o=e):(i+=1,i>=t.length&&o())})})}function u(t){var o=this,i=t+"__",u=localStorage;this.init=function(e){e()},this.remove=function(t,n){n=n||e,u.removeItem(i+t),n()},this.set=function(e,t,n,a){var c,s={value:t,expire:n};try{u.setItem(i+e,JSON.stringify(s))}catch(l){if(l.name.toUpperCase().indexOf("QUOTA")>=0)try{r(u,function(e,t){var n=t.split(i)[1];n&&o.remove(n)}),u.setItem(i+e,JSON.stringify(s))}catch(f){c=f}else c=l}a(c)},this.get=function(e,t,r){n(t)&&(r=t,t=!1);var o,a;try{a=JSON.parse(u.getItem(i+e)),a=t?a:a.value}catch(c){o=new Error("Can't read key: "+e)}r(o,a)},this.clear=function(e,t){var n=+new Date;r(u,function(t,r){var u=r.split(i)[1];if(u){if(!e)return void o.remove(u);var a;o.get(u,!0,function(e,t){a=t}),a&&a.expire>0&&a.expire-n<0&&o.remove(u)}}),t()}}function a(t){var n;this.init=function(e){return(n=window.openDatabase(t,"1.0","bag.js db",2e5))?void n.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS kv (key TEXT PRIMARY KEY, value TEXT, expire INTEGER KEY)",[],function(){return e()},function(t,n){return e(n)})}):e("Can't open webdql database")},this.remove=function(t,r){r=r||e,n.transaction(function(e){e.executeSql("DELETE FROM kv WHERE key = ?",[t],function(){return r()},function(e,t){return r(t)})})},this.set=function(e,t,r,o){n.transaction(function(n){n.executeSql("INSERT OR REPLACE INTO kv (key, value, expire) VALUES (?, ?, ?)",[e,JSON.stringify(t),r],function(){return o()},function(e,t){return o(t)})})},this.get=function(e,t){n.readTransaction(function(n){n.executeSql("SELECT value FROM kv WHERE key = ?",[e],function(n,r){if(0===r.rows.length)return t(new Error("key not found: "+e));var o,i,u=r.rows.item(0).value;try{i=JSON.parse(u)}catch(a){o=new Error("Can't unserialise data: "+u)}t(o,i)},function(e,n){return t(n)})})},this.clear=function(e,t){n.transaction(function(r){e?r.executeSql("DELETE FROM kv WHERE expire > 0 AND expire < ?",[+new Date],function(){return t()},function(e,n){return t(n)}):n.transaction(function(e){e.executeSql("DELETE FROM kv",[],function(){return t()},function(e,n){return t(n)})})})}}function c(e){var t;this.init=function(n){var r=this.idb=window.indexedDB,o=r.open(e,2);o.onsuccess=function(e){t=e.target.result,n()},o.onblocked=function(e){n(new Error("IndexedDB blocked. "+e.target.errorCode))},o.onerror=function(e){n(new Error("IndexedDB opening error. "+e.target.errorCode))},o.onupgradeneeded=function(e){t=e.target.result,t.objectStoreNames.contains("kv")&&t.deleteObjectStore("kv");var n=t.createObjectStore("kv",{keyPath:"key"});n.createIndex("expire","expire",{unique:!1})}},this.remove=function(e,n){var r=t.transaction("kv","readwrite");r.oncomplete=function(){n()},r.onerror=r.onabort=function(e){n(new Error("Key remove error: ",e.target))},r.objectStore("kv")["delete"](e).onerror=function(){r.abort()}},this.set=function(e,n,r,o){var i=t.transaction("kv","readwrite");i.oncomplete=function(){o()},i.onerror=i.onabort=function(e){o(new Error("Key set error: ",e.target))},i.objectStore("kv").put({key:e,value:n,expire:r}).onerror=function(){i.abort()}},this.get=function(e,n){var r,o,i=t.transaction("kv");i.oncomplete=function(){n(r,o)},i.onerror=i.onabort=function(e){n(new Error("Key get error: ",e.target))},i.objectStore("kv").get(e).onsuccess=function(t){t.target.result?o=t.target.result.value:r=new Error("key not found: "+e)}},this.clear=function(e,n){var r,o,i=window.IDBKeyRange;if(r=t.transaction("kv","readwrite"),o=r.objectStore("kv"),r.oncomplete=function(){n()},r.onerror=r.onabort=function(e){n(new Error("Clear error: ",e.target))},e){var u=o.index("expire").openCursor(i.bound(1,+new Date));u.onsuccess=function(e){var t=e.target.result;t&&(o["delete"](t.primaryKey).onerror=function(){r.abort()},t["continue"]())}}else r.objectStore("kv").clear().onerror=function(){r.abort()}}}function s(t,o){var i,u=this,a=null,c=[];r(o,function(e){if(e=e.toLowerCase(),!p[e])throw new Error("Wrong storage adapter name: "+e,o);return p[e].prototype.exists()&&!a?(a=new p[e](t),!1):void 0}),a||"undefined"!=typeof console&&console.log&&console.log("None of requested storages available: "+o),this.init=function(e){return a?"done"===i?void e():"progress"===i?void c.push(e):(c.push(e),i="progress",void a.init(function(e){i=e?"failed":"done",r(c,function(t){t(e)}),c=[],e||u.clear(!0)})):void e(new Error("No available db"))},this.set=function(t,r,o,i){n(o)&&(i=o,o=null),i=i||e,o=o?+new Date+1e3*o:0,this.init(function(e){return e?i(e):void a.set(t,r,o,i)})},this.get=function(e,t){this.init(function(n){return n?t(n):void a.get(e,t)})},this.remove=function(t,n){n=n||e,this.init(function(e){return e?n(e):void a.remove(t,n)})},this.clear=function(t,r){n(t)&&(r=t,t=!1),r=r||e,this.init(function(e){return e?r(e):void a.clear(t,r)})}}function l(u){function a(t,n){var r=new XMLHttpRequest;r.open("GET",t),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?(n(null,{content:r.responseText,type:r.getResponseHeader("content-type")}),n=e):(n(new Error("Can't open url "+t+(r.status?r.statusText+" ("+r.status+")":""))),n=e))},setTimeout(function(){r.readyState<4&&(r.abort(),n(new Error("Timeout")),n=e)},1e3*x.timeout),r.send()}function c(e,t){var n={};r(["url","key","unique"],function(t){e[t]&&(n[t]=e[t])});var o=+new Date;return n.data=t.content,n.originalType=t.type,n.type=e.type||t.type,n.stamp=o,n}function p(e,t){a(e.url_real,function(n,r){if(n)return t(n);var i=60*(e.expire||x.expire)*60,u=c(e,r);x.set(e.key,u,i,function(){o(e,u),t(null,e)})})}function v(e,t){return!e||e.expire-+new Date<0||t.unique!==e.unique||t.url!==e.url||x.isValidItem&&!x.isValidItem(e,t)}function h(e,t){return e.url?(e.key=e.key||e.url,void x.get(e.key,function(n,r){if(n&&e.cached)return void t(n);e.execute=e.execute!==!1;var i=!!n||v(r,e);return e.live||i?(e.url_real=e.url,e.unique&&(e.url_real=e.url+(e.url.indexOf("?")>0?"&":"?")+"bag-unique="+e.unique),void p(e,function(i){return n&&i?void t(i):i?(e.type=e.type||r.originalType,o(e,r),void t(null,e)):void t(null,e)})):(e.type=e.type||r.originalType,o(e,r),void t(null,e))})):t()}function y(e){var t=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),n=e.match(t);return{scheme:n[2],authority:n[4],path:n[5],query:n[7],fragment:n[9]}}function g(e){var t=y(e.url),n=!1,r=e.data.replace(w,function(e,r,o,i,u,a,c){if(!e)return null;n=!0,r||(r=u,o=a,i=c);var s=y(o),l=(s.scheme?s.scheme:t.scheme)||window.location.protocol.slice(0,-1),f=(s.authority?s.authority:t.authority)||window.location.host,d="/"===s.path[0]?s.path:t.path.split("/").slice(0,-1).join("/")+"/"+s.path;return r+(l+"://"+f+d)+i});return n?r:""}function m(e){if(e.type){var t=e.type.split(";")[0];"application/x-javascript"!==t&&"text/javascript"!==t||(t="application/javascript"),b[t]&&b[t](e)}}if(!(this instanceof l))return new l(u);var x=this;u=u||{},this.prefix=u.prefix||"bag",this.timeout=u.timeout||20,this.expire=u.expire||720,this.isValidItem=u.isValidItem||null,this.stores=d(u.stores)?u.stores:["indexeddb","websql","localstorage"];var E=null;this._queue=[],this._chained=!1,this._createStorage=function(){E||(E=new s(x.prefix,x.stores))};var w=/(?:^([ \t]*\/\/[@|#][ \t]+sourceMappingURL=)(.+?)([ \t]*)$)|(?:^([ \t]*\/\*[@#][ \t]+sourceMappingURL=)(.+?)([ \t]*\*\/[ \t])*$)/gm,b={"application/javascript":function(e){var t,n=document.createElement("script");t=g(e),t||(t=e.data+"\n//# sourceURL="+e.url),n.text=t,f.appendChild(n)},"text/css":function(e){var t,n=document.createElement("style");t=g(e),t||(t=e.data+"\n/*# sourceURL="+e.url+" */"),n.setAttribute("type","text/css"),n.styleSheet?(f.appendChild(n),n.styleSheet.cssText=t):(n.appendChild(document.createTextNode(t)),f.appendChild(n))}};this.require=function(e,o){var u=x._queue;if(n(e)&&(o=e,e=null),e){var a=d(e)?e:[e];r(a,function(e,n){t(e)&&(a[n]={url:e}),u.push(a[n])})}return x._createStorage(),o?void i(u,h,function(t){if(t)return x._chained=!1,x._queue=[],void o(t);r(u,function(e){e.execute&&m(e)});var n=[];r(u,function(e){n.push(e.data)});var i=d(e)||x._chained?n:n[0];x._chained=!1,x._queue=[],o(null,i)}):(x._chained=!0,x)},r(["remove","get","set","clear"],function(e){x[e]=function(){x._createStorage(),E[e].apply(E,arguments)}}),this.addHandler=function(e,t){e=d(e)?e:[e],r(e,function(e){b[e]=t})},this.removeHandler=function(e){x.addHandler(e)}}var f=document.head||document.getElementsByTagName("head")[0],d=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};u.prototype.exists=function(){try{return localStorage.setItem("__ls_test__","__ls_test__"),localStorage.removeItem("__ls_test__"),!0}catch(e){return!1}},a.prototype.exists=function(){return!!window.openDatabase},c.prototype.exists=function(){var e=window.indexedDB;if(!e)return!1;var t="__idb_test__",n=null===e.open(t,1).onupgradeneeded;return e.deleteDatabase&&e.deleteDatabase(t),n};var p={indexeddb:c,websql:a,localstorage:u};return l});
//# sourceMappingURL=bag.min.js.map