/*!
* js-data
* @version 3.0.0-beta.7 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t(e.JSData=e.JSData||{})}(this,function(e){"use strict";function Component(){Object.defineProperty(this,"_listeners",{value:{}})}function Query(e){b.classCallCheck(this,Query),this.collection=e,this.data=null}function sort(e,t,n){return e===t?0:(n&&(e=n(e),t=n(t)),null===e&&null===t?0:null===e?-1:null===t?1:t>e?-1:e>t?1:0)}function insertAt(e,t,n){return e.splice(t,0,n),e}function removeAt(e,t){return e.splice(t,1),e}function binarySearch(e,t,n){for(var r=0,i=e.length,o=void 0,a=void 0;i>r;){if(a=(r+i)/2|0,o=sort(t,e[a],n),0===o)return{found:!0,index:a};0>o?i=a:r=a+1}return{found:!1,index:i}}function Index(e,t){if(b.classCallCheck(this,Index),e||(e=[]),!b.isArray(e))throw new Error("fieldList must be an array.");t||(t={}),this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}function Collection(e,t){b.classCallCheck(this,Collection),Collection.__super__.call(this),e&&!b.isArray(e)&&(t=e,e=[]),b.isString(t)&&(t={idAttribute:t}),e||(e=[]),t||(t={}),Object.defineProperties(this,{mapper:{value:void 0,writable:!0},queryClass:{value:void 0,writable:!0}}),b.fillIn(this,t),b.fillIn(this,b.copy(I)),this.queryClass||(this.queryClass=F);var n=this.recordId();Object.defineProperties(this,{index:{value:new Index([n],{hashCode:function hashCode(e){return b.get(e,n)}})},indexes:{value:{}}}),e&&this.add(e)}function Record(e,t){b.classCallCheck(this,Record),e||(e={}),t||(t={});var n={};Object.defineProperties(this,{_get:{value:function value(e){return b.get(n,e)}},_set:{value:function value(e,t){return b.set(n,e,t)}},_unset:{value:function value(e){return b.unset(n,e)}}});var r=this._set;r("creating",!0),t.noValidate&&r("noValidate",!0),b.fillIn(this,e),r("creating",!1),r("noValidate",!1),r("previous",b.plainCopy(e))}function Schema(e){e||(e={}),b.fillIn(this,e),e.properties&&b.forOwn(e.properties,function(t,n){t instanceof Schema||(e.properties[n]=new Schema(t))})}function Relation(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];b.classCallCheck(this,Relation),n.type=this.constructor.TYPE_NAME,this.validateOptions(e,n),"object"===("undefined"==typeof e?"undefined":t.typeof(e))&&Object.defineProperty(this,"relatedMapper",{value:e}),Object.defineProperty(this,"inverse",{writable:!0}),b.fillIn(this,n)}function Mapper(e){var t=this;if(b.classCallCheck(this,Mapper),Mapper.__super__.call(this),e||(e={}),Object.defineProperties(this,{_adapters:{value:void 0,writable:!0},recordClass:{value:void 0,writable:!0},lifecycleMethods:{value:xe},schema:{value:void 0,writable:!0}}),b.fillIn(this,e),b.fillIn(this,b.copy(we)),!this.name)throw b.err("new "+me,"opts.name")(400,"string",this.name);this.schema instanceof se||(this.schema=new se(this.schema||{})),this.schema instanceof se&&(this.schema.type||(this.schema.type="object")),b.isUndefined(this.recordClass)&&!function(){var e=M;t.recordClass=e.extend({constructor:function Record(){var t=function Record(n,r){b.classCallCheck(this,t),e.call(this,n,r)};return t}()})}(),this.recordClass&&(this.recordClass.mapper=this,b.getSuper(this.recordClass,!0)===M&&this.schema&&this.schema.apply&&this.applySchema&&this.schema.apply(this.recordClass.prototype))}function Container(e){b.classCallCheck(this,Container),Container.__super__.call(this),e||(e={}),Object.defineProperties(this,{_adapters:{value:{}},_mappers:{value:{}}}),b.fillIn(this,e),this.mapperDefaults=this.mapperDefaults||{},this.mapperClass=this.mapperClass||Ce}function LinkedCollection(e,t){if(b.classCallCheck(this,LinkedCollection),Object.defineProperties(this,{_added:{value:{}},datastore:{writable:!0,value:void 0}}),LinkedCollection.__super__.call(this,e,t),!this.datastore)throw b.err("new "+Ie,"opts.datastore")(400,"DataStore",this.datastore);return this}function DataStore(e){return b.classCallCheck(this,DataStore),DataStore.__super__.call(this,e),this.collectionClass=this.collectionClass||ke,this._collections={},this._pendingQueries={},this._completedQueries={},this}var t={};t.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},t.defineProperty=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},t.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)};var n="utils",r=1/0,i=1.7976931348623157e308,o="[object Boolean]",a="[object Date]",s="[object Function]",u="[object Number]",c="[object Object]",l="[object RegExp]",f="[object String]",d=Object.prototype.toString,h=/^(.+)\.(.+)$/,p={400:function _(){return"expected: "+arguments[0]+", found: "+(arguments[2]?arguments[1]:t.typeof(arguments[1]))},404:function _(){return arguments[0]+" not found"}},v=function toInteger(e){if(!e)return 0;if(e=+e,e===r||e===-r){var t=0>e?-1:1;return t*i}var n=e%1;return e===e?n?e-n:e:0},g=function toStr(e){return d.call(e)},y=function isPlainObject(e){return!!e&&"object"===("undefined"==typeof e?"undefined":t.typeof(e))&&e.constructor===Object},m=function mkdirP(e,t){if(!t)return e;var n=t.split(".");return n.forEach(function(t){e[t]||(e[t]={}),e=e[t]}),e},b={Promise:Promise,_:function _(e,t){b.forOwn(t,function(t,n){n&&b.isUndefined(e[n])&&!b.isFunction(t)&&0!==n.indexOf("_")&&(e[n]=t)})},_forRelation:function _forRelation(e,t,n,r){var i=t.relation,o=null,a=void 0;if(e||(e={}),e.with||(e.with=[]),(a=b._getIndex(e.with,i))>=0?o=i:(a=b._getIndex(e.with,t.localField))>=0&&(o=t.localField),e.withAll)return void n.call(r,t,{});if(o){var s={};b.fillIn(s,t.getRelation()),b.fillIn(s,e),s.with=e.with.slice(),s._activeWith=s.with.splice(a,1)[0],s.with.forEach(function(e,t){e&&0===e.indexOf(o)&&e.length>=o.length&&"."===e[o.length]?s.with[t]=e.substr(o.length+1):s.with[t]=""}),n.call(r,t,s)}},_getIndex:function _getIndex(e,t){var n=-1;return e.forEach(function(e,r){return e===t?(n=r,!1):b.isObject(e)&&e.relation===t?(n=r,!1):void 0}),n},addHiddenPropsToTarget:function addHiddenPropsToTarget(e,t){var n={};Object.keys(t).forEach(function(e){var r=Object.getOwnPropertyDescriptor(t,e);r.enumerable=!1,n[e]=r}),Object.defineProperties(e,n)},areDifferent:function areDifferent(e,t,n){n||(n={});var r=b.diffObjects(e,t,n),i=Object.keys(r.added).length+Object.keys(r.removed).length+Object.keys(r.changed).length;return i>0},classCallCheck:function classCallCheck(e,t){if(!(e instanceof t))throw b.err(""+t.name)(500,"Cannot call a class as a function")},copy:function copy(e,t,r,i,o,a){if(t){if(e===t)throw b.err(n+".copy")(500,"Cannot copy! Source and destination are identical.");if(r=r||[],i=i||[],b.isObject(e)){var s=r.indexOf(e);if(-1!==s)return i[s];r.push(e),i.push(t)}var u=void 0;if(b.isArray(e)){var c=void 0;for(t.length=0,c=0;c<e.length;c++)u=b.copy(e[c],null,r,i,o,a),b.isObject(e[c])&&(r.push(e[c]),i.push(u)),t.push(u)}else{b.isArray(t)?t.length=0:b.forOwn(t,function(e,n){delete t[n]});for(var l in e)if(e.hasOwnProperty(l)){if(b.isBlacklisted(l,o))continue;u=b.copy(e[l],null,r,i,o,a),b.isObject(e[l])&&(r.push(e[l]),i.push(u)),t[l]=u}}}else t=e,e&&(b.isArray(e)?t=b.copy(e,[],r,i,o,a):b.isDate(e)?t=new Date(e.getTime()):b.isRegExp(e)?(t=new RegExp(e.source,e.toString().match(/[^\/]*$/)[0]),t.lastIndex=e.lastIndex):b.isObject(e)&&(t=a?b.copy(e,{},r,i,o,a):b.copy(e,Object.create(Object.getPrototypeOf(e)),r,i,o,a)));return t},deepFillIn:function deepFillIn(e,t){return t&&b.forOwn(t,function(t,n){var r=e[n];y(t)&&y(r)?b.deepFillIn(r,t):e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)}),e},deepMixIn:function deepMixIn(e,t){return t&&b.forOwn(t,function(t,n){var r=e[n];y(t)&&y(r)?b.deepMixIn(r,t):e[n]=t}),e},diffObjects:function diffObjects(e,t,n){n||(n={});var r=n.equalsFn,i=n.ignore,o={added:{},changed:{},removed:{}};b.isFunction(r)||(r=b.deepEqual);var a=Object.keys(e).filter(function(e){return!b.isBlacklisted(e,i)}),s=Object.keys(t).filter(function(e){return!b.isBlacklisted(e,i)});return a.forEach(function(n){var i=t[n],a=e[n];r(i,a)||(b.isUndefined(i)?o.added[n]=a:o.changed[n]=a)}),s.forEach(function(n){var r=t[n],i=e[n];b.isUndefined(i)&&!b.isUndefined(r)&&(o.removed[n]=void 0)}),o},equal:function equal(e,t){return e==t},err:function err(e,t){return function(n){var r="["+e+":"+t+"] ",i=p[n].apply(null,Array.prototype.slice.call(arguments,1));return i=""+r+i+"\nhttp://www.js-data.io/v3.0/docs/errors#"+n,new Error(i)}},eventify:function eventify(e,t,n){e=e||this;var r={};t||n||(t=function getter(){return r},n=function setter(e){r=e}),Object.defineProperties(e,{emit:{value:function value(){for(var e=t.call(this)||{},n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];var o=r.shift(),a=e[o]||[],s=void 0;for(s=0;s<a.length;s++)a[s].f.apply(a[s].c,r);for(a=e.all||[],r.unshift(o),s=0;s<a.length;s++)a[s].f.apply(a[s].c,r)}},off:{value:function value(e,r){var i=t.call(this),o=i[e];if(o)if(r){for(var a=0;a<o.length;a++)if(o[a].f===r){o.splice(a,1);break}}else o.splice(0,o.length);else n.call(this,{})}},on:{value:function value(e,r,i){t.call(this)||n.call(this,{});var o=t.call(this);o[e]=o[e]||[],o[e].push({c:i,f:r})}}})},extend:function extend(e,t){var n=this,r=void 0;e||(e={}),t||(t={}),e.hasOwnProperty("constructor")?(r=e.constructor,delete e.constructor):r=function subClass(){b.classCallCheck(this,r);for(var e=arguments.length,t=Array(e),i=0;e>i;i++)t[i]=arguments[i];n.apply(this,t)},r.prototype=Object.create(n&&n.prototype,{constructor:{configurable:!0,enumerable:!1,value:r,writable:!0}});var i=Object;return i.setPrototypeOf?i.setPrototypeOf(r,n):t.strictEs6Class?r.__proto__=n:b.forOwn(n,function(e,t){r[t]=e}),r.hasOwnProperty("__super__")||Object.defineProperty(r,"__super__",{configurable:!0,value:n}),b.addHiddenPropsToTarget(r.prototype,e),b.fillIn(r,t),r},fillIn:function fillIn(e,t){b.forOwn(t,function(t,n){e.hasOwnProperty(n)&&void 0!==e[n]||(e[n]=t)})},findIndex:function findIndex(e,t){var n=-1;return e?(e.forEach(function(e,r){return t(e)?(n=r,!1):void 0}),n):n},forEachRelation:function forEachRelation(e,t,n,r){var i=e.relationList||[];i.length&&i.forEach(function(e){b._forRelation(t,e,n,r)})},forOwn:function forOwn(e,t,n){var r=Object.keys(e),i=r.length,o=void 0;for(o=0;i>o;o++)t.call(n,e[r[o]],r[o],e)},fromJson:function fromJson(e){return b.isString(e)?JSON.parse(e):e},get:function get(e,t){if(t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(e=e[t],null==e)return;return e[r]}},getSuper:function getSuper(e,t){var n=t?e:e.constructor;return n.hasOwnProperty("__super__")?n.__super__:Object.getPrototypeOf(n)||n.__proto__},intersection:function intersection(e,t){if(!e||!t)return[];var n=[],r=void 0,i=void 0,o=e.length;for(i=0;o>i;i++)r=e[i],-1===n.indexOf(r)&&-1!==t.indexOf(r)&&n.push(r);return n},isArray:Array.isArray,isBlacklisted:function isBlacklisted(e,t){if(!t||!t.length)return!1;for(var n=void 0,r=0;r<t.length;r++)if(g(t[r])===l&&t[r].test(e)||t[r]===e)return n=e;return!!n},isBoolean:function isBoolean(e){return g(e)===o},isDate:function isDate(e){return e&&"object"===("undefined"==typeof e?"undefined":t.typeof(e))&&g(e)===a},isFunction:function isFunction(e){return"function"==typeof e||e&&g(e)===s},isInteger:function isInteger(e){return g(e)===u&&e==v(e)},isNull:function isNull(e){return null===e},isNumber:function isNumber(e){var n="undefined"==typeof e?"undefined":t.typeof(e);return"number"===n||e&&"object"===n&&g(e)===u},isObject:function isObject(e){return g(e)===c},isRegExp:function isRegExp(e){return g(e)===l},isSorN:function isSorN(e){return b.isString(e)||b.isNumber(e)},isString:function isString(e){return"string"==typeof e||e&&"object"===("undefined"==typeof e?"undefined":t.typeof(e))&&g(e)===f},isUndefined:function isUndefined(e){return void 0===e},logify:function logify(e){b.addHiddenPropsToTarget(e,{dbg:function dbg(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))},log:function log(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var i=e.toUpperCase()+": ("+(this.name||this.constructor.name)+")";if(console[e]){var o;(o=console)[e].apply(o,[i].concat(n))}else{var a;(a=console).log.apply(a,[i].concat(n))}}}})},noDupeAdd:function noDupeAdd(e,t,n){if(e){var r=this.findIndex(e,n);0>r&&e.push(t)}},omit:function omit(e,t){var n={};return b.forOwn(e,function(e,r){-1===t.indexOf(r)&&(n[r]=e)}),n},pick:function pick(e,t){var n={};return b.forOwn(e,function(e,r){-1!==t.indexOf(r)&&(n[r]=e)}),n},plainCopy:function plainCopy(e){return b.copy(e,void 0,void 0,void 0,void 0,!0)},reject:function reject(e){return b.Promise.reject(e)},remove:function remove(e,t){if(e&&e.length){var n=this.findIndex(e,t);n>=0&&e.splice(n,1)}},resolve:function resolve(e){return b.Promise.resolve(e)},set:function set(e,t,n){if(b.isObject(t))b.forOwn(t,function(t,n){b.set(e,n,t)});else{var r=h.exec(t);r?m(e,r[1])[r[2]]=n:e[t]=n}},deepEqual:function deepEqual(e,t){if(e===t)return!0;var n=!0;if(b.isObject(e)&&b.isObject(t)){if(b.forOwn(e,function(e,r){n=n&&b.deepEqual(e,t[r])}),!n)return n;b.forOwn(t,function(t,r){n=n&&b.deepEqual(t,e[r])})}else{if(!b.isArray(e)||!b.isArray(t))return!1;e.forEach(function(e,r){return n=n&&b.deepEqual(e,t[r]),n?void 0:!1})}return n},toJson:JSON.stringify,unset:function unset(e,t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(e=e[t],null==e)return;e[r]=void 0}};Component.extend=b.extend,b.logify(Component.prototype),b.eventify(Component.prototype,function(){return this._listeners},function(e){this._listeners=e});var A="Query",_="Index inaccessible after first operation",O={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:""},x=/([.*+?^=!:${}()|[\]\/\\])/g,w=/%/g,C=/_/g,E=function escape(e){return e.replace(x,"\\$1")},F=Component.extend({constructor:Query,_applyWhereFromObject:function _applyWhereFromObject(e){var t=[],n=[],r=[];return b.forOwn(e,function(e,i){b.isObject(e)||(e={"==":e}),b.forOwn(e,function(e,o){t.push(i),n.push(o),r.push(e)})}),{fields:t,ops:n,predicates:r}},_applyWhereFromArray:function _applyWhereFromArray(e){var t=this,n=[];return e.forEach(function(r,i){if(!b.isString(r)){var o=e[i-1],a=b.isArray(r)?t._applyWhereFromArray:t._applyWhereFromObject,s=a.call(t,r);"or"===o&&(s.isOr=!0),n.push(s)}}),n.isArray=!0,n},_testObjectGroup:function _testObjectGroup(e,t,n,r){var i=void 0,o=n.fields,a=n.ops,s=n.predicates,u=a.length;for(i=0;u>i;i++){var c=a[i],l="|"===c.charAt(0);c=l?c.substr(1):c;var f=this.evaluate(b.get(r,o[i]),c,s[i]);void 0!==f&&(e=t?f:l?e||f:e&&f),t=!1}return{keep:e,first:t}},_testArrayGroup:function _testArrayGroup(e,t,n,r){var i=void 0,o=n.length;for(i=0;o>i;i++){var a=n[i],s=a.isArray?this._testArrayGroup:this._testObjectGroup,u=s.call(this,!0,!0,a,r);e=n[i-1]?a.isOr?e||u.keep:e&&u.keep:u.keep,t=u.first}return{keep:e,first:t}},between:function between(e,t,n){if(n||(n={}),this.data)throw b.err(A+"#between")(500,"Cannot access index");return this.data=this.collection.getIndex(n.index).between(e,t,n),this},compare:function compare(e,t,n,r){var i=e[t],o=b.get(n,i[0]),a=b.get(r,i[0]);if(o&&b.isString(o)&&(o=o.toUpperCase()),a&&b.isString(a)&&(a=a.toUpperCase()),void 0===n&&(n=null),void 0===r&&(r=null),"DESC"===i[1].toUpperCase()){var s=a;a=o,o=s}return a>o?-1:o>a?1:t<e.length-1?this.compare(e,t+1,n,r):0},evaluate:function evaluate(e,t,n){var r=this.constructor.ops;return r[t]?r[t](e,n):0===t.indexOf("like")?!b.isNull(this.like(n,t.substr(4)).exec(e)):0===t.indexOf("notLike")?b.isNull(this.like(n,t.substr(7)).exec(e)):void 0},filter:function filter(e,t){var n=this;return e||(e={}),this.getData(),b.isObject(e)?!function(){var t={};(b.isObject(e.where)||b.isArray(e.where))&&(t=e.where),b.forOwn(e,function(e,n){n in O||n in t||(t[n]={"==":e})});var r=void 0;b.isObject(t)&&0!==Object.keys(t).length?r=n._applyWhereFromArray([t]):b.isArray(t)&&(r=n._applyWhereFromArray(t)),r&&(n.data=n.data.filter(function(e,t){return n._testArrayGroup(!0,!0,r,e).keep}));var i=e.orderBy||e.sort;b.isString(i)&&(i=[[i,"ASC"]]),b.isArray(i)||(i=null),i&&!function(){var e=0;i.forEach(function(e,t){b.isString(e)&&(i[t]=[e,"ASC"])}),n.data.sort(function(t,r){return n.compare(i,e,t,r)})}(),b.isNumber(e.skip)?n.skip(e.skip):b.isNumber(e.offset)&&n.skip(e.offset),b.isNumber(e.limit)&&n.limit(e.limit)}():b.isFunction(e)&&(this.data=this.data.filter(e,t)),this},forEach:function forEach(e,t){return this.getData().forEach(e,t),this},get:function get(e,t){if(e||(e=[]),t||(t={}),this.data)throw b.err(A+"#get")(500,_);return e&&!b.isArray(e)&&(e=[e]),e.length?(this.data=this.collection.getIndex(t.index).get(e),this):(this.getData(),this)},getAll:function getAll(){var e=this,t={};if(this.data)throw b.err(A+"#getAll")(500,_);for(var n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];if(!r.length||1===r.length&&b.isObject(r[0]))return this.getData(),this;r.length&&b.isObject(r[r.length-1])&&(t=r[r.length-1],r.pop());var o=this.collection,a=o.getIndex(t.index);return this.data=[],r.forEach(function(t){e.data=e.data.concat(a.get(t))}),this},getData:function getData(){return this.data||(this.data=this.collection.index.getAll()),this.data},like:function like(e,t){return new RegExp("^"+E(e).replace(w,".*").replace(C,".")+"$",t)},limit:function limit(e){if(!b.isNumber(e))throw b.err(A+"#limit","num")(400,"number",e);var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this},map:function map(e,t){return this.data=this.getData().map(e,t),this},mapCall:function mapCall(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return this.data=this.getData().map(function(t){return t[e].apply(t,n)}),this},run:function run(){var e=this.data;return this.data=null,e},skip:function skip(e){if(!b.isNumber(e))throw b.err(A+"#skip","num")(400,"number",e);var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this}},{ops:{"=":function _(e,t){return e==t},"==":function _(e,t){return e==t},"===":function _(e,t){return e===t},"!=":function _(e,t){return e!=t},"!==":function _(e,t){return e!==t},">":function _(e,t){return e>t},">=":function _(e,t){return e>=t},"<":function _(e,t){return t>e},"<=":function _(e,t){return t>=e},isectEmpty:function isectEmpty(e,t){return!b.intersection(e||[],t||[]).length},isectNotEmpty:function isectNotEmpty(e,t){return b.intersection(e||[],t||[]).length},in:function _in(e,t){return-1!==t.indexOf(e)},notIn:function notIn(e,t){return-1===t.indexOf(e)},contains:function contains(e,t){return-1!==(e||[]).indexOf(t)},notContains:function notContains(e,t){return-1===(e||[]).indexOf(t)}}});b.addHiddenPropsToTarget(Index.prototype,{set:function set(e,t){b.isArray(e)||(e=[e]);var n=e.shift()||null,r=binarySearch(this.keys,n);if(0===e.length)if(r.found){var i=binarySearch(this.values[r.index],t,this.hashCode);i.found||insertAt(this.values[r.index],i.index,t)}else insertAt(this.keys,r.index,n),insertAt(this.values,r.index,[t]);else if(r.found)this.values[r.index].set(e,t);else{insertAt(this.keys,r.index,n);var o=new Index([],{hashCode:this.hashCode});o.set(e,t),insertAt(this.values,r.index,o)}},get:function get(e){b.isArray(e)||(e=[e]);var t=e.shift()||null,n=binarySearch(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index]:[]:n.found?this.values[n.index].get(e):[]},getAll:function getAll(e){e||(e={});var t=[],n=this.values;if("desc"===e.order)for(var r=n.length-1;r>=0;r--){var i=n[r];t=i.isIndex?t.concat(i.getAll(e)):t.concat(i)}else for(var o=0;o<n.length;o++){var a=n[o];t=a.isIndex?t.concat(a.getAll(e)):t.concat(a)}return t},visitAll:function visitAll(e,t){this.values.forEach(function(n){n.isIndex?n.visitAll(e,t):n.forEach(e,t)})},between:function between(e,t,n){n||(n={}),b.isArray(e)||(e=[e]),b.isArray(t)||(t=[t]),b.fillIn(n,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var r=this._between(e,t,n);return n.limit?r.slice(n.offset,n.limit+n.offset):r.slice(n.offset)},_between:function _between(e,t,n){var r=[],i=e.shift(),o=t.shift(),a=void 0;if(a=void 0!==i?binarySearch(this.keys,i):{found:!1,index:0},0===e.length){a.found&&n.leftInclusive===!1&&(a.index+=1);for(var s=a.index;s<this.keys.length;s+=1){if(void 0!==o)if(n.rightInclusive){if(this.keys[s]>o)break}else if(this.keys[s]>=o)break;if(r=this.values[s].isIndex?r.concat(this.values[s].getAll()):r.concat(this.values[s]),n.limit&&r.length>=n.limit+n.offset)break}}else for(var u=a.index;u<this.keys.length;u+=1){var c=this.keys[u];if(c>o)break;if(r=this.values[u].isIndex?c===i?r.concat(this.values[u]._between(b.copy(e),t.map(function(){}),n)):c===o?r.concat(this.values[u]._between(e.map(function(){}),b.copy(t),n)):r.concat(this.values[u].getAll()):r.concat(this.values[u]),n.limit&&r.length>=n.limit+n.offset)break}return n.limit?r.slice(0,n.limit+n.offset):r},peek:function peek(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]},clear:function clear(){this.keys=[],this.values=[]},insertRecord:function insertRecord(e){var t=this.fieldList.map(function(t){return b.isFunction(t)?t(e)||null:e[t]||null});this.set(t,e)},removeRecord:function removeRecord(e){var t=this,n=void 0;return this.values.forEach(function(r,i){if(r.isIndex){if(r.removeRecord(e))return 0===r.keys.length&&(removeAt(t.keys,i),removeAt(t.values,i)),n=!0,!1}else{var o=binarySearch(r,e,t.hashCode);if(o.found)return removeAt(r,o.index),0===r.length&&(removeAt(t.keys,i),removeAt(t.values,i)),n=!0,!1}}),n?e:void 0},updateRecord:function updateRecord(e){this.removeRecord(e),this.insertRecord(e)}});var R="Collection",I={commitOnMerge:!0,idAttribute:"id",onConflict:"merge"},k=Component.extend({constructor:Collection,_onRecordEvent:function _onRecordEvent(){this.emit.apply(this,arguments)},add:function add(e,t){var n=this;t||(t={}),b._(t,this),e=this.beforeAdd(e,t)||e;var r=!1,i=this.recordId();if(!b.isArray(e)){if(!b.isObject(e))throw b.err(R+"#add","records")(400,"object or array",e);e=[e],r=!0}e=e.map(function(e){var r=n.recordId(e);if(!b.isSorN(r))throw b.err(R+"#add","record."+i)(400,"string or number",r);var o=n.get(r);if(e===o)return o;if(o){var a=t.onConflict||n.onConflict;if("merge"===a)b.deepMixIn(o,e);else{if("replace"!==a)throw b.err(R+"#add","opts.onConflict")(400,"one of (merge, replace)",a,!0);b.forOwn(o,function(t,n){n===i||e.hasOwnProperty(n)||delete o[n]}),o.set(e)}e=o,t.commitOnMerge&&b.isFunction(e.commit)&&e.commit(),n.updateIndexes(e)}else e=n.mapper?n.mapper.createRecord(e,t):e,n.index.insertRecord(e),b.forOwn(n.indexes,function(t,n){t.insertRecord(e)}),e&&b.isFunction(e.on)&&e.on("all",n._onRecordEvent,n);return e});var o=r?e[0]:e;return this.emit("add",o),this.afterAdd(e,t,o)||o},afterAdd:function afterAdd(){},afterRemove:function afterRemove(){},afterRemoveAll:function afterRemoveAll(){},beforeAdd:function beforeAdd(){},beforeRemove:function beforeRemove(){},beforeRemoveAll:function beforeRemoveAll(){},between:function between(e,t,n){return this.query().between(e,t,n).run()},createIndex:function createIndex(e,t,n){var r=this;b.isString(e)&&void 0===t&&(t=[e]),n||(n={}),n.hashCode||(n.hashCode=function(e){return r.recordId(e)});var i=this.indexes[e]=new Index(t,n);return this.index.visitAll(i.insertRecord,i),this},filter:function filter(e,t){return this.query().filter(e,t).run()},forEach:function forEach(e,t){this.index.visitAll(e,t)},get:function get(e){var t=this.query().get(e).run();return t.length?t[0]:void 0},getAll:function getAll(){var e;return(e=this.query()).getAll.apply(e,arguments).run()},getIndex:function getIndex(e){var t=e?this.indexes[e]:this.index;if(!t)throw b.err(R+"#getIndex",e)(404,"index");return t},limit:function limit(e){return this.query().limit(e).run()},map:function map(e,t){var n=[];return this.index.visitAll(function(r){n.push(e.call(t,r))}),n},mapCall:function mapCall(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=[];return this.index.visitAll(function(t){i.push(t[e].apply(t,n))}),i},recordId:function recordId(e){return e?b.get(e,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute},query:function query(){var e=this.queryClass;return new e(this)},reduce:function reduce(e,t){var n=this.getAll();return n.reduce(e,t)},remove:function remove(e,t){t||(t={}),this.beforeRemove(e,t);var n=this.get(e);return n&&(this.index.removeRecord(n),b.forOwn(this.indexes,function(e,t){e.removeRecord(n)}),n&&b.isFunction(n.off)&&(n.off("all",this._onRecordEvent,this),this.emit("remove",n))),this.afterRemove(e,t,n)||n},removeAll:function removeAll(e,t){var n=this;t||(t={}),this.beforeRemoveAll(e,t);var r=this.filter(e);return r.forEach(function(e){n.remove(n.recordId(e),t)}),this.afterRemoveAll(e,t,r)||r},skip:function skip(e){return this.query().skip(e).run()},toJSON:function toJSON(e){return this.mapCall("toJSON",e)},updateIndex:function updateIndex(e,t){t||(t={}),this.getIndex(t.index).updateRecord(e)},updateIndexes:function updateIndexes(e){this.index.updateRecord(e),b.forOwn(this.indexes,function(t,n){t.updateRecord(e)})}}),j="Record",S=function superMethod(e,t){var n=e.datastore;return n&&n[t]?function(){for(var r=arguments.length,i=Array(r),o=0;r>o;o++)i[o]=arguments[o];return n[t].apply(n,[e.name].concat(i))}:e[t].bind(e)},M=Component.extend({constructor:Record,_mapper:function _mapper(){var e=this.constructor.mapper;if(!e)throw b.err(j+"#_mapper","")(404,"mapper");return e},afterLoadRelations:function afterLoadRelations(){},beforeLoadRelations:function beforeLoadRelations(){},changes:function changes(e){return e||(e={}),b.diffObjects("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},commit:function commit(){this._set("changed"),this._set("previous",b.plainCopy(this))},destroy:function destroy(e){e||(e={});var t=this._mapper();return S(t,"destroy")(b.get(this,t.idAttribute),e)},get:function get(e){return b.get(this,e)},hasChanges:function hasChanges(e){var t=!!(this._get("changed")||[]).length;return t||b.areDifferent("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)},isValid:function isValid(e){return!this._mapper().validate(this,e)},loadRelations:function loadRelations(e,n){var r=this,i=void 0,o=this._mapper();return e||(e=[]),b.isString(e)&&(e=[e]),n||(n={}),n.with=e,b._(n,o),n.adapter=o.getAdapterName(n),i=n.op="beforeLoadRelations",b.resolve(this[i](e,n)).then(function(){i=n.op="loadRelations",o.dbg(i,r,e,n);var a=[],s=void 0;return b.forEachRelation(o,n,function(e,i){var u=e.getRelation();if(i.raw=!1,b.isFunction(e.load))s=e.load(o,e,r,n);else if("hasMany"===e.type||"hasOne"===e.type)e.foreignKey?s=S(u,"findAll")(t.defineProperty({},e.foreignKey,b.get(r,o.idAttribute)),i).then(function(t){return"hasOne"===e.type?t.length?t[0]:void 0:t}):e.localKeys?s=S(u,"findAll")({where:t.defineProperty({},u.idAttribute,{in:b.get(r,e.localKeys)})}):e.foreignKeys&&(s=S(u,"findAll")({where:t.defineProperty({},e.foreignKeys,{contains:b.get(r,o.idAttribute)})},n));else if("belongsTo"===e.type){var c=b.get(r,e.foreignKey);b.isSorN(c)&&(s=S(u,"find")(c,i))}s&&(s=s.then(function(t){e.setLocalField(r,t)}),a.push(s))}),Promise.all(a)}).then(function(){return i=n.op="afterLoadRelations",b.resolve(r[i](e,n)).then(function(){return r})})},previous:function previous(e){return e?this._get("previous."+e):this._get("previous")},revert:function revert(e){var t=this,n=this._get("previous");e||(e={}),e.preserve||(e.preserve=[]),b.forOwn(this,function(r,i){i!==t._mapper().idAttribute&&!n.hasOwnProperty(i)&&t.hasOwnProperty(i)&&-1===e.preserve.indexOf(i)&&delete t[i]}),b.forOwn(n,function(n,r){-1===e.preserve.indexOf(r)&&(t[r]=n)}),this.commit()},save:function save(e){var t=this;e||(e={});var n=this._mapper(),r=b.get(this,n.idAttribute),i=this;if(b.isUndefined(r))return S(n,"create")(i,e);if(e.changesOnly){var o=this.changes(e);i={},b.fillIn(i,o.added),b.fillIn(i,o.changed)}return S(n,"update")(r,i,e).then(function(n){var r=e.raw?n.data:n;return r&&(b.deepMixIn(t,r),t.commit()),n})},set:function set(e,t,n){b.isObject(e)&&(n=t),n||(n={}),n.silent&&this._set("silent",!0),b.set(this,e,t),this._get("eventId")||this._set("silent")},toJSON:function toJSON(e){var n=this,r=this.constructor.mapper;if(r)return r.toJSON(this,e);var i=function(){var e={};return b.forOwn(n,function(t,n){e[n]=b.plainCopy(t)}),{v:e}}();return"object"===("undefined"==typeof i?"undefined":t.typeof(i))?i.v:void 0},unset:function unset(e,t){this.set(e,void 0,t)},validate:function validate(e){return this._mapper().validate(this,e)}});b.eventify(Record.prototype,function(){return this._get("events")},function(e){this._set("events",e)});var L="Schema",P={array:b.isArray,boolean:b.isBoolean,integer:b.isInteger,null:b.isNull,number:b.isNumber,object:b.isObject,string:b.isString},K=function segmentToString(e,t){var n="";return e&&(n+=b.isNumber(e)?"["+e+"]":t?"."+e:""+e),n},N=function makePath(e){e||(e={});var t="",n=e.path||[];return n.forEach(function(e){t+=K(e,t)}),t+=K(e.prop,t)},D=function makeError(e,t,n){return{expected:t,actual:""+e,path:N(n)}},T=function addError(e,t,n,r){r.push(D(e,t,n))},U=function maxLengthCommon(e,t,n,r){var i=n[e];return t.length>i?D(t.length,"length no more than "+i,r):void 0},q=function minLengthCommon(e,t,n,r){var i=n[e];return t.length<i?D(t.length,"length no less than "+i,r):void 0},J={allOf:function allOf(e,t,n){var r=[];return t.allOf.forEach(function(t){r=r.concat(z(e,t,n)||[])}),r.length?void 0:r},anyOf:function anyOf(e,t,n){var r=!1,i=[];return t.anyOf.forEach(function(t){var o=z(e,t,n);o?i=i.concat(o):r=!0}),r?void 0:i},dependencies:function dependencies(e,t,n){},enum:function _enum(e,t,n){var r=t.enum;return-1===b.findIndex(r,function(t){return b.deepEqual(t,e)})?D(e,"one of ("+r.join(", ")+")",n):void 0},items:function items(e,t,n){n||(n={});for(var items=t.items,r=[],i=b.isArray(items),o=e.length,a=0;o>a;a++)i&&(items=t.items[a]),n.prop=a,r=r.concat(z(e[a],items,n)||[]);return r.length?r:void 0},maximum:function maximum(e,n,r){var maximum=n.maximum,i=n.exclusiveMaximum;return("undefined"==typeof e?"undefined":t.typeof(e))!==("undefined"==typeof maximum?"undefined":t.typeof(maximum))||(i?maximum>e:maximum>=e)?void 0:i?D(e,"no more than nor equal to "+maximum,r):D(e,"no more than "+maximum,r)},maxItems:function maxItems(e,t,n){return b.isArray(e)?U("maxItems",e,t,n):void 0},maxLength:function maxLength(e,t,n){return U("maxLength",e,t,n)},maxProperties:function maxProperties(e,t,n){if(b.isObject(e)){var maxProperties=t.maxProperties,r=Object.keys(e).length;return r>maxProperties?D(r,"no more than "+maxProperties+" properties",n):void 0}},minimum:function minimum(e,n,r){var minimum=n.minimum,i=n.exclusiveMinimum;return("undefined"==typeof e?"undefined":t.typeof(e))!==("undefined"==typeof minimum?"undefined":t.typeof(minimum))||(i?e>minimum:e>=minimum)?void 0:i?D(e,"no less than nor equal to "+minimum,r):D(e,"no less than "+minimum,r)},minItems:function minItems(e,t,n){return b.isArray(e)?q("minItems",e,t,n):void 0},minLength:function minLength(e,t,n){return q("minLength",e,t,n)},minProperties:function minProperties(e,t,n){if(b.isObject(e)){var minProperties=t.minProperties,r=Object.keys(e).length;return minProperties>r?D(r,"no more than "+minProperties+" properties",n):void 0}},multipleOf:function multipleOf(e,t,n){var multipleOf=t.multipleOf;return b.isNumber(e)&&e/multipleOf%1!==0?D(e,"multipleOf "+multipleOf,n):void 0},not:function not(e,t,n){return z(e,t.not,n)?void 0:D("succeeded","should have failed",n)},oneOf:function oneOf(e,t,n){var r=!1,i=[];return t.oneOf.forEach(function(t){var o=z(e,t,n);if(o)i=i.concat(o);else{if(r)return i=[D("valid against more than one","valid against only one",n)],r=!1,!1;r=!0}}),r?void 0:i},pattern:function pattern(e,t,n){var pattern=t.pattern;return b.isString(e)&&!e.match(pattern)?D(e,pattern,n):void 0;
},properties:function properties(e,t,n){n||(n={});var r=b.isUndefined(t.additionalProperties)?!0:t.additionalProperties,i={},properties=t.properties||{},o=t.patternProperties||{},a=[];b.forOwn(e,function(e,t){i[t]=void 0}),b.forOwn(properties||{},function(t,r){b.isUndefined(e[r])&&!b.isUndefined(t.default)&&(e[r]=b.copy(t.default)),n.prop=r,a=a.concat(z(e[r],t,n)||[]),delete i[r]}),b.forOwn(o,function(t,r){b.forOwn(i,function(o,s){s.match(r)&&(n.prop=s,a=a.concat(z(e[s],t,n)||[]),delete i[s])})});var s=Object.keys(i);return r===!1?s.length&&T("extra fields: "+s.join(", "),"no extra fields",n,a):b.isObject(r)&&s.forEach(function(t){n.prop=t,a=a.concat(z(e[t],r,n)||[])}),a.length?a:void 0},required:function required(e,t,n){n||(n={});var required=t.required,r=[];return n.existingOnly||required.forEach(function(t){if(b.isUndefined(b.get(e,t))){var i=n.prop;n.prop=t,T(void 0,"a value",n,r),n.prop=i}}),r.length?r:void 0},type:function type(e,n,r){var type=n.type,i=void 0;if(b.isString(type)&&(type=[type]),type.forEach(function(t){return P[t](e,n,r)?(i=t,!1):void 0}),!i)return D(b.isUndefined(e)||null===e?""+e:"undefined"==typeof e?"undefined":t.typeof(e),"one of ("+type.join(", ")+")",r);var o=ae[i];return o?o(e,n,r):void 0},uniqueItems:function uniqueItems(e,t,n){if(e&&e.length&&t.uniqueItems){var r=e.length,i=void 0,o=void 0,a=void 0;for(o=r-1;o>0;o--)for(i=e[o],a=o-1;a>=0;a--)if(b.deepEqual(i,e[a]))return D(i,"no duplicates",n)}}},Q=function validateKeyword(e,t,n,r){return!b.isUndefined(n[e])&&J[e](t,n,r)},B=function runOps(e,t,n,r){var i=[];return e.forEach(function(e){i=i.concat(Q(e,t,n,r)||[])}),i.length?i:void 0},$=["enum","type","allOf","anyOf","oneOf","not"],G=["items","maxItems","minItems","uniqueItems"],W=["multipleOf","maximum","minimum"],V=["maxProperties","minProperties","required","properties","dependencies"],H=["maxLength","minLength","pattern"],Y=function validateAny(e,t,n){return B($,e,t,n)},z=function _validate(e,t,n){var r=[];n||(n={});var i=void 0,o=n.prop;if(!b.isUndefined(t)){if(!b.isObject(t))throw b.err(L+"#validate")(500,'Invalid schema at path: "'+n.path+'"');return b.isUndefined(n.path)&&(n.path=[]),b.isUndefined(n.prop)||(i=!0,n.path.push(n.prop),n.prop=void 0),t.extends&&(r=b.isFunction(t.extends.validate)?r.concat(t.extends.validate(e,n)||[]):r.concat(_validate(e,t.extends,n)||[])),b.isUndefined(e)?(t.required!==!0||n.existingOnly||T(e,"a value",n,r),i&&(n.path.pop(),n.prop=o),r.length?r:void 0):(r=r.concat(Y(e,t,n)||[]),i&&(n.path.pop(),n.prop=o),r.length?r:void 0)}},X="changing",Z="changed",ee="creating",te="eventId",ne="noValidate",re="silent",ie="validation failed",oe=function makeDescriptor(e,t,n){var r={configurable:!0,enumerable:b.isUndefined(t.enumerable)?!0:!!t.enumerable},i="props."+e,o="previous."+e,a=n.getter,s=n.setter,u=n.unsetter;return r.get=function(){return this._get(i)},b.isFunction(t.get)&&!function(){var e=r.get;r.get=function(){return t.get.call(this,e)}}(),r.set=function(n){var r=this,c=this[a],l=this[s],f=this[u];if(!c(ne)){var d=t.validate(n);if(d){var h=new Error(ie);throw h.errors=d,h}}return t.track&&!c(ee)&&!function(){var t=c(o),a=c(i),s=c(X),u=c(Z);s||(u=[]);var d=u.indexOf(e);a!==n&&-1===d&&u.push(e),t===n&&d>=0&&u.splice(d,1),u.length||(s=!1,f(X),f(Z),c(te)&&(clearTimeout(c(te)),f(te))),!s&&u.length&&(l(Z,u),l(X,!0),l(te,setTimeout(function(){if(f(Z),f(te),f(X),!c(re)){var e=void 0;for(e=0;e<u.length;e++)r.emit("change:"+u[e],r,b.get(r,u[e]));r.emit("change",r,r.changes())}f(re)},0)))}(),l(i,n),n},b.isFunction(t.set)&&!function(){var e=r.set;r.set=function(n){return t.set.call(this,n,e)}}(),r},ae={array:function array(e,t,n){return B(G,e,t,n)},integer:function integer(e,t,n){return ae.numeric(e,t,n)},number:function number(e,t,n){return ae.numeric(e,t,n)},numeric:function numeric(e,t,n){return B(W,e,t,n)},object:function object(e,t,n){return B(V,e,t,n)},string:function string(e,t,n){return B(H,e,t,n)}},se=Component.extend({constructor:Schema,apply:function apply(e,t){t||(t={}),t.getter=t.getter||"_get",t.setter=t.setter||"_set",t.unsetter=t.unsetter||"_unset";var n=this.properties||{};b.forOwn(n,function(n,r){Object.defineProperty(e,r,oe(r,n,t))})},validate:function validate(e,t){return z(e,this,t)}},{typeGroupValidators:ae,types:P,validate:z,validationKeywords:J}),ue="belongsTo",ce="hasMany",le="hasOne",fe="Relation";Relation.extend=b.extend,b.addHiddenPropsToTarget(Relation.prototype,{get canAutoAddLinks(){return b.isUndefined(this.add)||!!this.add},get relatedCollection(){return this.mapper.datastore.getCollection(this.relation)},validateOptions:function validateOptions(e,t){var n="new "+fe,r=t.localField;if(!r)throw b.err(n,"opts.localField")(400,"string",r);var i=t.foreignKey=t.foreignKey||t.localKey;if(!i&&(t.type===ue||t.type===le))throw b.err(n,"opts.foreignKey")(400,"string",i);if(b.isString(e)){if(t.relation=e,!b.isFunction(t.getRelation))throw b.err(n,"opts.getRelation")(400,"function",t.getRelation)}else{if(!e)throw b.err(n,"related")(400,"Mapper or string",e);t.relation=e.name}},assignTo:function assignTo(e){this.name=e.name,Object.defineProperty(this,"mapper",{value:e}),e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(this),e.relationFields.push(this.localField)},canFindLinkFor:function canFindLinkFor(){return Boolean(this.foreignKey||this.localKey)},getRelation:function getRelation(){return this.relatedMapper},getForeignKey:function getForeignKey(e){return b.get(e,this.mapper.idAttribute)},setForeignKey:function setForeignKey(e,t){e&&t&&this._setForeignKey(e,t)},_setForeignKey:function _setForeignKey(e,t){var n=this,r=this.mapper.idAttribute;b.isArray(t)||(t=[t]),t.forEach(function(t){b.set(t,n.foreignKey,b.get(e,r))})},getLocalField:function getLocalField(e){return b.get(e,this.localField)},setLocalField:function setLocalField(e,t){return b.set(e,this.localField,t)},getInverse:function getInverse(e){return this.inverse||this.findInverseRelation(e),this.inverse},findInverseRelation:function findInverseRelation(e){var t=this;this.getRelation().relationList.forEach(function(n){return n.getRelation()===e&&t.isInversedTo(n)?(t.inverse=n,!0):void 0})},isInversedTo:function isInversedTo(e){return!e.foreignKey||e.foreignKey===this.foreignKey},linkRecords:function linkRecords(e,t){var n=this,r=this.mapper.datastore;t.forEach(function(t){var i=n.getLocalField(t);b.isFunction(n.add)?i=n.add(r,n,t):i&&(i=n.linkRecord(t,i));var o=!i||b.isArray(i)&&!i.length;o&&n.canFindLinkFor(t)&&(i=n.findExistingLinksFor(e,t)),i&&n.setLocalField(t,i)})},linkRecord:function linkRecord(e,t){var n=b.get(t,this.mapper.idAttribute);return t!==this.relatedCollection.get(n)&&(this.setForeignKey(e,t),this.canAutoAddLinks&&(t=this.relatedCollection.add(t))),t},findExistingLinksByForeignKey:function findExistingLinksByForeignKey(e){return this.relatedCollection.filter(t.defineProperty({},this.foreignKey,e))}});var de=Relation.extend({getForeignKey:function getForeignKey(e){return b.get(e,this.foreignKey)},_setForeignKey:function _setForeignKey(e,t){b.set(e,this.foreignKey,b.get(t,this.getRelation().idAttribute))},findExistingLinksFor:function findExistingLinksFor(e,t){var n=b.get(t,this.foreignKey);return b.isUndefined(n)?void 0:this.relatedCollection.get(n)}},{TYPE_NAME:"belongsTo"}),he=Relation.extend({validateOptions:function validateOptions(e,t){Relation.prototype.validateOptions.call(this,e,t);var n=t.localKeys,r=t.foreignKeys,i=t.foreignKey;if(!i&&!n&&!r)throw b.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",i)},canFindLinkFor:function canFindLinkFor(e){var t=this.foreignKey||this.foreignKeys;return Boolean(t||this.localKeys&&b.get(e,this.localKeys))},linkRecord:function linkRecord(e,t){var n=this,r=this.relatedCollection;return t.map(function(t){var i=r.recordId(t);return t!==r.get(i)&&(n.foreignKey&&n.setForeignKey(e,t),n.canAutoAddLinks&&(t=r.add(t))),t})},findExistingLinksFor:function findExistingLinksFor(e,t){var n=b.get(t,e.idAttribute),r=this.localKeys?b.get(t,this.localKeys):null,i=void 0;return this.foreignKey?i=this.findExistingLinksByForeignKey(n):this.localKeys&&r?i=this.findExistingLinksByLocalKeys(r):this.foreignKeys&&(i=this.findExistingLinksByForeignKeys(n)),i&&i.length?i:void 0},findExistingLinksByLocalKeys:function findExistingLinksByLocalKeys(e){return this.relatedCollection.filter({where:t.defineProperty({},this.mapper.idAttribute,{in:e})})},findExistingLinksByForeignKeys:function findExistingLinksByForeignKeys(e){return this.relatedCollection.filter({where:t.defineProperty({},this.foreignKeys,{contains:e})})}},{TYPE_NAME:"hasMany"}),pe=Relation.extend({findExistingLinksFor:function findExistingLinksFor(e,t){var n=b.get(t,e.idAttribute),r=this.findExistingLinksByForeignKey(n);return r.length?r[0]:void 0}},{TYPE_NAME:"hasOne"});[de,he,pe].forEach(function(e){Relation[e.TYPE_NAME]=function(t,n){return new e(t,n)}});var ve=function belongsTo(e,t){return function(n){Relation.belongsTo(e,t).assignTo(n)}},ge=function hasMany(e,t){return function(n){Relation.hasMany(e,t).assignTo(n)}},ye=function hasOne(e,t){return function(n){Relation.hasOne(e,t).assignTo(n)}},me="Mapper",be=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"],Ae=function makeNotify(e){return function(){for(var t=this,n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];var o=r[r.length-e],a=o.op;if(this.dbg.apply(this,[a].concat(r)),-1!==be.indexOf(a)&&o.validate!==!1){var s=o.existingOnly;0===a.indexOf("beforeUpdate")&&b.isUndefined(o.existingOnly)&&(o.existingOnly=!0);var u=this.validate(r["beforeUpdate"===a?1:0],b.pick(o,["existingOnly"]));if(o.existingOnly=s,u)return b.reject(u)}(o.notify||void 0===o.notify&&this.notify)&&setTimeout(function(){t.emit.apply(t,[a].concat(r))})}},_e=Ae(1),Oe=Ae(2),xe={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function adapterArgs(e,t,n,r){return[t,e.toJSON(n,r),r]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function adapterArgs(e,t,n,r){return[e.toJSON(t,r),n,r]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function adapterArgs(e,t,n){return[t.map(function(t){return e.toJSON(t,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},we={_adapters:{},applySchema:!0,debug:!1,defaultAdapter:"http",idAttribute:"id",notify:!0,raw:!1},Ce=Component.extend({constructor:Mapper,afterCount:Oe,afterCreate:Oe,afterCreateMany:Oe,afterDestroy:Oe,afterDestroyAll:Oe,afterFind:Oe,afterFindAll:Oe,afterSum:Oe,afterUpdate:Oe,afterUpdateAll:Oe,afterUpdateMany:Oe,beforeCreate:_e,beforeCreateMany:_e,beforeCount:_e,beforeDestroy:_e,beforeDestroyAll:_e,beforeFind:_e,beforeFindAll:_e,beforeSum:_e,beforeUpdate:_e,beforeUpdateAll:_e,beforeUpdateMany:_e,_end:function _end(e,t,n){if(t.raw&&b._(e,t),n)return e;var r=t.raw?e.data:e;return r&&b.isFunction(this.wrap)&&(r=this.wrap(r,t),t.raw?e.data=r:e=r),e},belongsTo:function belongsTo$$(e,t){return ve(e,t)(this)},count:function count(e,t){return this.crud("count",e,t)},create:function create(e,t){var n=this,r=void 0,i=void 0;return e||(e={}),t||(t={}),b._(t,this),i=t.adapter=this.getAdapterName(t),r=t.op="beforeCreate",b.resolve(this[r](e,t)).then(function(o){e=b.isUndefined(o)?e:o;var a={};t.with||(t.with=[]);var s=[];return b.forEachRelation(n,t,function(t,n){var r=t.getLocalField(e),i=t.getRelation(),o=i.idAttribute;n.raw=!1,r&&(t.type===ue?s.push(i.create(r,n).then(function(n){t.setLocalField(a,n),t.setForeignKey(e,n)})):t.type===ce&&t.localKeys&&s.push(i.createMany(r,n).then(function(n){t.setLocalField(a,n),b.set(e,t.localKeys,n.map(function(e){return b.get(e,o)}))})))}),b.Promise.all(s).then(function(){return r=t.op="create",n.dbg(r,e,t),b.resolve(n.getAdapter(i)[r](n,n.toJSON(e,{with:t.pass||[]}),t))}).then(function(r){var i=t.raw?r.data:r;return s=[],b.forEachRelation(n,t,function(t,n){var r=t.getLocalField(e);if(r){n.raw=!1;var o=void 0;t.type===ce&&t.foreignKey?(t.setForeignKey(i,r),o=t.getRelation().createMany(r,n).then(function(e){t.setLocalField(i,e)})):t.type===le?(t.setForeignKey(i,r),o=t.getRelation().create(r,n).then(function(e){t.setLocalField(i,e)})):t.type===ue&&t.getLocalField(a)?t.setLocalField(i,t.getLocalField(a)):t.type===ce&&t.localKeys&&t.getLocalField(a)&&t.setLocalField(i,t.getLocalField(a)),o&&s.push(o)}}),b.Promise.all(s).then(function(){return r})})}).then(function(i){return i=n._end(i,t),r=t.op="afterCreate",b.resolve(n[r](e,t,i)).then(function(e){return b.isUndefined(e)?i:e})})},createInstance:function createInstance(e,t){return this.createRecord(e,t)},createMany:function createMany(e,t){var n=this,r=void 0,i=void 0;return e||(e=[]),t||(t={}),b._(t,this),i=t.adapter=this.getAdapterName(t),r=t.op="beforeCreateMany",b.resolve(this[r](e,t)).then(function(o){e=b.isUndefined(o)?e:o;var a={};t.with||(t.with=[]);var s=[];return b.forEachRelation(n,t,function(t,n){var r=e.map(function(e){return t.getLocalField(e)}).filter(function(e){return e});t.type===ue&&r.length===e.length&&s.push(t.getRelation().createMany(r,n).then(function(r){var i=n.raw?r.data:r;t.setLocalField(a,i),e.forEach(function(e,n){t.setForeignKey(e,i[n])})}))}),b.Promise.all(s).then(function(){r=t.op="createMany";var o=e.map(function(e){return n.toJSON(e,{with:t.pass||[]})});return n.dbg(r,e,t),b.resolve(n.getAdapter(i)[r](n,o,t))}).then(function(r){var i=t.raw?r.data:r;return s=[],b.forEachRelation(n,t,function(r,o){var u=e.map(function(e){return r.getLocalField(e)}).filter(function(e){return e});if(u.length===e.length){var c=r.getLocalField(a),l=void 0;r.type===ce?n.log("warn","deep createMany of hasMany type not supported!"):r.type===le?(i.forEach(function(e,t){r.setForeignKey(e,u[t])}),l=r.getRelation().createMany(u,o).then(function(e){var n=t.raw?e.data:e;i.forEach(function(e,t){r.setLocalField(e,n[t])})})):r.type===ue&&c&&c.length===i.length&&i.forEach(function(e,t){r.setLocalField(e,c[t])}),l&&s.push(l)}}),b.Promise.all(s).then(function(){return r})})}).then(function(i){return i=n._end(i,t),r=t.op="afterCreateMany",b.resolve(n[r](e,t,i)).then(function(e){return b.isUndefined(e)?i:e})})},createRecord:function createRecord(e,t){var n=this;if(e||(e={}),b.isArray(e))return e.map(function(e){return n.createRecord(e,t)});if(!b.isObject(e))throw b.err(me+"#createRecord","props")(400,"array or object",e);var r=this.recordClass,i=this.relationList||[];return i.forEach(function(n){var r=n.getRelation(),i=n.getLocalField(e);if(i&&!r.is(i)){if(b.isArray(i)&&(!i.length||r.is(i[0])))return;b.set(e,n.localField,r.createRecord(i,t))}}),r?e instanceof r?e:new r(e,t):e},crud:function crud(e){for(var n=this,r=arguments.length,i=Array(r>1?r-1:0),o=1;r>o;o++)i[o-1]=arguments[o];var a=this.lifecycleMethods[e];if(!a)throw b.err(me+"#crud",e)(404,"method");var s=""+e.charAt(0).toUpperCase()+e.substr(1),u="before"+s,c="after"+s,l=void 0,f=void 0;a.defaults.forEach(function(e,t){b.isUndefined(i[t])&&(i[t]=b.copy(e))});var d=i[i.length-1];return b._(d,this),f=d.adapter=this.getAdapterName(d),l=d.op=u,b.resolve(this[l].apply(this,t.toConsumableArray(i))).then(function(r){var o;return b.isUndefined(i[a.beforeAssign])||(i[a.beforeAssign]=b.isUndefined(r)?i[a.beforeAssign]:r),l=d.op=e,i=a.adapterArgs?a.adapterArgs.apply(a,[n].concat(t.toConsumableArray(i))):i,n.dbg.apply(n,[l].concat(t.toConsumableArray(i))),b.resolve((o=n.getAdapter(f))[l].apply(o,[n].concat(t.toConsumableArray(i))))}).then(function(e){return e=n._end(e,d,!!a.skip),i.push(e),l=d.op=c,b.resolve(n[l].apply(n,t.toConsumableArray(i))).then(function(t){return b.isUndefined(t)?e:t})})},destroy:function destroy(e,t){return this.crud("destroy",e,t)},destroyAll:function destroyAll(e,t){return this.crud("destroyAll",e,t)},find:function find(e,t){return this.crud("find",e,t)},findAll:function findAll(e,t){return this.crud("findAll",e,t)},getAdapter:function getAdapter(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw b.err(me+"#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e||(e={}),b.isString(e)&&(e={adapter:e}),e.adapter||e.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getSchema:function getSchema(){return this.schema},hasMany:function hasMany$$(e,t){return ge(e,t)(this)},hasOne:function hasOne$$(e,t){return ye(e,t)(this)},is:function is(e){var t=this.recordClass;return t?e instanceof t:!1},registerAdapter:function registerAdapter(e,t,n){n||(n={}),this.getAdapters()[e]=t,(n===!0||n.default)&&(this.defaultAdapter=e)},sum:function sum(e,t,n){return this.crud("sum",e,t,n)},toJSON:function toJSON(e,t){var n=this,r=void 0;if(t||(t={}),b.isArray(e))return e.map(function(e){return n.toJSON(e,t)});r=e;var i=(this?this.relationFields:[])||[],o={},a=void 0;if(this&&this.schema&&(a=this.schema.properties||{},b.forOwn(a,function(e,t){o[t]=b.plainCopy(r[t])})),a||(a={}),!t.strict)for(var s in r)a[s]||-1!==i.indexOf(s)||(o[s]=b.plainCopy(r[s]));return this&&t.withAll&&(t.with=i.slice()),this&&t.with&&(b.isString(t.with)&&(t.with=[t.with]),b.forEachRelation(this,t,function(e,t){var n=e.getLocalField(r);n&&(b.isArray(n)?e.setLocalField(o,n.map(function(n){return e.getRelation().toJSON(n,t)})):e.setLocalField(o,e.getRelation().toJSON(n,t)))})),o},update:function update(e,t,n){return this.crud("update",e,t,n)},updateAll:function updateAll(e,t,n){return this.crud("updateAll",e,t,n)},updateMany:function updateMany(e,t){return this.crud("updateMany",e,t)},validate:function validate(e,t){t||(t={});var n=this.getSchema(),r=b.pick(t,["existingOnly"]);if(!b.isArray(e))return n.validate(e,r);var i=e.map(function(e){return n.validate(e,b.pick(r,["existingOnly"]))}),o=!1;return i.forEach(function(e){e&&(o=!0)}),o?i:void 0},wrap:function wrap(e,t){return this.createRecord(e,t)},defineRelations:function defineRelations(){var e=this;b.forOwn(this.relations,function(t,n){b.forOwn(t,function(t,r){b.isObject(t)&&(t=[t]),t.forEach(function(t){var i=e.datastore.getMapperByName(r)||r;if(t.getRelation=function(){return e.datastore.getMapper(r)},"function"!=typeof Relation[n])throw b.err(me,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",n,!0);e[n](i,t)})})})}}),Ee="Container",Fe=["count","create","createMany","createRecord","dbg","destroy","destroyAll","find","findAll","getSchema","is","log","sum","toJSON","update","updateAll","updateMany","validate"],Re={constructor:Container,_onMapperEvent:function _onMapperEvent(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=n.shift();this.emit.apply(this,[i,e].concat(n))},as:function as(e){var t=this,n={};return Fe.forEach(function(t){n[t]={writable:!0,value:function value(){var n;return(n=this.getMapper(e))[t].apply(n,arguments)}}}),n.getMapper={writable:!0,value:function value(){return t.getMapper(e)}},Object.create(this,n)},defineMapper:function defineMapper(e,t){var n=this;if(b.isObject(e)&&(t=e,e=t.name),!b.isString(e))throw b.err(Ee+"#defineMapper","name")(400,"string",e);t||(t={}),t.name=e,t.relations||(t.relations={});var r=t.mapperClass||this.mapperClass;delete t.mapperClass,b.fillIn(t,this.mapperDefaults);var i=this._mappers[e]=new r(t);return i.relations||(i.relations={}),i.name=e,i._adapters=this.getAdapters(),i.datastore=this,i.on("all",function(){for(var t=arguments.length,r=Array(t),i=0;t>i;i++)r[i]=arguments[i];return n._onMapperEvent.apply(n,[e].concat(r))}),i.defineRelations(),i},defineResource:function defineResource(e,t){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(e,t)},getAdapter:function getAdapter(e){var t=this.getAdapterName(e);if(!t)throw b.err(Ee+"#getAdapter","name")(400,"string",e);return this.getAdapters()[t]},getAdapterName:function getAdapterName(e){return e||(e={}),b.isString(e)&&(e={adapter:e}),e.adapter||this.mapperDefaults.defaultAdapter},getAdapters:function getAdapters(){return this._adapters},getMapper:function getMapper(e){var t=this.getMapperByName(e);if(!t)throw b.err(Ee+"#getMapper",e)(404,"mapper");return t},getMapperByName:function getMapperByName(e){return this._mappers[e]},registerAdapter:function registerAdapter(e,t,n){n||(n={}),this.getAdapters()[e]=t,(n===!0||n.default)&&(this.mapperDefaults.defaultAdapter=e,b.forOwn(this._mappers,function(t){t.defaultAdapter=e}))}};Fe.forEach(function(e){Re[e]=function(t){for(var n,r=arguments.length,i=Array(r>1?r-1:0),o=1;r>o;o++)i[o-1]=arguments[o];return(n=this.getMapper(t))[e].apply(n,i)}}),Component.extend(Re);var Ie="LinkedCollection",ke=k.extend({constructor:LinkedCollection,_onRecordEvent:function _onRecordEvent(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];b.getSuper(this).prototype._onRecordEvent.apply(this,t);var r=t[0];b.isString(r)&&0===r.indexOf("change")&&this.updateIndexes(t[1])},add:function add(e,t){var n=this,r=this.mapper,i=(new Date).getTime(),o=b.isObject(e)&&!b.isArray(e);return o&&(e=[e]),e=b.getSuper(this).prototype.add.call(this,e,t),r.relationList.length&&e.length&&r.relationList.forEach(function(t){t.linkRecords(r,e)}),e.forEach(function(e){return n._addMeta(e,i)}),o?e[0]:e},remove:function remove(e,t){var n=(this.mapper,b.getSuper(this).prototype.remove.call(this,e,t));return n&&this._clearMeta(n),n},removeAll:function removeAll(e,t){var n=(this.mapper,b.getSuper(this).prototype.removeAll.call(this,e,t));return n.forEach(this._clearMeta,this),n},_clearMeta:function _clearMeta(e){delete this._added[this.recordId(e)],this.mapper.recordClass&&e._set("$")},_addMeta:function _addMeta(e,t){this._added[this.recordId(e)]=t,this.mapper.recordClass&&e._set("$",t)}}),je="DataStore",Se=["add","between","createIndex","filter","get","getAll","query","toJson"],Me=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],Le=function safeSet(e,t,n){e&&e._set?e._set("props."+t,n):b.set(e,t,n)},Pe=function cachedFn(e,t,n){var r=this._completedQueries[e][t];return b.isFunction(r)?r(e,t,n):r},Ke={constructor:DataStore,_callSuper:function _callSuper(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return this.constructor.__super__.prototype[e].apply(this,n)},_end:function _end(e,t,n){var r=n.raw?t.data:t;return r&&b.isFunction(this.addToCache)&&(r=this.addToCache(e,r,n),n.raw?t.data=r:t=r),t},_onCollectionEvent:function _onCollectionEvent(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=n.shift();this.emit.apply(this,[i,e].concat(n))},addToCache:function addToCache(e,t,n){return this.getCollection(e).add(t,n)},as:function as(e){var t=this,n={};return Me.forEach(function(t){n[t]={writable:!0,value:function value(){for(var n=arguments.length,r=Array(n),i=0;n>i;i++)r[i]=arguments[i];return this[t].apply(this,[e].concat(r))}}}),Fe.forEach(function(t){n[t]={writable:!0,value:function value(){var n;return(n=this.getMapper(e))[t].apply(n,arguments)}}}),n.getMapper={writable:!0,value:function value(){return t.getMapper(e)}},Se.forEach(function(t){n[t]={writable:!0,value:function value(){var n;return(n=this.getCollection(e))[t].apply(n,arguments)}}}),n.getCollection={writable:!0,value:function value(){return t.getCollection(e)}},Object.create(this,n)},cachedFind:Pe,cachedFindAll:Pe,cacheFind:function cacheFind(e,t,n,r){var i=this;this._completedQueries[e][n]=function(e,t,n){return i.get(e,t)}},cacheFindAll:function cacheFindAll(e,t,n,r){var i=this;this._completedQueries[e][n]=function(e,t,n){return i.filter(e,b.fromJson(t))}},clear:function clear(){var e={};return b.forOwn(this._collections,function(t,n){e[n]=t.removeAll()}),e},create:function create(e,t,n){var r=this;return n||(n={}),this._callSuper("create",e,t,n).then(function(t){return r._end(e,t,n)})},createMany:function createMany(e,t,n){var r=this;return n||(n={}),this._callSuper("createMany",e,t,n).then(function(t){return r._end(e,t,n)})},defineMapper:function defineMapper(e,t){var n=this,r=b.getSuper(n).prototype.defineMapper.call(n,e,t);n._pendingQueries[e]={},n._completedQueries[e]={},r.relationList||Object.defineProperty(r,"relationList",{value:[]});var i=n._collections[e]=new n.collectionClass(null,{_added:{},datastore:n,mapper:r}),o=r.schema||{},a=o.properties||{};b.forOwn(a,function(e,t){e.indexed&&i.createIndex(t)}),i.createIndex("addedTimestamps",["$"],{fieldGetter:function fieldGetter(e){return i._added[i.recordId(e)]}}),i.on("all",function(){for(var t=arguments.length,r=Array(t),i=0;t>i;i++)r[i]=arguments[i];n._onCollectionEvent.apply(n,[e].concat(r))});var s=r.idAttribute;return r.relationList.forEach(function(e){var t=e.relation,o=e.localField,a="links."+o,u=e.foreignKey,c=e.type,l={index:u},f=void 0,d=function getter(){return this._get(a)};c===ue?!function(){i.indexes[u]||i.createIndex(u),f={get:d,set:function set(o){var c=this,f=this._get(a);if(o===f)return f;var d=b.get(c,s),h=e.getInverse(r);if(o){var p=e.getRelation().idAttribute,v=b.get(o,p);if(b.isUndefined(v)||(o=n.get(t,v)||o),c._set(a,o),Le(c,u,v),i.updateIndex(c,l),h.type===le)b.set(o,h.localField,c);else if(h.type===ce){var g=b.get(o,h.localField);b.noDupeAdd(g,c,function(e){return d===b.get(e,s)})}}else c._set(a,void 0),Le(c,u,void 0),i.updateIndex(c,l);if(f)if(h.type===le)b.set(f,h.localField,void 0);else if(h.type===ce){var y=b.get(f,h.localField);b.remove(y,function(e){return d===b.get(e,s)})}return o}};var c=Object.getOwnPropertyDescriptor(r.recordClass.prototype,u);c||(c={enumerable:!0});var h=c.get;c.get=function(){return h?h.call(this):this._get("props."+u)};var p=c.set;c.set=function(e){if(p&&p.call(this,e),b.isUndefined(e))b.set(this,o,void 0);else{Le(this,u,e);var r=n.get(t,e);r&&b.set(this,o,r)}},Object.defineProperty(r.recordClass.prototype,u,c)}():c===ce?!function(){var i=e.localKeys,o=e.foreignKeys;n._collections[t]&&u&&!n.getCollection(t).indexes[u]&&n.getCollection(t).createIndex(u),f={get:function get(){var e=this,t=d.call(e);return t||e._set(a,[]),d.call(e)},set:function set(c){var f=this;c||(c=[]),c&&!b.isArray(c)&&(c=[c]);var d=b.get(f,s),h=e.getRelation().idAttribute,p=e.getInverse(r),v=p.localField,g=f._get(a);g||(g=[]);var y=g;g=[];var m={};return c.forEach(function(e){var r=b.get(e,h);b.isUndefined(r)||(e=n.get(t,r)||e,m[r]=e),g.push(e)}),u?(c.forEach(function(e){Le(e,u,d),n.getCollection(t).updateIndex(e,l),b.set(e,v,f)}),y.forEach(function(e){var r=b.get(e,h);b.isUndefined(r)||m.hasOwnProperty(r)||(Le(e,u,void 0),n.getCollection(t).updateIndex(e,l),b.set(e,v,void 0))})):i?!function(){var e=[];c.forEach(function(t){b.set(t,v,f),e.push(b.get(t,h))}),b.set(f,i,e),y.forEach(function(e){var t=b.get(e,h);b.isUndefined(t)||m.hasOwnProperty(t)||b.set(e,v,void 0)})}():o&&(y.forEach(function(e){var t=b.get(e,o)||[];b.remove(t,function(e){return d===e});var n=b.get(e,v)||[];b.remove(n,function(e){return d===b.get(e,s)})}),c.forEach(function(e){var t=b.get(e,o)||[];b.noDupeAdd(t,d,function(e){return d===e});var n=b.get(e,v)||[];b.noDupeAdd(n,f,function(e){return d===b.get(e,s)})})),f._set(a,g),g}}}():c===le&&(n._collections[t]&&u&&!n.getCollection(t).indexes[u]&&n.getCollection(t).createIndex(u),f={get:d,set:function set(i){var o=this,c=this._get(a);if(i===c)return c;var f=b.get(i,e.getRelation().idAttribute),d=e.getInverse(r).localField;return c&&(Le(c,u,void 0),n.getCollection(t).updateIndex(c,l),b.set(c,d,void 0)),i?(b.isUndefined(f)||(i=n.get(t,f)||i),o._set(a,i),Le(i,u,b.get(o,s)),n.getCollection(t).updateIndex(i,l),b.set(i,d,o)):o._set(a,void 0),i}}),f&&(f.enumerable=b.isUndefined(e.enumerable)?!1:e.enumerable,e.get&&!function(){var t=f.get;f.get=function(){var n=this;return e.get(e,this,function(){for(var e=arguments.length,r=Array(e),i=0;e>i;i++)r[i]=arguments[i];return t.apply(n,r)})}}(),e.set&&!function(){var t=f.set;f.set=function(n){var r=this;return e.set(e,this,n,function(e){return t.call(r,void 0===e?n:e)})}}(),Object.defineProperty(r.recordClass.prototype,o,f))}),r},destroy:function destroy(e,t,n){var r=this;return n||(n={}),this._callSuper("destroy",e,t,n).then(function(i){return n.raw?i.data=r.getCollection(e).remove(t,n):i=r.getCollection(e).remove(t,n),delete r._pendingQueries[e][t],delete r._completedQueries[e][t],i})},destroyAll:function destroyAll(e,t,n){var r=this;return n||(n={}),this._callSuper("destroyAll",e,t,n).then(function(i){n.raw?i.data=r.getCollection(e).removeAll(t,n):i=r.getCollection(e).removeAll(t,n);var o=r.hashQuery(e,t,n);return delete r._pendingQueries[e][o],delete r._completedQueries[e][o],i})},eject:function eject(e,t,n){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(e,t,n)},ejectAll:function ejectAll(e,t,n){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(e,t,n)},find:function find(e,t,n){var r=this;n||(n={});var i=this._pendingQueries[e][t];if(b.fillIn(n,this.getMapper(e)),i)return i;var o=this.cachedFind(e,t,n),a=void 0;return a=n.force||!o?this._pendingQueries[e][t]=this._callSuper("find",e,t,n).then(function(i){return delete r._pendingQueries[e][t],i=r._end(e,i,n),r.cacheFind(e,i,t,n),i},function(n){return delete r._pendingQueries[e][t],b.reject(n)}):b.resolve(o)},findAll:function findAll(e,t,n){var r=this;n||(n={});var i=this.hashQuery(e,t,n),o=this._pendingQueries[e][i];if(b.fillIn(n,this.getMapper(e)),o)return o;var a=this.cachedFindAll(e,i,n),s=void 0;return s=n.force||!a?this._pendingQueries[e][i]=this._callSuper("findAll",e,t,n).then(function(t){return delete r._pendingQueries[e][i],t=r._end(e,t,n),r.cacheFindAll(e,t,i,n),t},function(t){return delete r._pendingQueries[e][i],b.reject(t)}):b.resolve(a)},getCollection:function getCollection(e){var t=this._collections[e];if(!t)throw b.err(je+"#getCollection",e)(404,"collection");return t},hashQuery:function hashQuery(e,t,n){return b.toJson(t)},inject:function inject(e,t,n){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(e,t,n)},remove:function remove(e,t,n){var r=this.getCollection(e).remove(t,n);return r&&this.removeRelated(e,[r],n),r},removeAll:function removeAll(e,t,n){var r=this.getCollection(e).removeAll(t,n);return r.length&&this.removeRelated(e,r,n),r},removeRelated:function removeRelated(e,n,r){var i=this;b.isArray(n)||(n=[n]),b.forEachRelation(this.getMapper(e),r,function(e,r){n.forEach(function(n){var o=void 0,a=void 0;if(!e.foreignKey||e.type!==le&&e.type!==ce?e.type===ce&&e.localKeys?a={where:t.defineProperty({},e.getRelation().idAttribute,{in:b.get(n,e.localKeys)})}:e.type===ce&&e.foreignKeys?a={where:t.defineProperty({},e.foreignKeys,{contains:e.getForeignKey(n)})}:e.type===ue&&(o=i.remove(e.relation,e.getForeignKey(n),r)):a=t.defineProperty({},e.foreignKey,e.getForeignKey(n)),a&&(o=i.removeAll(e.relation,a,r)),o){if(b.isArray(o)&&!o.length)return;e.type===le&&(o=o[0]),e.setLocalField(n,o)}})})},update:function update(e,t,n,r){var i=this;return r||(r={}),this._callSuper("update",e,t,n,r).then(function(t){return i._end(e,t,r)})},updateAll:function updateAll(e,t,n,r){var i=this;return r||(r={}),this._callSuper("updateAll",e,n,t,r).then(function(t){return i._end(e,t,r)})},updateMany:function updateMany(e,t,n){var r=this;return n||(n={}),this._callSuper("updateMany",e,t,n).then(function(t){return r._end(e,t,n)})}};Se.forEach(function(e){Ke[e]=function(t){for(var n,r=arguments.length,i=Array(r>1?r-1:0),o=1;r>o;o++)i[o-1]=arguments[o];return(n=this.getCollection(t))[e].apply(n,i)}});var Ne=Container.extend(Ke),De={beta:7,full:"3.0.0-beta.7",major:3,minor:0,patch:0};e.version=De,e.Collection=k,e.Component=Component,e.Container=Container,e.DataStore=Ne,e.Index=Index,e.LinkedCollection=ke,e.Mapper=Ce,e.Query=F,e.Record=M,e.Schema=se,e.utils=b,e.belongsTo=ve,e.hasMany=ge,e.hasOne=ye,e.belongsToType=ue,e.hasManyType=ce,
e.hasOneType=le});
//# sourceMappingURL=js-data.min.map