!function(){function t(i){this.options=a({},t.DEFAULTS,i)}function a(t){for(var i=1,a=arguments.length;a>i;i++){var e=arguments[i];if(e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}return t}function e(t){return t=16*((t-1/3+1)%2*.5-.5),Math.max(1-t*t,0)}t.DEFAULTS={width:0,height:0,aspect:0,cropWidth:0,cropHeight:0,detailWeight:.2,skinColor:[.78,.57,.44],skinBias:.01,skinBrightnessMin:.2,skinBrightnessMax:1,skinThreshold:.8,skinWeight:1.8,saturationBrightnessMin:.25,saturationBrightnessMax:.9,saturationThreshold:.4,saturationBias:.2,saturationWeight:.3,scoreDownSample:8,step:8,scaleStep:.1,minScale:.9,maxScale:1,edgeRadius:.4,edgeWeight:-20,outsideImportance:-.5,ruleOfThirds:!0,prescale:!0,canvasFactory:null,debug:!1},t.crop=function(i,a,e){if(a.aspect&&(a.width=aspect,a.height=1),i.naturalWidth&&(i.naturalWidth!=i.width||i.naturalHeight!=i.height)){var n=new t(a).canvas(i.naturalWidth,i.naturalHeight),o=n.getContext("2d");n.width=i.naturalWidth,n.height=i.naturalHeight,o.drawImage(i,0,0),i=n}var s=1,d=1;a.width&&a.height&&(s=r(i.width/a.width,i.height/a.height),a.cropWidth=~~(a.width*s),a.cropHeight=~~(a.height*s),a.minScale=r(a.maxScale||t.DEFAULTS.maxScale,h(1/s,a.minScale||t.DEFAULTS.minScale)));var c=new t(a);if(a.width&&a.height&&a.prescale!==!1)if(d=1/s/a.minScale,1>d){var g=c.canvas(i.width*d,i.height*d),u=g.getContext("2d");u.drawImage(i,0,0,i.width,i.height,0,0,g.width,g.height),i=g,c.options.cropWidth=~~(a.cropWidth*d),c.options.cropHeight=~~(a.cropHeight*d)}else d=1;for(var l=c.analyse(i),p=0,f=l.crops.length;f>p;p++){var v=l.crops[p];v.x/=d,v.y/=d,v.width/=d,v.height/=d}return e(l),l},t.prototype={canvas:function(t,i){if(null!==this.options.canvasFactory)return this.options.canvasFactory(t,i);var a=document.createElement("canvas");return a.width=t,a.height=i,a},saturation:function(t,i,a){var e=h(t/255,i/255,a/255),n=r(t/255,i/255,a/255);if(e===n)return 0;var o=(e+n)/2,s=e-n;return o>.5?s/(2-e-n):s/(e+n)},cie:function(t,i,a){return.5126*a+.7152*i+.0722*t},edgeDetect:function(t,i){function a(t){return o(e[t],e[t+1],e[t+2])}for(var e=t.data,r=i.data,h=t.width,n=t.height,o=this.cie,s=0;n>s;s++)for(var d=0;h>d;d++){var c,g=4*(s*h+d);c=0===d||d>=h-1||0===s||s>=n-1?a(g):4*a(g)-a(g-4*h)-a(g-4)-a(g+4)-a(g+4*h),r[g]=c,r[g+1]=c,r[g+2]=c}},skinDetect:function(t,i){for(var a=t.data,e=i.data,r=t.width,h=t.height,n=this.options,o=0;h>o;o++)for(var s=0;r>s;s++){var d=4*(o*r+s),c=this.cie(a[d],a[d+1],a[d+2])/255;skin=this.skinColor(a[d],a[d+1],a[d+2]),skin>n.skinThreshold&&c>=n.skinBrightnessMin&&c<=n.skinBrightnessMax?e[d]=(skin-n.skinThreshold)*(255/(1-n.skinThreshold)):e[d]=0}},saturationDetect:function(t,i){for(var a=t.data,e=i.data,r=t.width,h=t.height,n=this.options,o=0;h>o;o++)for(var s=0;r>s;s++){var d=4*(o*r+s),c=this.cie(a[d],a[d+1],a[d+2])/255;saturation=this.saturation(a[d],a[d+1],a[d+2]),saturation>n.saturationThreshold&&c>=n.saturationBrightnessMin&&c<=n.saturationBrightnessMax?e[d+2]=(saturation-n.saturationThreshold)*(255/(1-n.saturationThreshold)):e[d+2]=0}},crops:function(t){for(var i=[],a=t.width,e=t.height,h=this.options,n=r(a,e),o=h.cropWidth||n,s=h.cropHeight||n,d=h.maxScale;d>=h.minScale;d-=h.scaleStep)for(var c=0;e>=c+s*d;c+=h.step)for(var g=0;a>=g+o*d;g+=h.step)i.push({x:g,y:c,width:o*d,height:s*d});return i},score:function(t,i){for(var a={detail:0,saturation:0,skin:0,total:0},e=this.options,r=t.data,h=e.scoreDownSample,n=1/h,o=0;o<t.height*h;o+=h)for(var s=0;s<t.width*h;s+=h){var d=4*(~~(o*n)*t.width+~~(s*n)),c=this.importance(i,s,o);a.skin+=r[d]/255*(r[d+1]/255+e.skinBias)*c,a.detail+=r[d+1]/255*c,a.saturation+=r[d+2]/255*(r[d+1]/255*1+e.saturationBias)*c}return a.total=(a.detail*e.detailWeight+a.skin*e.skinWeight+a.saturation*e.saturationWeight)/i.width/i.height,a},_score:function(t,i){for(var a={detail:0,saturation:0,skin:0,total:0},e=this.options,r=e.scoreDownSample,h=1/r,n=i.y;n<i.y+i.height;n+=r)for(var o=i.x;o<i.x+i.width;o+=r){var s=4*(~~(n*h)*t.width+~~(o*h));a.detail+=t.data[s+1]/255*this.importance((o-i.x)/i.width,(n-i.y)/i.height),a.saturation+=t.data[s+2]/255*this.importance((o-i.x)/i.width,(n-i.y)/i.height),a.skin+=t.data[s]/255*(t.data[s+1]/255+e.skinBias)*this.importance((o-i.x)/i.width,(n-i.y)/i.height)}return a.total=(a.detail*e.detailWeight+a.skin*e.skinWeight+a.saturation*e.saturationWeight)/i.width/i.height,a},importance:function(t,i,a){var r=this.options;if(t.x>i||i>=t.x+t.width||t.y>a||a>=t.y+t.height)return r.outsideImportance;i=(i-t.x)/t.width,a=(a-t.y)/t.height;var h=2*n(.5-i),o=2*n(.5-a),d=Math.max(h-1+r.edgeRadius,0),c=Math.max(o-1+r.edgeRadius,0),g=(d*d+c*c)*r.edgeWeight,u=1.41-s(h*h+o*o);return r.ruleOfThirds&&(u+=1.2*Math.max(0,u+g+.5)*(e(h)+e(o))),u+g},skinColor:function(t,i,a){var e=s(t*t+i*i+a*a),r=this.options,h=t/e-r.skinColor[0],n=i/e-r.skinColor[1],o=a/e-r.skinColor[2],d=s(h*h+n*n+o*o);return 1-d},analyse:function(t){var a={},e=this.options,r=this.canvas(t.width,t.height),h=r.getContext("2d");h.drawImage(t,0,0);var n=h.getImageData(0,0,r.width,r.height),s=h.getImageData(0,0,r.width,r.height);this.edgeDetect(n,s),this.skinDetect(n,s),this.saturationDetect(n,s);var d=this.canvas(o(t.width/e.scoreDownSample),o(t.height/e.scoreDownSample)),c=d.getContext("2d");h.putImageData(s,0,0),c.drawImage(r,0,0,r.width,r.height,0,0,d.width,d.height);var g=c.getImageData(0,0,d.width,d.height),u=-(1/0),l=null,p=this.crops(t);for(i=0,i_len=p.length;i<i_len;i++){var f=p[i];f.score=this.score(g,f),f.score.total>u&&(l=f,u=f.score.total)}if(a.crops=p,a.topCrop=l,e.debug&&l){h.fillStyle="rgba(255, 0, 0, 0.1)",h.fillRect(l.x,l.y,l.width,l.height);for(var v=0;v<s.height;v++)for(var w=0;w<s.width;w++){var m=4*(v*s.width+w),k=this.importance(l,w,v);k>0&&(s.data[m+1]+=32*k),0>k&&(s.data[m]+=-64*k),s.data[m+3]=255}h.putImageData(s,0,0),h.strokeStyle="rgba(255, 0, 0, 0.8)",h.strokeRect(l.x,l.y,l.width,l.height),a.debugCanvas=r}return a}};var r=Math.min,h=Math.max,n=Math.abs,o=Math.ceil,s=Math.sqrt;"undefined"!=typeof define&&define.amd&&define(function(){return t}),"undefined"!=typeof exports?exports.SmartCrop=t:"undefined"!=typeof navigator&&(this.SmartCrop=t),"undefined"!=typeof module&&(module.exports=t)}();
//# sourceMappingURL=smartcrop.min.js.map